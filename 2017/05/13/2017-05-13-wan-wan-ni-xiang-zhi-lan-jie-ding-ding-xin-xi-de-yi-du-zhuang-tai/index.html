<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  
    
      
    

    
  

  
    
      
    

    
  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic|Monda:300,300italic,400,400italic,700,700italic|Monda:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="逆向,">










<meta name="description" content="流光容易把人抛，红了樱桃，绿了芭蕉  一个月前的某一天，百无聊赖的我在整理房间的时候，偶然翻开了一本积灰的“小黄书”，看到首页作者的赠语，眼前不禁浮现两年前，几经波折辗转到上海的我兴致勃勃勃勃地拜托小锅让他的直属老大狗神 (本书作者之一) ，给刚买的这本《iOS应用逆向工程》签名的场景，百味杂陈。说来惭愧，我一直都没有好好地看过这本书，等回过头来，不知不觉已经过去两年了。这篇文章致那个曾经那个能">
<meta name="keywords" content="逆向">
<meta property="og:type" content="article">
<meta property="og:title" content="玩玩逆向之拦截钉钉消息已读状态">
<meta property="og:url" content="https://triplecc.github.io/2017/05/13/2017-05-13-wan-wan-ni-xiang-zhi-lan-jie-ding-ding-xin-xi-de-yi-du-zhuang-tai/index.html">
<meta property="og:site_name" content="tripleCC&#39;s Blog">
<meta property="og:description" content="流光容易把人抛，红了樱桃，绿了芭蕉  一个月前的某一天，百无聊赖的我在整理房间的时候，偶然翻开了一本积灰的“小黄书”，看到首页作者的赠语，眼前不禁浮现两年前，几经波折辗转到上海的我兴致勃勃勃勃地拜托小锅让他的直属老大狗神 (本书作者之一) ，给刚买的这本《iOS应用逆向工程》签名的场景，百味杂陈。说来惭愧，我一直都没有好好地看过这本书，等回过头来，不知不觉已经过去两年了。这篇文章致那个曾经那个能">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://triplecc.github.io/images/Snip20170513_1.png">
<meta property="og:image" content="https://triplecc.github.io/images/Snip20170513_4.png">
<meta property="og:updated_time" content="2021-05-28T00:50:58.929Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="玩玩逆向之拦截钉钉消息已读状态">
<meta name="twitter:description" content="流光容易把人抛，红了樱桃，绿了芭蕉  一个月前的某一天，百无聊赖的我在整理房间的时候，偶然翻开了一本积灰的“小黄书”，看到首页作者的赠语，眼前不禁浮现两年前，几经波折辗转到上海的我兴致勃勃勃勃地拜托小锅让他的直属老大狗神 (本书作者之一) ，给刚买的这本《iOS应用逆向工程》签名的场景，百味杂陈。说来惭愧，我一直都没有好好地看过这本书，等回过头来，不知不觉已经过去两年了。这篇文章致那个曾经那个能">
<meta name="twitter:image" content="https://triplecc.github.io/images/Snip20170513_1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://triplecc.github.io/2017/05/13/2017-05-13-wan-wan-ni-xiang-zhi-lan-jie-ding-ding-xin-xi-de-yi-du-zhuang-tai/">





  <title>玩玩逆向之拦截钉钉消息已读状态 | tripleCC's Blog</title>
  








  <script type="text/javascript">
  // https://stackoverflow.com/questions/4723213/detect-http-or-https-then-force-https-in-javascript
    var host = "triplecc.github.io"
    console.log(window.location.host, window.location.protocol)
    if ((host == window.location.host) && (window.location.protocol != "https:")) {
      console.log('切到 https 站点...')
      window.location.protocol = "https:"
    }
    console.log('加载完毕.')
  </script>
</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">tripleCC's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://triplecc.github.io/2017/05/13/2017-05-13-wan-wan-ni-xiang-zhi-lan-jie-ding-ding-xin-xi-de-yi-du-zhuang-tai/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tripleCC">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tripleCC's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">玩玩逆向之拦截钉钉消息已读状态</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-13T08:54:37+00:00">
                2017-05-13
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/逆向/" itemprop="url" rel="index">
                    <span itemprop="name">逆向</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/05/13/2017-05-13-wan-wan-ni-xiang-zhi-lan-jie-ding-ding-xin-xi-de-yi-du-zhuang-tai/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2017/05/13/2017-05-13-wan-wan-ni-xiang-zhi-lan-jie-ding-ding-xin-xi-de-yi-du-zhuang-tai/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>流光容易把人抛，红了樱桃，绿了芭蕉</p>
</blockquote>
<p>一个月前的某一天，百无聊赖的我在整理房间的时候，偶然翻开了一本积灰的“小黄书”，看到首页作者的赠语，眼前不禁浮现两年前，几经波折辗转到上海的我兴致勃勃勃勃地拜托<a href="http://www.swiftyper.com/about/" target="_blank" rel="noopener">小锅</a>让他的直属老大狗神 (本书作者之一) ，给刚买的这本《iOS应用逆向工程》签名的场景，百味杂陈。说来惭愧，我一直都没有好好地看过这本书，等回过头来，不知不觉已经过去两年了。这篇文章致那个曾经那个能够静心看书的少年。</p>
<a id="more"></a>
<h2 id="灵感"><a href="#灵感" class="headerlink" title="灵感"></a>灵感</h2><p>钉钉是一款针对企业日常工作交流的 App ，因为是针对企业协作，所以不同于一般的 IM 软件，比如微信，钉钉增加了对消息读取状态的监控。简单来说就是同事发送一条消息后，如果我打开 App ，进入聊天界面查看了这条消息，那么该同事就会在这条消息旁边看到“已读”字样，如下图：</p>
<p><img src="/images/Snip20170513_1.png" alt=""><br><img src="/images/Snip20170513_4.png" alt=""></p>
<p>这个已读功能在工作的时候还是挺有作用的，能够知道同事是否已经知晓的相关事务。不过总会存在某些时候，我们不希望让对方知道消息已经被读取了。这就需要对 App 进行一些处理了。</p>
<h2 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h2><p>因为逆向基本工具在《iOS应用逆向工程》中罗列地非常清楚，所以对于一些基本环境的配置，这里就略过了，只简单介绍下这次逆向需要的工具。</p>
<table>
<thead>
<tr>
<th>工具</th>
<th style="text-align:center">本次逆向作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>dumpdecrypted <br> Clutch</td>
<td style="text-align:center">对 App 进行砸壳，使之可进行反汇编及 dump</td>
</tr>
<tr>
<td>class-dump</td>
<td style="text-align:center">获取 App 的 class 信息 （ Xcode 打开方便查看）</td>
</tr>
<tr>
<td>Hopper Disassembler</td>
<td style="text-align:center">反汇编器，查看 App 的汇编代码</td>
</tr>
<tr>
<td>usbmuxd</td>
<td style="text-align:center"><a href="http://localhost:4000/blog/2017-04-09-shi-yong-usbmuxdlian-jie-iphone/" target="_blank" rel="noopener">映射使用 USB 连接的逆向设备端口到本地</a></td>
</tr>
<tr>
<td>OpenSSH</td>
<td style="text-align:center">让越狱设备上具备 ssh 服务</td>
</tr>
<tr>
<td>cycript</td>
<td style="text-align:center">在目标 App 进程中测试函数，也可用来定位感兴趣对象</td>
</tr>
<tr>
<td>debugserver</td>
<td style="text-align:center">调试服务器，可让 lldb 连接 iOS 进行远程调试</td>
</tr>
<tr>
<td>lldb <br> chisel</td>
<td style="text-align:center">lldb 调试器，不多说 <br> FB 出品的 lldb 调试插件，不仅在 Xcode 正向开发中很有用，逆向也酸爽至极</td>
</tr>
<tr>
<td>theos</td>
<td style="text-align:center">编写Tweak，可对逆向代码进行编译打包，并以 dylib 的形式安装到越狱设备中</td>
</tr>
</tbody>
</table>
<p>接下来记录下整个逆向工作流程。</p>
<h3 id="对-App-进行砸壳"><a href="#对-App-进行砸壳" class="headerlink" title="对 App 进行砸壳"></a>对 App 进行砸壳</h3><p>本次砸壳采用的工具是书中演示的 dumpdecrypted。</p>
<p>1、首先通过 ssh 连接到 iOS 设备</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">➜  dumpdecrypted git:(master) ✗ iproxy <span class="number">2223</span> <span class="number">22</span> &amp;</span><br><span class="line">➜  dumpdecrypted git:(master) ✗ ssh root@localhost -p <span class="number">2223</span></span><br></pre></td></tr></table></figure>
<p>2、使用 ps 和 grep 找出目标 App 可执行文件路径</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">iPhone:~ root<span class="meta"># ps -A | grep Application</span></span><br><span class="line"> <span class="number">1774</span> ??         <span class="number">1</span>:<span class="number">06.02</span> /Applications/InCallService.app/InCallService</span><br><span class="line"> <span class="number">4147</span> ??         <span class="number">1</span>:<span class="number">04.34</span> /var/containers/Bundle/Application/<span class="number">60</span>B29D5D<span class="number">-2360</span><span class="number">-4</span>C01-A49F<span class="number">-8</span>CA87C752EFE/DingTalk.app/DingTalk</span><br><span class="line"> <span class="number">4217</span> ??         <span class="number">0</span>:<span class="number">04.58</span> /Applications/Weather.app/PlugIns/WeatherAppTodayWidget.appex/WeatherAppTodayWidget</span><br><span class="line"> <span class="number">4220</span> ??         <span class="number">0</span>:<span class="number">02.39</span> /Applications/Maps.app/PlugIns/MapsWidget.appex/MapsWidget</span><br><span class="line"> <span class="number">4223</span> ??         <span class="number">0</span>:<span class="number">02.50</span> /private/var/containers/Bundle/Application/D4438959<span class="number">-3</span>D50<span class="number">-4</span>D5B-AFD5<span class="number">-635</span>BAE010F57/Pin.app/PlugIns/PinToday.appex/PinToday</span><br><span class="line"> <span class="number">4233</span> ??         <span class="number">0</span>:<span class="number">00.78</span> /private/var/containers/Bundle/Application/D4438959<span class="number">-3</span>D50<span class="number">-4</span>D5B-AFD5<span class="number">-635</span>BAE010F57/Pin.app/PlugIns/PinCleaner.appex/PinCleaner</span><br><span class="line"> <span class="number">4316</span> ??         <span class="number">0</span>:<span class="number">01.70</span> /Applications/MobileCal.app/PlugIns/CalendarWidget.appex/CalendarWidget</span><br><span class="line"> <span class="number">4319</span> ??         <span class="number">0</span>:<span class="number">01.99</span> /private/var/containers/Bundle/Application/<span class="number">61</span>C2E8D7<span class="number">-4</span>C2D<span class="number">-4323</span>-A357<span class="number">-7</span>FAB9AE33339/WizIPhone.app/PlugIns/WizNoteIPhoneToday.appex/WizNoteIPhoneToday</span><br><span class="line"> <span class="number">4322</span> ??         <span class="number">0</span>:<span class="number">01.28</span> /private/var/containers/Bundle/Application/F576BB21-A1F2<span class="number">-42</span>B8-A18F-D2AFCE9E78D8/AlipayWallet.app/PlugIns/APTodayWidget.appex/APTodayWidget</span><br><span class="line"> <span class="number">4418</span> ??         <span class="number">0</span>:<span class="number">28.22</span> /var/containers/Bundle/Application/<span class="number">3654E1</span>CC-CEE2<span class="number">-44</span>DB-A7E6-B4268A59F3C6/WeChat.app/WeChat</span><br><span class="line"> <span class="number">4429</span> ??         <span class="number">0</span>:<span class="number">08.09</span> /var/containers/Bundle/Application/F576BB21-A1F2<span class="number">-42</span>B8-A18F-D2AFCE9E78D8/AlipayWallet.app/AlipayWallet</span><br></pre></td></tr></table></figure>
<p>这里由于先前并不知道钉钉的可执行文件名，所以直接用 Application 关键字对所有进程进行过滤，知道后就可以直接用 DingTalk 进行过滤了 。包含钉钉可执行文件路径的一行为</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4147</span> ??         <span class="number">1</span>:<span class="number">04.34</span> /var/containers/Bundle/Application/<span class="number">60</span>B29D5D<span class="number">-2360</span><span class="number">-4</span>C01-A49F<span class="number">-8</span>CA87C752EFE/DingTalk.app/DingTalk</span><br></pre></td></tr></table></figure>
<p>3、使用 cycript 获取钉钉 Document 文件夹路径</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iPhone:~ root<span class="meta"># cycript -p  4147</span></span><br><span class="line">cy<span class="meta"># NSSearchPathForDirectoriesInDomains(NSDocumentDirectory, NSUserDomainMask, YES)[0]</span></span><br><span class="line"><span class="string">@"/var/mobile/Containers/Data/Application/93BEEF52-2DE2-4687-9986-E50CBD961BB2/Documents"</span></span><br></pre></td></tr></table></figure>
<p>使用 <code>cycript -p + pid / 可执行文件名</code> 就可以在目标 App 的进程下运行方法了。在这一步顺便把钉钉的 Bundle ID 给打印出来，后面 thoes 会用到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy# [[NSBundle mainBundle] bundleIdentifier]</span><br><span class="line">@&quot;com.laiwang.DingTalk&quot;</span><br></pre></td></tr></table></figure>
<p>4、将 dumpdecrypted.dylib 拷贝到 Documents 目录下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  dumpdecrypted git:(master) ✗ scp -P <span class="number">2223</span>  dumpdecrypted.dylib root@localhost:/var/mobile/Containers/Data/Application/<span class="number">93</span>BEEF52<span class="number">-2</span>DE2<span class="number">-4687</span><span class="number">-9986</span>-E50CBD961BB2/Documents</span><br></pre></td></tr></table></figure>
<p>5、开始砸壳</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">iPhone:~ root<span class="meta"># cd /var/mobile/Containers/Data/Application/93BEEF52-2DE2-4687-9986-E50CBD961BB2/Documents</span></span><br><span class="line">iPhone:/var/mobile/Containers/Data/Application/<span class="number">93</span>BEEF52<span class="number">-2</span>DE2<span class="number">-4687</span><span class="number">-9986</span>-E50CBD961BB2/Documents root<span class="meta"># DYLD_INSERT_LIBRARIES=dumpdecrypted.dylib /var/containers/Bundle/Application/60B29D5D-2360-4C01-A49F-8CA87C752EFE/DingTalk.app/DingTalk</span></span><br></pre></td></tr></table></figure>
<p>砸壳后，当前目录下会有一个 DingTalk.decrypted 文件，将这个砸壳之后的文件拷贝到电脑上进行反汇编及 class-dump 。</p>
<h3 id="进行-class-dump-及反汇编"><a href="#进行-class-dump-及反汇编" class="headerlink" title="进行 class-dump 及反汇编"></a>进行 class-dump 及反汇编</h3><p>1、进入 DingTalk.decrypted 所在目录，执行 class-dump</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  DingTalk <span class="keyword">class</span>-dump -S -s  -H -o DTClassDump  DingTalk.decrypted</span><br></pre></td></tr></table></figure>
<p>可以看到目录下多了 DTClassDump 文件夹，打开这个文件夹，全选里面的头文件，用 Xcode 打开。</p>
<p>2、打开 Hopper Disassembler 并将 DingTalk.decrypted 拖进面板中，Hopper Disassembler 会自动识别 DingTalk.decrypted 对应的 CPU 体系结构。确定进行后续操作后，Hopper Disassembler就开始进行反汇编了。反汇编的时间可能会<strong>有点长</strong>，所以最好把反汇编之后的 hop 文件保存一下，这样下次就可以直接打开了（不过即使这样打开也要挺久的，8G 内存也有点吃紧，老是转菊花 <em>(°:з」∠)</em> ）。</p>
<h2 id="逆向过程"><a href="#逆向过程" class="headerlink" title="逆向过程"></a>逆向过程</h2><h3 id="定位消息控制器"><a href="#定位消息控制器" class="headerlink" title="定位消息控制器"></a>定位消息控制器</h3><p>如果是从视图切入的话，使用 FLEXLoader （ Cydia 商店可下载 ） 是个不错的选择，它可以很方便地调试当前界面上的元素。当然，Revel 这种利器就不用多介绍了，用起来也是很舒畅。不过这里我使用了另外两种方式：</p>
<p>1、首先是使用 cycript。进入钉钉的聊天界面后，执行下面代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cy<span class="meta"># [[[[[UIApplication sharedApplication] keyWindow] rootViewController] viewControllers][0] topViewController]</span></span><br><span class="line"><span class="meta">#<span class="meta-string">"&lt;DTMessageOTOViewController: 0x104217c00&gt;"</span></span></span><br></pre></td></tr></table></figure>
<p>由于大体知道钉钉界面的层级关系，使用代码获取当前界面的信息还是比较容易的。</p>
<p>2、第二种是使用 lldb 来打印控制器层级列表。<br><br>这里涉及到 lldb 的远程调试，首先映射越狱设备 1234 端口到 Mac 本地 1234 端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">➜  DTClassDump iproxy 1234 1234 &amp;</span><br></pre></td></tr></table></figure>
<p>然后在越狱设备上开启 debugserver：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">iPhone:~ root<span class="meta"># debugserver *:1234 -a DingTalk</span></span><br><span class="line">debugserver-@(<span class="meta">#)PROGRAM:debugserver  PROJECT:debugserver-360.0.26.1</span></span><br><span class="line"> <span class="keyword">for</span> arm64.</span><br><span class="line">Listening to port <span class="number">1234</span> <span class="keyword">for</span> a connection from *...</span><br></pre></td></tr></table></figure>
<p>接着执行一下命令，让 lldb 连接上 debugserver：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">➜  DTClassDump lldb</span><br><span class="line">(lldb) process connect connect:<span class="comment">//localhost:1234</span></span><br><span class="line"></span><br><span class="line">* thread <span class="meta">#1: tid = 0xb7f8b, 0x000000018e18816c libsystem_kernel.dylib`mach_msg_trap + 8, name ='505', queue = 'com.apple.main-thread', stop reason = signal SIGSTOP</span></span><br><span class="line">    frame <span class="meta">#0: 0x000000018e18816c libsystem_kernel.dylib`mach_msg_trap + 8</span></span><br><span class="line">libsystem_kernel.dylib`mach_msg_trap:</span><br><span class="line">-&gt;  <span class="number">0x18e18816c</span> &lt;+<span class="number">8</span>&gt;: ret</span><br><span class="line"></span><br><span class="line">libsystem_kernel.dylib`mach_msg_overwrite_trap:</span><br><span class="line">    <span class="number">0x18e188170</span> &lt;+<span class="number">0</span>&gt;: movn   x16, <span class="meta">#0x1f</span></span><br><span class="line">    <span class="number">0x18e188174</span> &lt;+<span class="number">4</span>&gt;: svc    <span class="meta">#0x80</span></span><br><span class="line">    <span class="number">0x18e188178</span> &lt;+<span class="number">8</span>&gt;: ret</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>
<p>最后我们就可以进行调试了。<strong><em>注：下面的 lldb 操作会用到 <a href="https://github.com/facebook/chisel" target="_blank" rel="noopener">chisel</a> 插件的一些命令</em></strong>。<br></p>
<p>首先，导入 chisel 部分命令需要的 UIKit 框架：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">(lldb) process interrupt</span><br><span class="line">Process <span class="number">4600</span> stopped</span><br><span class="line">* thread <span class="meta">#1: tid = 0xb7f8b, 0x000000018e18816c libsystem_kernel.dylib`mach_msg_trap + 8, name = '505', stop reason = signal SIGSTOP</span></span><br><span class="line">    frame <span class="meta">#0: 0x000000018e18816c libsystem_kernel.dylib`mach_msg_trap + 8</span></span><br><span class="line">libsystem_kernel.dylib`mach_msg_trap:</span><br><span class="line">-&gt;  <span class="number">0x18e18816c</span> &lt;+<span class="number">8</span>&gt;: ret</span><br><span class="line"></span><br><span class="line">libsystem_kernel.dylib`mach_msg_overwrite_trap:</span><br><span class="line">    <span class="number">0x18e188170</span> &lt;+<span class="number">0</span>&gt;: movn   x16, <span class="meta">#0x1f</span></span><br><span class="line">    <span class="number">0x18e188174</span> &lt;+<span class="number">4</span>&gt;: svc    <span class="meta">#0x80</span></span><br><span class="line">    <span class="number">0x18e188178</span> &lt;+<span class="number">8</span>&gt;: ret</span><br><span class="line">(lldb) expr <span class="keyword">@import</span> <span class="built_in">UIKit</span></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>
<p>接着还是进入到聊天界面：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(lldb) pvc</span><br><span class="line">&lt;DTTabBarController <span class="number">0x13bd4cb00</span>&gt;, state: appeared, view: &lt;<span class="built_in">UILayoutContainerView</span> <span class="number">0x13be75310</span>&gt;</span><br><span class="line">   | &lt;DTNavigationController <span class="number">0x13c8dda00</span>&gt;, state: appeared, view: &lt;<span class="built_in">UILayoutContainerView</span> <span class="number">0x13be7dee0</span>&gt;</span><br><span class="line">   |    | &lt;DTConversationListController <span class="number">0x13c02ee00</span>&gt;, state: disappeared, view: &lt;<span class="built_in">UIView</span> <span class="number">0x13bd7ab40</span>&gt; not <span class="keyword">in</span> the window</span><br><span class="line">   |    | &lt;DTMessageOTOViewController <span class="number">0x13c830400</span>&gt;, state: appeared, view: &lt;<span class="built_in">UIView</span> <span class="number">0x13d2291f0</span>&gt;</span><br><span class="line">   | &lt;DTNavigationController <span class="number">0x13c0e0c00</span>&gt;, state: disappeared, view: &lt;<span class="built_in">UILayoutContainerView</span> <span class="number">0x13bd66b30</span>&gt; not <span class="keyword">in</span> the window</span><br><span class="line">   |    | &lt;DTDingTableViewController <span class="number">0x13c0b7e00</span>&gt;, state: disappeared, view:  (view not loaded)</span><br><span class="line">   | &lt;DTNavigationController <span class="number">0x13c985200</span>&gt;, state: disappeared, view: &lt;<span class="built_in">UILayoutContainerView</span> <span class="number">0x13be9d110</span>&gt; not <span class="keyword">in</span> the window</span><br><span class="line">   |    | &lt;DTWorkViewController <span class="number">0x13be9ba00</span>&gt;, state: disappeared, view:  (view not loaded)</span><br><span class="line">   | &lt;DTNavigationController <span class="number">0x13c0f8c00</span>&gt;, state: disappeared, view: &lt;<span class="built_in">UILayoutContainerView</span> <span class="number">0x13bd6dae0</span>&gt; not <span class="keyword">in</span> the window</span><br><span class="line">   |    | &lt;DTContactViewController <span class="number">0x13bd6bf80</span>&gt;, state: disappeared, view: &lt;<span class="built_in">UIView</span> <span class="number">0x13d120ee0</span>&gt; not <span class="keyword">in</span> the window</span><br><span class="line">   | &lt;DTNavigationController <span class="number">0x13c104c00</span>&gt;, state: disappeared, view: &lt;<span class="built_in">UILayoutContainerView</span> <span class="number">0x13bd733c0</span>&gt; not <span class="keyword">in</span> the window</span><br><span class="line">   |    | &lt;DTSettingViewController <span class="number">0x13bd71cc0</span>&gt;, state: disappeared, view:  (view not loaded)</span><br><span class="line"></span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>
<p>可以看到 chisel 不仅把目标控制器 <code>&lt;DTMessageOTOViewController 0x13c830400&gt;</code> 打印出来了，还顺带把当前整个控制器层级都给拉了出来。</p>
<h3 id="定位接受消息方法"><a href="#定位接受消息方法" class="headerlink" title="定位接受消息方法"></a>定位接受消息方法</h3><p>将消息标为已读的前提是钉钉接收到了该消息，进而可以推测是不是在接收消息后，钉钉发送了已读标志，所以我们先找出接收消息的回调方法。在不知道确切方法的情况下，浏览下下 class-dump 出来的 <code>DTMessageOTOViewController</code> 类信息多少会有收获的：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     Generated by class-dump 3.5 (64 bit).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//     class-dump is Copyright (C) 1997-1998, 2000-2001, 2004-2013 by Steve Nygard.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"DTMessageBaseViewController.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#import <span class="meta-string">"DTCEmailTransitionViewDelegate.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@class</span> <span class="title">DTBadgeView</span>, <span class="title">DTCEmailTransitionView</span>, <span class="title">DTCMailMode</span>, <span class="title">DTTypingManager</span>, <span class="title">NSString</span>, <span class="title">UIButton</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">DTMessageOTOViewController</span> : <span class="title">DTMessageBaseViewController</span> &lt;<span class="title">DTCEmailTransitionViewDelegate</span>&gt;</span></span><br><span class="line">...</span><br><span class="line">- (<span class="keyword">void</span>)handleNotificationMessage:(<span class="keyword">id</span>)arg1;</span><br><span class="line">- (<span class="keyword">void</span>)receivedMessageListNotification:(<span class="keyword">id</span>)arg1;</span><br><span class="line">- (<span class="keyword">void</span>)receivedMessageNotification:(<span class="keyword">id</span>)arg1;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
<p>结合方法命名，我只关注了上方的三个方法。接下来可以逐个测试上面的方法，找出处理消息的回调了。</p>
<p>在 Hopper Disassembler 中， <code>DTMessageOTOViewController</code> 的 <code>handleNotificationMessage:</code> 的方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">        ; ================ B E G I N N I N G   O F   P R O C E D U R E ================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                     -[DTMessageOTOViewController handleNotificationMessage:]:</span><br><span class="line">0000000100466820         stp        x26, x25, [sp, #-0x50]!                     ; Objective C Implementation defined at 0x1030ddb30 (instance method), DATA XREF=0x1030ddb30</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>如上所示，我们可以知道 <code>handleNotificationMessage:</code> 的相对地址是 0x0000000100466820，打开 lldb 进行调试：</p>
<p>1、获取 DingTalk 的 ASLR (地址空间配置随机加载) 偏移量</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) image list -o -f | grep DingTalk</span><br><span class="line">[  <span class="number">0</span>] <span class="number">0x0000000000004000</span> /var/containers/Bundle/Application/<span class="number">60</span>B29D5D<span class="number">-2360</span><span class="number">-4</span>C01-A49F<span class="number">-8</span>CA87C752EFE/DingTalk.app/DingTalk(<span class="number">0x0000000100004000</span>)</span><br></pre></td></tr></table></figure>
<p>2、设置 <code>handleNotificationMessage:</code> 断点信息。不过在设置前，得先明确下参数和返回值的传递规则。<br><br></p>
<p>参数传递规则：前四个参数存放在 R0 - R3 中，剩余的通过栈进行传递。<br><br>返回值传递规则：通过 R0 传递给调用者。</p>
<p>众所周知，Objective-C 的方法调用是通过 <code>objc_msgSend</code> 函数实现的，<code>objc_msgSend</code> 定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id objc_msgSend(id self, SEL	_cmd,...);</span><br></pre></td></tr></table></figure>
<p>所以我们可以通过 R0 / arg0 获取消息接受者， R1 / arg1 获取发送的方法名。综上，可添加断点信息如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(lldb) br set -a 0x0000000000004000+0x0000000100466820</span><br><span class="line">Breakpoint 1: where = DingTalk`_mh_execute_header + 4588940, address = 0x000000010046a820</span><br><span class="line">(lldb) br command add 1</span><br><span class="line">Enter your debugger command(s).  Type &apos;DONE&apos; to end.</span><br><span class="line">&gt; po $x0</span><br><span class="line">&gt; p (char *)$x1</span><br><span class="line">&gt; po $x2</span><br><span class="line">&gt; DONE</span><br></pre></td></tr></table></figure>
<p>3、向越狱设备的钉钉发送消息，触发断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">(lldb)  po $x0</span><br><span class="line">&lt;DTMessageOTOViewController: 0x11e2edc00&gt;</span><br><span class="line">(lldb)  p (char *)$x1</span><br><span class="line">(char *) $2 = 0x000000010296e9ba &quot;handleNotificationMessage:&quot;</span><br><span class="line">(lldb)  po $x2</span><br><span class="line">&lt;__NSArrayM 0x170853e00&gt;(</span><br><span class="line">senderId = 72938616</span><br><span class="line">localMid = (null)</span><br><span class="line">mId = 21530513660</span><br><span class="line">attachmentsType = 1</span><br><span class="line">sendStatus = 0</span><br><span class="line">type = 1</span><br><span class="line">isDecrypt = 0</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">Process 4918 stopped</span><br><span class="line">* thread #1: tid = 0xd51a3, 0x000000010046a820 DingTalk`_mh_execute_header + 4614176, name = &apos;709&apos;, queue = &apos;com.apple.main-thread&apos;, stop reason = breakpoint 1.1</span><br><span class="line">    frame #0: 0x000000010046a820 DingTalk`_mh_execute_header + 4614176</span><br><span class="line">DingTalk`_mh_execute_header:</span><br><span class="line">-&gt;  0x10046a820 &lt;+4614176&gt;: stp    x26, x25, [sp, #-80]!</span><br><span class="line">    0x10046a824 &lt;+4614180&gt;: stp    x24, x23, [sp, #16]</span><br><span class="line">    0x10046a828 &lt;+4614184&gt;: stp    x22, x21, [sp, #32]</span><br><span class="line">    0x10046a82c &lt;+4614188&gt;: stp    x20, x19, [sp, #48]</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure>
<p>可以看到接收消息后，的确进入了 <code>handleNotificationMessage:</code> 方法。并且通过 LR （保存函数返回地址寄存器），我们可以定位到是 <code>receivedMessageListNotification:</code> 方法调用了 <code>handleNotificationMessage:</code> ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(lldb) p/x $lr - 0x0000000000004000</span><br><span class="line">(unsigned long) $6 = 0x00000001004667d0</span><br></pre></td></tr></table></figure>
<p>Hopper Disassembler ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">        ; ================ B E G I N N I N G   O F   P R O C E D U R E ================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                     -[DTMessageOTOViewController receivedMessageListNotification:]:</span><br><span class="line">...</span><br><span class="line">00000001004667c0         ldr        x1, [x8, #0xc58]                            ; &quot;handleNotificationMessage:&quot;,@selector(handleNotificationMessage:)</span><br><span class="line">00000001004667c4         mov        x0, x20</span><br><span class="line">00000001004667c8         mov        x2, x22</span><br><span class="line">00000001004667cc         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001004667d0         mov        x0, x22</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>进而，我们可以知道新消息到来时，钉钉会广播 <code>DTPushReceivedMessageListNotification</code> 通知：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NSConcreteNotification 0x170854430 &#123;name = DTPushReceivedMessageListNotification; object = &lt;DTReconnectedHandler: 0x170015990&gt;; userInfo = &#123;</span><br><span class="line">    DTPushReceivedInfoKey =     (</span><br><span class="line">        &quot;senderId = 72938616\nlocalMid = (null)\nmId = 21526791314\nattachmentsType = 1\nsendStatus = 0\ntype = 1\nisDecrypt = 0\n&quot;</span><br><span class="line">    );</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>4、从反汇编代码中寻找线索</p>
<p>虽然定位到了 <code>handleNotificationMessage:</code> 方法，但最终发现这个方法并没有给我想要的信息，不过它的调用者 <code>receivedMessageListNotification:</code> 方法却提供了一些有用的线索：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">        ; ================ B E G I N N I N G   O F   P R O C E D U R E ================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                     -[DTMessageOTOViewController receivedMessageListNotification:]:</span><br><span class="line">...</span><br><span class="line">0000000100466754         cbz        x20, loc_1004667e0</span><br><span class="line"></span><br><span class="line">0000000100466758         str        x20, [sp, #0x8]</span><br><span class="line">000000010046675c         adrp       x8, #0x1035bf000</span><br><span class="line">0000000100466760         ldr        x8, [x8, #0x5a0]                            ; 0x1035bf5a0,__objc_class_DTMessageOTOViewController_class</span><br><span class="line">0000000100466764         str        x8, [sp, #0x10]</span><br><span class="line">0000000100466768         adrp       x8, #0x103568000                            ; @selector(cname)</span><br><span class="line">000000010046676c         ldr        x1, [x8, #0x378]                            ; &quot;receivedMessageListNotification:&quot;,@selector(receivedMessageListNotification:)</span><br><span class="line">0000000100466770         add        x0, sp, #0x8</span><br><span class="line">0000000100466774         mov        x2, x19</span><br><span class="line">0000000100466778         bl         imp___stubs__objc_msgSendSuper2</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>DTMessageOTOViewController</code> 对象的 <code>receivedMessageListNotification:</code> 方法有效信息并不多，但它在调用 <code>handleNotificationMessage:</code> 方法前，调用了父类的 <code>receivedMessageListNotification:</code> 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"> ; ================ B E G I N N I N G   O F   P R O C E D U R E ================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                     -[DTMessageBaseViewController receivedMessageListNotification:]:</span><br><span class="line">...</span><br><span class="line">ldr        x24, [x8, #0xd58] ; &quot;dataSource&quot;,@selector(dataSource)</span><br><span class="line">mov        x0, x20</span><br><span class="line">mov        x1, x24</span><br><span class="line">bl         imp___stubs__objc_msgSend</span><br><span class="line">mov        x29, x29</span><br><span class="line">bl         imp___stubs__objc_retainAutoreleasedReturnValue</span><br><span class="line">mov        x25, x0</span><br><span class="line">adrp       x8, #0x103568000 ; @selector(cname)</span><br><span class="line">ldr        x1, [x8, #0xc00] ; &quot;noRepeatSortMessagesWithNotificationMessageList:&quot;,@selector(noRepeatSortMessagesWithNotificationMessageList:)</span><br><span class="line">mov        x2, x22</span><br><span class="line">bl         imp___stubs__objc_msgSend</span><br><span class="line">...</span><br><span class="line">adrp       x8, #0x103568000 ; @selector(cname)</span><br><span class="line">ldr        x1, [x8, #0xc10] ; &quot;dealMessageListWithNoRepeatSortArray:finishBlock:&quot;,@selector(dealMessageListWithNoRepeatSortArray:finishBlock:)</span><br><span class="line">add        x3, sp, #0x8</span><br><span class="line">mov        x0, x26</span><br><span class="line">mov        x2, x25</span><br><span class="line">bl         imp___stubs__objc_msgSend</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>通过反汇编代码可以看出，这个 <code>dataSource</code> 先后调用了 <code>noRepeatSortMessagesWithNotificationMessageList:</code> 和 <code>dealMessageListWithNoRepeatSortArray:finishBlock:</code> 方法，会不会在后一个方法发送已读标志呢？在确认之前，我们先看下 <code>dataSource</code> 这个方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property(retain, nonatomic) DTMessageControllerDataSource *dataSource; // @synthesize dataSource=_dataSource;</span><br></pre></td></tr></table></figure>
<p>数据源被剥离到一个独立的对象了，这种做法在界面比较复杂的情况中很常见，能有效减少控制器中的代码。那么 <code>DTMessageControllerDataSource</code> 里面会有什么有用的信息么？</p>
<h3 id="定位发送已读标志方法"><a href="#定位发送已读标志方法" class="headerlink" title="定位发送已读标志方法"></a>定位发送已读标志方法</h3><p>上文说到了 DTMessageControllerDataSource 这个类，这个类定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@interface DTMessageControllerDataSource : NSObject &lt;UIViewControllerPreviewingDelegate, DTMessageCollectionViewCellDataSource, EGORefreshTableHeaderDelegate, DTMessageConllectionViewDataSource, DTMessageControllerDataSourceProtocal&gt;</span><br><span class="line">...</span><br><span class="line">- (_Bool)needSendReadStatusInCellForRowWithMessage:(id)arg1;</span><br><span class="line">...</span><br><span class="line">- (void)sendMessageReadStatusWithMessage:(id)arg1;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>结合命名方法，我注意到了上面两个方法。和上文步骤一样，我先使用 lldb 调试了 <code>needSendReadStatusInCellForRowWithMessage:</code> 方法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">        ; ================ B E G I N N I N G   O F   P R O C E D U R E ================</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                     -[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]:</span><br><span class="line">...</span><br><span class="line">00000001001a070c         mov        x0, x20</span><br><span class="line">00000001001a0710         ldp        x29, x30, [sp, #0x20]</span><br><span class="line">00000001001a0714         ldp        x20, x19, [sp, #0x10]</span><br><span class="line">00000001001a0718         ldp        x22, x21, [sp]!, #0x30</span><br><span class="line">00000001001a071c         ret</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>不过这次因为要改变返回值，我直接把断点打在了 <code>0x00000001001a070c</code> 这个地方：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Process 4961 stopped</span><br><span class="line">* thread #1: tid = 0xdc358, 0x00000001001d070c DingTalk`_mh_execute_header + 1705740, name = &apos;137&apos;, queue = &apos;com.apple.main-thread&apos;, stop reason = instruction step over</span><br><span class="line">    frame #0: 0x00000001001d070c DingTalk`_mh_execute_header + 1705740</span><br><span class="line">DingTalk`_mh_execute_header:</span><br><span class="line">-&gt;  0x1001d070c &lt;+1705740&gt;: mov    x0, x20</span><br><span class="line">    0x1001d0710 &lt;+1705744&gt;: ldp    x29, x30, [sp, #32]</span><br><span class="line">    0x1001d0714 &lt;+1705748&gt;: ldp    x20, x19, [sp, #16]</span><br><span class="line">    0x1001d0718 &lt;+1705752&gt;: ldp    x22, x21, [sp], #48</span><br><span class="line">(lldb) ni</span><br><span class="line">Process 4961 stopped</span><br><span class="line">* thread #1: tid = 0xdc358, 0x00000001001d0710 DingTalk`_mh_execute_header + 1705744, name = &apos;137&apos;, queue = &apos;com.apple.main-thread&apos;, stop reason = instruction step over</span><br><span class="line">    frame #0: 0x00000001001d0710 DingTalk`_mh_execute_header + 1705744</span><br><span class="line">DingTalk`_mh_execute_header:</span><br><span class="line">-&gt;  0x1001d0710 &lt;+1705744&gt;: ldp    x29, x30, [sp, #32]</span><br><span class="line">    0x1001d0714 &lt;+1705748&gt;: ldp    x20, x19, [sp, #16]</span><br><span class="line">    0x1001d0718 &lt;+1705752&gt;: ldp    x22, x21, [sp], #48</span><br><span class="line">    0x1001d071c &lt;+1705756&gt;: ret</span><br><span class="line">(lldb) p $x0</span><br><span class="line">(unsigned long) $6 = 1</span><br><span class="line">(lldb) register write $x0 0</span><br><span class="line">(lldb) c</span><br></pre></td></tr></table></figure>
<p>改写 R0 (返回值) 为 0 并让进程继续运行后，消息发送方的已读标志果然没有出现，始终是处于未读状态，而接收方也看到了这条消息。那么 <code>needSendUnreadStatusWithMessage:</code> 方法是如何判断该返回YES或NO呢？除去了部分对结果不产生影响的分支后，其汇编代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">00000001001a05c8         stp        x22, x21, [sp, #-0x30]!                     ; Objective C Implementation defined at 0x103088d78 (instance method), DATA XREF=0x103088d78</span><br><span class="line">00000001001a05cc         stp        x20, x19, [sp, #0x10]</span><br><span class="line">00000001001a05d0         stp        x29, x30, [sp, #0x20]</span><br><span class="line">00000001001a05d4         add        x29, sp, #0x20</span><br><span class="line">00000001001a05d8         mov        x20, x0</span><br><span class="line">00000001001a05dc         mov        x0, x2</span><br><span class="line">00000001001a05e0         bl         imp___stubs__objc_retain</span><br><span class="line">00000001001a05e4         mov        x19, x0</span><br><span class="line">00000001001a05e8         adrp       x8, #0x10355d000                            ; @selector(filteredImageUsingContrastFilterOnImage:)</span><br><span class="line">00000001001a05ec         ldr        x1, [x8, #0x4b0]                            ; &quot;collectionView&quot;,@selector(collectionView)</span><br><span class="line">00000001001a05f0         mov        x0, x20</span><br><span class="line">00000001001a05f4         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a05f8         mov        x29, x29</span><br><span class="line">00000001001a05fc         bl         imp___stubs__objc_retainAutoreleasedReturnValue</span><br><span class="line">00000001001a0600         mov        x20, x0</span><br><span class="line">00000001001a0604         adrp       x8, #0x103559000</span><br><span class="line">00000001001a0608         ldr        x1, [x8, #0xd58]                            ; &quot;dataSource&quot;,@selector(dataSource)</span><br><span class="line">00000001001a060c         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a0610         mov        x29, x29</span><br><span class="line">00000001001a0614         bl         imp___stubs__objc_retainAutoreleasedReturnValue</span><br><span class="line">00000001001a0618         mov        x21, x0</span><br><span class="line">00000001001a061c         adrp       x8, #0x103563000                            ; @selector(updateConversationClientExtension:message:wkBizConversation:needSaveToDB:)</span><br><span class="line">00000001001a0620         ldr        x1, [x8, #0x660]                            ; &quot;needSendUnreadStatusWithMessage:&quot;,@selector(needSendUnreadStatusWithMessage:)</span><br><span class="line">00000001001a0624         mov        x2, x19</span><br><span class="line">00000001001a0628         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a062c         mov        x22, x0</span><br><span class="line">00000001001a0630         mov        x0, x21</span><br><span class="line">00000001001a0634         bl         imp___stubs__objc_release</span><br><span class="line">00000001001a0638         mov        x0, x20</span><br><span class="line">00000001001a063c         bl         imp___stubs__objc_release</span><br><span class="line">00000001001a0640         cbz        w22, loc_1001a0700</span><br><span class="line"></span><br><span class="line">00000001001a0644         adrp       x8, #0x10355b000                            ; @selector(DT_S13_normal)</span><br><span class="line">00000001001a0648         ldr        x20, [x8, #0x740]                           ; &quot;attachmentsType&quot;,@selector(attachmentsType)</span><br><span class="line">00000001001a064c         mov        x0, x19</span><br><span class="line">00000001001a0650         mov        x1, x20</span><br><span class="line">00000001001a0654         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a0658         cmp        x0, #0x67</span><br><span class="line">00000001001a065c         b.eq       loc_1001a0700</span><br><span class="line"></span><br><span class="line">00000001001a0660         mov        x0, x19</span><br><span class="line">00000001001a0664         mov        x1, x20</span><br><span class="line">00000001001a0668         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a066c         cmp        x0, #0xca</span><br><span class="line">00000001001a0670         b.eq       loc_1001a0700</span><br><span class="line"></span><br><span class="line">00000001001a0674         mov        x0, x19</span><br><span class="line">00000001001a0678         mov        x1, x20</span><br><span class="line">00000001001a067c         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a0680         cmp        x0, #0x4</span><br><span class="line">00000001001a0684         b.eq       loc_1001a0700</span><br><span class="line"></span><br><span class="line">00000001001a0688         mov        x0, x19</span><br><span class="line">00000001001a068c         mov        x1, x20</span><br><span class="line">00000001001a0690         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a0694         cmp        x0, #0x2</span><br><span class="line">00000001001a0698         b.eq       loc_1001a0700</span><br><span class="line"></span><br><span class="line">00000001001a069c         mov        x0, x19</span><br><span class="line">00000001001a06a0         mov        x1, x20</span><br><span class="line">00000001001a06a4         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a06a8         cmp        x0, #0x66</span><br><span class="line">00000001001a06ac         b.eq       loc_1001a0700</span><br><span class="line"></span><br><span class="line">00000001001a06b0         mov        x0, x19</span><br><span class="line">00000001001a06b4         mov        x1, x20</span><br><span class="line">00000001001a06b8         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a06bc         cmp        x0, #0x10</span><br><span class="line">00000001001a06c0         b.eq       loc_1001a0700</span><br><span class="line"></span><br><span class="line">00000001001a06c4         adrp       x8, #0x103563000                            ; @selector(updateConversationClientExtension:message:wkBizConversation:needSaveToDB:)</span><br><span class="line">00000001001a06c8         ldr        x1, [x8, #0x640]                            ; &quot;isMsgNeedShowFullWidth&quot;,@selector(isMsgNeedShowFullWidth)</span><br><span class="line">00000001001a06cc         mov        x0, x19</span><br><span class="line">00000001001a06d0         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a06d4         tbnz       w0, 0x0, loc_1001a0700</span><br><span class="line"></span><br><span class="line">00000001001a06d8         mov        x0, x19</span><br><span class="line">00000001001a06dc         mov        x1, x20</span><br><span class="line">00000001001a06e0         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a06e4         cmp        x0, #0x1f4</span><br><span class="line">00000001001a06e8         b.eq       loc_1001a0700</span><br><span class="line"></span><br><span class="line">00000001001a06ec         mov        x0, x19</span><br><span class="line">00000001001a06f0         mov        x1, x20</span><br><span class="line">00000001001a06f4         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a06f8         cmp        x0, #0x1f5</span><br><span class="line">00000001001a06fc         b.ne       loc_1001a0720</span><br><span class="line"></span><br><span class="line">                     loc_1001a0700:</span><br><span class="line">00000001001a0700         movz       w20, #0x0                                   ; CODE XREF=-[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]+120, -[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]+148, -[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]+168, -[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]+188, -[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]+208, -[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]+228, -[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]+248, -[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]+268, -[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]+288</span><br><span class="line"></span><br><span class="line">                     loc_1001a0704:</span><br><span class="line">00000001001a0704         mov        x0, x19                                     ; CODE XREF=-[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]+372</span><br><span class="line">00000001001a0708         bl         imp___stubs__objc_release</span><br><span class="line">00000001001a070c         mov        x0, x20</span><br><span class="line">00000001001a0710         ldp        x29, x30, [sp, #0x20]</span><br><span class="line">00000001001a0714         ldp        x20, x19, [sp, #0x10]</span><br><span class="line">00000001001a0718         ldp        x22, x21, [sp]!, #0x30</span><br><span class="line">00000001001a071c         ret</span><br><span class="line">                        ; endp</span><br><span class="line"></span><br><span class="line">                     loc_1001a0720:</span><br><span class="line">00000001001a0720         adrp       x8, #0x1035b5000                            ; CODE XREF=-[DTMessageControllerDataSource needSendReadStatusInCellForRowWithMessage:]+308</span><br><span class="line">00000001001a0724         ldr        x0, [x8, #0xdd0]                            ; objc_cls_ref_DTMessageServiceV2,__objc_class_DTMessageServiceV2_class</span><br><span class="line">00000001001a0728         adrp       x8, #0x103563000                            ; @selector(updateConversationClientExtension:message:wkBizConversation:needSaveToDB:)</span><br><span class="line">00000001001a072c         ldr        x1, [x8, #0x668]                            ; &quot;isEncryptSpaceType:&quot;,@selector(isEncryptSpaceType:)</span><br><span class="line">00000001001a0730         mov        x2, x19</span><br><span class="line">00000001001a0734         bl         imp___stubs__objc_msgSend</span><br><span class="line">00000001001a0738         eor        w20, w0, #0x1</span><br><span class="line">00000001001a073c         b          loc_1001a0704</span><br></pre></td></tr></table></figure>
<p>整理一下，可以用以下 Objective-C 代码进行表示：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)needSendUnreadStatusWithMessage:(DTBizMessage *)message &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!message) <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> message.creatorType == <span class="number">1</span> &amp;&amp; !message.isMine &amp;&amp; !message.readStatus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然知道了这块的代码逻辑，改变其行为也就不在话下了。</p>
<h3 id="编写安装-Tweak"><a href="#编写安装-Tweak" class="headerlink" title="编写安装 Tweak"></a>编写安装 Tweak</h3><p>1、创建一个 Tweak 工程模版：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜  DingTalk nic.pl</span><br><span class="line">NIC <span class="number">2.0</span> - New Instance Creator</span><br><span class="line">------------------------------</span><br><span class="line">  [<span class="number">1.</span>] iphone/activator_event</span><br><span class="line">  [<span class="number">2.</span>] iphone/activator_event</span><br><span class="line">  [<span class="number">3.</span>] iphone/activator_listener</span><br><span class="line">  ...</span><br><span class="line">  [<span class="number">26.</span>] iphone/tweak</span><br><span class="line">  ...</span><br><span class="line">Choose a Template (required): <span class="number">26</span></span><br><span class="line">Project Name (required): DingTalkRecallBarrier</span><br><span class="line">Package Name [com.yourcompany.dingtalkrecallbarrier]: com.tripleCC.dingtalkrecallbarrier</span><br><span class="line">Author/Maintainer Name [tripleCC]: tripleCC</span><br><span class="line">[iphone/tweak] MobileSubstrate Bundle filter [com.apple.springboard]: com.laiwang.DingTalk</span><br><span class="line">[iphone/tweak] List of applications to terminate upon installation (space-separated, <span class="string">'-'</span> <span class="keyword">for</span> none) [SpringBoard]: DingTalk</span><br><span class="line">Instantiating iphone/tweak <span class="keyword">in</span> dingtalkrecallbarrier/...</span><br><span class="line">Done.</span><br></pre></td></tr></table></figure>
<p>2、编写 Tweak.m 和 Makefile 文件了：</p>
<p>Tweak.m：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%hook DTMessageControllerDataSource</span><br><span class="line">- (BOOL)needSendReadStatusInCellForRowWithMessage:(id)arg1 &#123;</span><br><span class="line">  return NO;</span><br><span class="line">&#125;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure>
<p>Makefile：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ARCHS = arm64</span><br><span class="line">TARGET = iphone:latest:8.0</span><br><span class="line">include $(THEOS)/makefiles/common.mk</span><br><span class="line"></span><br><span class="line">TWEAK_NAME = DingTalkRecallBarrier</span><br><span class="line">DingTalkRecallBarrier_FILES = Tweak.xm</span><br><span class="line"></span><br><span class="line">include $(THEOS_MAKE_PATH)/tweak.mk</span><br><span class="line"></span><br><span class="line">after-install::</span><br><span class="line">        install.exec &quot;killall -9 DingTalk&quot;</span><br></pre></td></tr></table></figure>
<p>这里的 <code>needSendReadStatusInCellForRowWithMessage:</code> 直接返回 NO ，因为即使不执行原来的方法，也不会影响 App 的正常运行。</p>
<p>3、将 Tweak 编译打包安装到越狱设备上：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">➜  dingtalkrecallbarrier export THEOS_DEVICE_IP=localhost</span><br><span class="line">➜  dingtalkrecallbarrier export THEOS_DEVICE_PORT=2223</span><br><span class="line">➜  dingtalkrecallbarrier make package install</span><br><span class="line">&gt; Making all for tweak DingTalkRecallBarrier…</span><br><span class="line">make[2]: Nothing to be done for `internal-library-compile&apos;.</span><br><span class="line">&gt; Making stage for tweak DingTalkRecallBarrier…</span><br><span class="line">#Filter plist</span><br><span class="line">#PreferenceLoader plist</span><br><span class="line">dm.pl: building package `com.triplecc.dingtalkrecallbarrier:iphoneos-arm&apos; in `./packages/com.triplecc.dingtalkrecallbarrier_0.0.1-13+debug_iphoneos-arm.deb&apos;</span><br><span class="line">==&gt; Installing…</span><br><span class="line">Selecting previously unselected package com.triplecc.dingtalkrecallbarrier.</span><br><span class="line">(Reading database ... 1230 files and directories currently installed.)</span><br><span class="line">Preparing to unpack /tmp/_theos_install.deb ...</span><br><span class="line">Unpacking com.triplecc.dingtalkrecallbarrier (0.0.1-13+debug) ...</span><br><span class="line">Setting up com.triplecc.dingtalkrecallbarrier (0.0.1-13+debug) ...</span><br><span class="line">install.exec &quot;killall -9 DingTalk&quot;</span><br></pre></td></tr></table></figure>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>第一次逆向实践，虽说编写的 Tweak 代码才几行，但其定位过程却是一波三折，可能因为经验不足导致定位不准确吧，不过逆向需要很好的耐心倒不假。因为以前做过即时通讯，所以对钉钉消息收发流程多少还是会有点自己的理解，这无形中也推进了我逆向的进度。</p>
<p>最后，这次逆向让我时隔三年之后，再一次有机会利用终端调试程序，还记得以前是做 Linux 应用程序时在嵌入式设备中使用 gdb 进行调试。决定以后在 Xcode 中也要多用命令行进行调试了，实在是舒畅。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://book.douban.com/subject/26363333/" target="_blank" rel="noopener">iOS应用逆向工程</a><br><br><a href="http://www.swiftyper.com/2017/02/15/dingtalk-fake-gps/" target="_blank" rel="noopener">iOS 逆向实战 - 钉钉签到远程“打卡”</a><br><br><a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0802b/CSET_CSINC.html" target="_blank" rel="noopener">ARM 64 常用汇编指令</a><br><br><a href="https://lldb.llvm.org/tutorial.html" target="_blank" rel="noopener">The LLDB Debugger Tutorial</a><br></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/逆向/" rel="tag"># 逆向</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/04/28/2017-04-28-gei-apptian-jia-xuan-fu-zhu-shou/" rel="next" title="给 APP 添加悬浮助手">
                <i class="fa fa-chevron-left"></i> 给 APP 添加悬浮助手
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/06/08/2017-06-08-cocoapodshe-localization/" rel="prev" title="CocoaPods和Localization">
                CocoaPods和Localization <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="tripleCC">
            
              <p class="site-author-name" itemprop="name">tripleCC</p>
              <p class="site-description motion-element" itemprop="description">ʕ•̫͡•ʔ-̫͡-ʕ•͓͡•ʔ-̫͡-ʕ•̫͡•ʔ-̫͡-ʕ•͓͡•ʔ-̫͡-ʔ</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">68</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">18</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">63</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/tripleCC" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.jianshu.com/u/97e39e95c2cc" target="_blank" title="简书">
                      
                        <i class="fa fa-fw fa-globe"></i>简书</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/tripleCCBrian" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://stackoverflow.com/users/5187957/triplecc" target="_blank" title="StackOverflow">
                      
                        <i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:triplec.linux@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#灵感"><span class="nav-number">1.</span> <span class="nav-text">灵感</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备工作"><span class="nav-number">2.</span> <span class="nav-text">准备工作</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#对-App-进行砸壳"><span class="nav-number">2.1.</span> <span class="nav-text">对 App 进行砸壳</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#进行-class-dump-及反汇编"><span class="nav-number">2.2.</span> <span class="nav-text">进行 class-dump 及反汇编</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#逆向过程"><span class="nav-number">3.</span> <span class="nav-text">逆向过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#定位消息控制器"><span class="nav-number">3.1.</span> <span class="nav-text">定位消息控制器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定位接受消息方法"><span class="nav-number">3.2.</span> <span class="nav-text">定位接受消息方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定位发送已读标志方法"><span class="nav-number">3.3.</span> <span class="nav-text">定位发送已读标志方法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写安装-Tweak"><span class="nav-number">3.4.</span> <span class="nav-text">编写安装 Tweak</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">4.</span> <span class="nav-text">小结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tripleCC</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://tripleCC.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'https://triplecc.github.io/2017/05/13/2017-05-13-wan-wan-ni-xiang-zhi-lan-jie-ding-ding-xin-xi-de-yi-du-zhuang-tai/';
          this.page.identifier = '2017/05/13/2017-05-13-wan-wan-ni-xiang-zhi-lan-jie-ding-ding-xin-xi-de-yi-du-zhuang-tai/';
          this.page.title = '玩玩逆向之拦截钉钉消息已读状态';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://tripleCC.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  





  

  

  

  
  

  

  

  

</body>
</html>
