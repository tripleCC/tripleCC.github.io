多任务，抢占式，优先级划分，每个任务快速切换，执行超过时长可暂停



不用物理内存

- 地址空间不隔离
- 内存使用效率低
- 程序运行的地址不确定



n 位机器最大地址空间 2^n 字节

目前 PC 操作系统普遍分页 4 KB

**页错误**将进程虚拟页的映射对象从磁盘页转移到物理页



内存共享，虚拟空间的有些页被映射到了同一个物理页

MMU-》虚拟地址转换为物理地址



线程，程序执行流的最小单元，由线程ID、当前指令指针（PC）、寄存器集合、堆栈4部分组成

进程中的线程共享程序的内存空间（代码段、数据段、堆等）及一些进程级资源（打开文件、信号等）



线程私有存储空间：

- 栈 （局部变量、函数参数等）
- 线程局部存储 TSL
- 寄存器



IO 密集、CPU 密集（线程等待）



抢占、不可抢占线程（线程内部放弃执行）



fork 进程写时复制，所以快



原子操作：单指令操作



同步

- 信号量（访问范围任何进程）
- 互斥量（访问范围任何进程，需同个线程持有释放）
- 临界区（访问范围局限同个进程，需同个线程持有释放）
- 读写锁（获取方式：共享的、独占的）
- 条件变量 （notify）



volatile

- 阻止编译器为了提高速度将变量缓存到寄存器内而不写回
- 组织编译器调整操作 volatile 变量的指令顺序（不能组织 CPU 动态调度换序）



预处理(.i)、编译(.s)、汇编(.o)、链接

预处理 -E

- 处理 # 开始的预编译指令，如 #include、#define

- 删除 #define，展开宏定义
- 处理条件预编译指令，如 #if、#ifdef、#elif、#else、#endif
- 处理 #include，递归插入包含文件
- 删除注释，如//、\\**\
- 添加行号和文件标识，用以编译时产生调试行号等信息
- 保留 #pragma （编译指示）

编译 -S

- 转成汇编代码

- 词法分析、语法分析、语义分析及优化

汇编 -C

- 汇编代码转成机器可执行的指令，生成目标文件

链接 

- 生成可执行文件



词法分析

- 字符串分割成记号

- 关键字、标识符、字面量、特殊符号

语法分析

- 语法树，以表达式为节点的树

语义分析

- 表达式类型



编译器

- 前端，负责产生机器无关的中间代码
- 后端，负责将中间代码转换成目标机器代码

重定位

- 重新计算各个目标的地址过程



链接

- 地址和空间分配
- 符号决议（符号绑定）（决议倾向静态链接，绑定倾向动态链接）
- 重定位



程序指令、程序数据

程序指令

- 代码段(.text) 

程序数据

- 数据段(.data)
- .bss段



分离的好处

- 读写权限分离
- 增加缓存命中
- 共享只读内存



大小端：看左边放的是大小位



目标文件中的重定位表



链接的本质，把多个不同的目标文件之间相互粘到一起，对函数和变量的地址的引用



符号修饰与函数签名



C++符号名=函数+函数签名



extern "C" : 大括号内的名称修饰机制不起作用，为修饰后符号

C++会以C++的规则对名称进行修饰，C 不会，如果 C++ 引入 C 函数时，修饰了函数名，则链接时会找不到对应的 C 函数

```
#if defined(__cplusplus)
#define FOUNDATION_EXPORT extern "C"
#else
#define FOUNDATION_EXPORT extern
#endif
```



#### 符号重定义/未定义错误

强符号

- 函数和初始化了的全局变量

弱符号

- 未初始化的全局变量



链接器处理多次定义的全局符号：

- 不允许强符号被多次定义；如果有多个强符号定义，则链接器报符号重定义错误
- 如果一个符号在某个目标文件中是强符号，在其他文件中都是弱符号，那么选择强符号
- 如果一个符号在所有目标文件中都是弱符号，那么选择其中占用空间最大的一个



强引用

- 符号决议时，如果没有找到该符号的定义，链接器报未定于错误

弱引用

- 和强引用相反，不会报



无论是可执行文件、目标文件或库，它们实际上都是基于段的文件或是这种文件的集合。