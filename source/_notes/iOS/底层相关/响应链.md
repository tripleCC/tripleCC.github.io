###  触摸

从触摸动作发生，到实际执行处理代码，可以分下面两步：

- 查找触摸视图，派发触摸事件
- 查找事件处理对象，并让此对象处理触摸事件

### 整个触摸事件的处理过程

- 发生触摸事件
- 捕捉触摸事件线程 RunLoop 处理 source1，并设置主线程 RunLoop 对应的 source0 可处理
- 主线程 RunLoop 处理 source0
- 从 window 开始递归 subviews 查找触摸视图
- 将触摸事件由《 Application -> Window -> 触摸视图》路径派发给触摸视图
- 查看触摸视图和其父视图是否有 UIGestureRecognizer（UIGestureRecognizer 会影响关联视图及其子视图，比它们先一步拿到触摸事件），有 UIGestureRecognizer 则开始观察手势，匹配后由 UIGestureRecognizer 直接处理触摸事件，并取消 touches 系列回调；**无 UIGestureRecognizer 或者匹配到手势前**，将触摸事件发送给触摸视图响应链
  - 这里有个特例，**UIControl 不会被父视图关联的 UIGestureRecognizer "覆盖"**，所以 UIControl **父视图的** UIGestureRecognizer 不会影响到 UIControl 默认监听事件的处理，UIControl 会比父视图的 UIGestureRecognizer 先一步拿到触摸事件并进行处理，但直接往 UIControl 上加对应的 UIGestureRecognizer 还是会产生影响
- 响应链顺着《触摸 View -> 父 View  -> 控制器 (如果有) -> Window -> Application -> Application 代理》 路径（UIResponder 的 nextResponder 方法）查找触摸事件处理对象 （实现 touches 系列方法），并让此对象处理触摸事件。



其中需要注意的是 UIGestureRecognizer 不属于响应链，但是会影响到响应链对事件的捕获动作。

### 触摸视图查找路径

**查找路径** 为从**当前可视 window 开始，递归调用 subviews 的 hit-test 方法**，返回最终视图为触摸视图。

方向为 Window -> 触摸 View。

### 响应链路径

响应链：

![Snip20190328_5](https://github.com/tripleCC/tripleCC.github.io/raw/hexo/source/images/f17df5bc-d80b-4e17-81cf-4277b1e0f6e4.png)

**响应链路径：**

1. 触摸 View 

2.  父 View 

3.  控制器 (如果有)

4. Window 

5.  Application 	

6. Application 代理

如果没有实现 **touches** 处理 touch 事件，则顺着路径（UIResponder 的 nextResponder 方法）往下传。

方向为 触摸 View -> Window。



### UIGestureRecognizer

> a UIGestureRecognizer receives touches hit-tested to its view and any of that view's subviews

> UIGestureRecognizers aren't in the responder chain, but observe touches hit-tested to their view and their view's subviews

> UIGestureRecognizers receive touches before the view to which the touch was hit-tested

对于 UIGestureRecognizer 的子类即自定义手势，其内部也可以实现触摸回调  [`touchesBegan(_:with:)`](https://developer.apple.com/documentation/uikit/uiresponder/1621142-touchesbegan), [`touchesMoved(_:with:)`](https://developer.apple.com/documentation/uikit/uiresponder/1621107-touchesmoved), [`touchesEnded(_:with:)`](https://developer.apple.com/documentation/uikit/uiresponder/1621084-touchesended), 和 [`touchesCancelled(_:with:)`](https://developer.apple.com/documentation/uikit/uiresponder/1621116-touchescancelled) 方法，如果实现了，UIGestureRecognizer 关联的 Views 将不会调用相关方法，如果没有实现，则关联 Views 的这些方法照常触发，直到 UIGestureRecognizer 识别了手势调用，Cancel 掉这些方法的触发 （导致 View 回调 touchesCancelled 方法）。



手势的状态变更以一个 runloop 循环为间隔时间。

### 一些文档摘录

>Controls communicate directly with their associated target object using action messages. When the user interacts with a control, the control sends an action message to its target object. Action messages are not events, but they may still take advantage of the responder chain. When the target object of a control is `nil`, UIKit starts from the target object and traverses the responder chain until it finds an object that implements the appropriate action method. For example, the UIKit editing menu uses this behavior to search for responder objects that implement methods with names like [`cut(_:)`](https://developer.apple.com/documentation/uikit/uiresponderstandardeditactions/2354193-cut), [`copy(_:)`](https://developer.apple.com/documentation/uikit/uiresponderstandardeditactions/2354191-copy), or [`paste(_:)`](https://developer.apple.com/documentation/uikit/uiresponderstandardeditactions/2354189-paste).

> Gesture recognizers receive touch and press events before their view does. If a view's gesture recognizers fail to recognize a sequence of touches, UIKit sends the touches to the view. If the view does not handle the touches, UIKit passes them up the responder chain. For more information about using gesture recognizer’s to handle events, see [Handling UIKit Gestures](https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/handling_uikit_gestures).

>In iOS 6.0 and later, default control actions prevent overlapping gesture recognizer behavior. For example, the default action for a button is a single tap. If you have a single tap gesture recognizer attached to a button’s parent view, and the user taps the button, then the button’s action method receives the touch event instead of the gesture recognizer. This applies only to gesture recognition that overlaps the default action for a control, which includes:
>A single finger single tap on a UIButton, UISwitch,  UISegmentedControl, UIStepper,and UIPageControl.
>A single finger swipe on the knob of a UISlider, in a direction parallel to the slider.
>A single finger pan gesture on the knob of a UISwitch, in a direction parallel to the switch.

> When a control-specific event occurs, the control calls any associated action methods right away. Action methods are dispatched through the current [`UIApplication`](https://developer.apple.com/documentation/uikit/uiapplication) object, which finds an appropriate object to handle the message, following the responder chain if needed. For more information about responders and the responder chain, see [Event Handling Guide for UIKit Apps](https://developer.apple.com/library/archive/documentation/EventHandling/Conceptual/EventHandlingiPhoneOS/index.html#//apple_ref/doc/uid/TP40009541).

> A gesture recognizer operates on touches hit-tested to a specific view and all of that view’s subviews （gesture recognizer 会处理视图和这个视图的子视图的触摸事件，所以如果子视图中需要走响应链而父视图添加了能识别手势的 gesture recognizer ，则子视图这一部分功能回失效，比如 UITableView 的父视图添加了 tap 手势，那么  UITableView 的 cell 点击会失效）. It thus must be associated with that view. To make that association you must call the [`UIView`](https://developer.apple.com/documentation/uikit/uiview) method [`addGestureRecognizer(_:)`](https://developer.apple.com/documentation/uikit/uiview/1622496-addgesturerecognizer). A gesture recognizer doesn’t participate in the view’s responder chain.

### 资料

[Using Responders and the Responder Chain to Handle Events](<https://developer.apple.com/documentation/uikit/touches_presses_and_gestures/using_responders_and_the_responder_chain_to_handle_events>)

[UIControl](<https://developer.apple.com/documentation/uikit/uicontrol>)

[UIGestureRecognizer](<https://developer.apple.com/documentation/uikit/uigesturerecognizer>)

[详解iOS触摸事件与手势识别](<https://foolish-boy.github.io/2016/%E8%AF%A6%E8%A7%A3iOS%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%B8%8E%E6%89%8B%E5%8A%BF%E8%AF%86%E5%88%AB/>)