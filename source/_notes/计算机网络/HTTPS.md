### HTTP 的不足

- 通信使用明文，内容可能被**窃听**
- 不验证通信方的身份，因此有可能遭遇**伪装**
- 无法证明报文的完整性，所以有可能已遭**篡改**

 

### HTTPS 过程

> HTTPS = HTTP + 加密 + 认证 + 完整性保护

1. 完成 TCP 三次同步握手

2. 客户端验证服务器数字证书，通过，进入步骤3

3. DH算法协商对称加密算法的密钥、hash算法的密钥

4. SSL安全加密隧道协商完成

5. 网页以加密方式传输，用协商的对程加密算法和密钥加密，保证数据机密性；用协商的hash算法进行数据完完整性保护，保证数据不被篡改

hash 算法： 单向机密，明文->密文，反过来不行

![Snip20190328_5](https://github.com/tripleCC/tripleCC.github.io/raw/hexo/source/images/Snip20190416_9.png)

### SSL 运行过程

1. 客户端向服务端索要并验证公钥
2. 双方协商生成"共享密钥"
3. 双方采用共享密钥加密通信

客户端向服务断索取公钥，然后用公钥加密信息，服务器收到密文后，用自己的私钥解密。

**如何保证公钥不被篡改？**

将公钥放在**数字证书**中，只要证书是可信的，公钥就是可信的。

**数字证书验证**：使用认证机构的私钥加密使用服务器公钥生成的数字签名（由 hash 算法生成），将**公钥和数字签名**合成一个文件（数字证书），客户端再使用预存的认证机构公钥（浏览器植入）解密这个数字证书中的数字签名，然后使用同一算法将数字证书中的公钥转换成数字签名，最后比较解密后的数字签名和生成的数字签名是否相等。

**签名**：使用私钥对公开内容 hash 值的加密值

[数字证书的原理是什么？](<https://www.zhihu.com/question/24294477>) (***私钥加密，公钥解密***)

![](<http://blog.cnbang.net/wp-content/uploads/2017/03/sign0.png>)

**公钥加密计算量大，如何减少耗用时间？**

服务器公钥只用来加密共享密钥（对称加密）本身，在确保交换密钥安全的前提下，使用共享密钥进行通信，由于共享密钥是对称加密，所以运算速度比非对称加密快。



### 抓包 HTTPS 原理

首先要明确，要想获取数据包的内容，需要知道加密这个数据包的共享密钥。如何获取共享密钥？

抓包代理首先会拦截服务端发送的公钥，并且自己生成一份数字证书给客户端，

然后客户端信任抓包工具的根证书后，会生成共享密钥，并使用抓包代理给的公钥进行加密，然后发送给抓包代理，

抓包代理使用自己的私钥解密含有共享密钥的报文，得到共享密钥，

为了让服务端能正常解析，得到共享密钥，抓包代理会使用第一步拦截的服务端公钥对共享密钥进行加密，然后传给服务端。



![Snip20190328_5](https://github.com/tripleCC/tripleCC.github.io/raw/hexo/source/images/Snip20190416_8.png)

### 资料

[根证书](<https://zh.wikipedia.org/wiki/%E6%A0%B9%E8%AF%81%E4%B9%A6>)

[SSL/TLS协议运行机制的概述](<http://www.ruanyifeng.com/blog/2014/02/ssl_tls.html>)

[iOS App 签名的原理](<https://blog.cnbang.net/tech/3386/>)