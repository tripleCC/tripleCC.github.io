
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>玩玩逆向之拦截钉钉消息已读状态 - tripleCC的技术博客</title>
  <meta name="author" content="tripleCC">

  
  <meta name="description" content="流光容易把人抛，红了樱桃，绿了芭蕉 一个月前的某一天，百无聊赖的我在整理房间的时候，偶然翻开了一本积灰的“小黄书”，看到首页作者的赠语，眼前不禁浮现两年前，几经波折辗转到上海的我兴致勃勃勃勃地拜托小锅让他的直属老大狗神 (本书作者之一) ，给刚买的这本《iOS应用逆向工程》签名的场景，百味杂陈。 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="/atom.xml" rel="alternate" title="tripleCC的技术博客" type="application/atom+xml">
  
  <link rel="canonical" href="http://triplecc.github.io/blog/2017-05-13-wan-wan-ni-xiang-zhi-lan-jie-ding-ding-xin-xi-de-yi-du-zhuang-tai/">
  <link href="/favicon.png" rel="shortcut icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--[good job! gfw]><script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script><!-->
  <script src="http://cdn.staticfile.org/jquery/1.9.1/jquery.min.js"></script>
  <link href="/stylesheets/google-fonts.css" rel="stylesheet" type="text/css">
  

  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  
  <link href="/stylesheets/data-table.css" media="screen, projection" rel="stylesheet" type="text/css" />
  
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">tripleCC的技术博客</a></h1>
  
    <h2>ʕ•̫͡•ʔ-̫͡-ʕ•͓͡•ʔ-̫͡-ʕ•̫͡•ʔ-̫͡-ʕ•͓͡•ʔ-̫͡-ʔ</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="triplecc.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">玩玩逆向之拦截钉钉消息已读状态</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-05-13T16:54:37+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>4:54 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><blockquote><p>流光容易把人抛，红了樱桃，绿了芭蕉</p></blockquote>

<p>一个月前的某一天，百无聊赖的我在整理房间的时候，偶然翻开了一本积灰的“小黄书”，看到首页作者的赠语，眼前不禁浮现两年前，几经波折辗转到上海的我兴致勃勃勃勃地拜托<a href="http://www.swiftyper.com/about/">小锅</a>让他的直属老大狗神 (本书作者之一) ，给刚买的这本《iOS应用逆向工程》签名的场景，百味杂陈。说来惭愧，我一直都没有好好地看过这本书，等回过头来，不知不觉已经过去两年了。这篇文章致那个曾经那个能够静心看书的少年。</p>

<!--more-->


<h2>灵感</h2>

<p>钉钉是一款针对企业日常工作交流的 App ，因为是针对企业协作，所以不同于一般的 IM 软件，比如微信，钉钉增加了对消息读取状态的监控。简单来说就是同事发送一条消息后，如果我打开 App ，进入聊天界面查看了这条消息，那么该同事就会在这条消息旁边看到“已读”字样，如下图：</p>

<p><img src="/images/Snip20170513_1.png" alt="" />
<img src="/images/Snip20170513_4.png" alt="" /></p>

<p>这个已读功能在工作的时候还是挺有作用的，能够知道同事是否已经知晓的相关事务。不过总会存在某些时候，我们不希望让对方知道消息已经被读取了。这就需要对 App 进行一些处理了。</p>

<h2>准备工作</h2>

<p>因为逆向基本工具在《iOS应用逆向工程》中罗列地非常清楚，所以对于一些基本环境的配置，这里就略过了，只简单介绍下这次逆向需要的工具。</p>

<table>
<thead>
<tr>
<th> 工具          </th>
<th style="text-align:center;">    本次逆向作用     </th>
</tr>
</thead>
<tbody>
<tr>
<td> dumpdecrypted <br> Clutch           </td>
<td style="text-align:center;"> 对 App 进行砸壳，使之可进行反汇编及 dump </td>
</tr>
<tr>
<td> class-dump           </td>
<td style="text-align:center;"> 获取 App 的 class 信息 （ Xcode 打开方便查看） </td>
</tr>
<tr>
<td> Hopper Disassembler    </td>
<td style="text-align:center;"> 反汇编器，查看 App 的汇编代码 </td>
</tr>
<tr>
<td> usbmuxd    </td>
<td style="text-align:center;"> <a href="http://localhost:4000/blog/2017-04-09-shi-yong-usbmuxdlian-jie-iphone/">映射使用 USB 连接的逆向设备端口到本地</a> </td>
</tr>
<tr>
<td> OpenSSH         </td>
<td style="text-align:center;"> 让越狱设备上具备 ssh 服务 </td>
</tr>
<tr>
<td> cycript         </td>
<td style="text-align:center;"> 在目标 App 进程中测试函数，也可用来定位感兴趣对象 </td>
</tr>
<tr>
<td> debugserver         </td>
<td style="text-align:center;"> 调试服务器，可让 lldb 连接 iOS 进行远程调试 </td>
</tr>
<tr>
<td> lldb <br> chisel           </td>
<td style="text-align:center;"> lldb 调试器，不多说 <br> FB 出品的 lldb 调试插件，不仅在 Xcode 正向开发中很有用，逆向也酸爽至极 </td>
</tr>
<tr>
<td> theos           </td>
<td style="text-align:center;"> 编写Tweak，可对逆向代码进行编译打包，并以 dylib 的形式安装到越狱设备中 </td>
</tr>
</tbody>
</table>


<p>接下来记录下整个逆向工作流程。</p>

<h4>对 App 进行砸壳</h4>

<p>本次砸壳采用的工具是书中演示的 dumpdecrypted。</p>

<p>1、首先通过 ssh 连接到 iOS 设备</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">➜</span>  <span class="n">dumpdecrypted</span> <span class="nl">git</span><span class="p">:(</span><span class="n">master</span><span class="p">)</span> <span class="err">✗</span> <span class="n">iproxy</span> <span class="mi">2223</span> <span class="mi">22</span> <span class="o">&amp;</span>
</span><span class='line'><span class="err">➜</span>  <span class="n">dumpdecrypted</span> <span class="nl">git</span><span class="p">:(</span><span class="n">master</span><span class="p">)</span> <span class="err">✗</span> <span class="n">ssh</span> <span class="n">root</span><span class="p">@</span><span class="n">localhost</span> <span class="o">-</span><span class="n">p</span> <span class="mi">2223</span>
</span></code></pre></td></tr></table></div></figure>


<p>2、使用 ps 和 grep 找出目标 App 可执行文件路径</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="nl">iPhone</span><span class="p">:</span><span class="o">~</span> <span class="n">root</span><span class="err">#</span> <span class="n">ps</span> <span class="o">-</span><span class="n">A</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">Application</span>
</span><span class='line'> <span class="mi">1774</span> <span class="o">??</span>         <span class="mi">1</span><span class="o">:</span><span class="mf">06.02</span> <span class="o">/</span><span class="n">Applications</span><span class="o">/</span><span class="n">InCallService</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">InCallService</span>
</span><span class='line'> <span class="mi">4147</span> <span class="o">??</span>         <span class="mi">1</span><span class="o">:</span><span class="mf">04.34</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">Bundle</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="mi">60</span><span class="n">B29D5D</span><span class="o">-</span><span class="mi">2360</span><span class="o">-</span><span class="mi">4</span><span class="n">C01</span><span class="o">-</span><span class="n">A49F</span><span class="o">-</span><span class="mi">8</span><span class="n">CA87C752EFE</span><span class="o">/</span><span class="n">DingTalk</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">DingTalk</span>
</span><span class='line'> <span class="mi">4217</span> <span class="o">??</span>         <span class="mi">0</span><span class="o">:</span><span class="mf">04.58</span> <span class="o">/</span><span class="n">Applications</span><span class="o">/</span><span class="n">Weather</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">PlugIns</span><span class="o">/</span><span class="n">WeatherAppTodayWidget</span><span class="p">.</span><span class="n">appex</span><span class="o">/</span><span class="n">WeatherAppTodayWidget</span>
</span><span class='line'> <span class="mi">4220</span> <span class="o">??</span>         <span class="mi">0</span><span class="o">:</span><span class="mf">02.39</span> <span class="o">/</span><span class="n">Applications</span><span class="o">/</span><span class="n">Maps</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">PlugIns</span><span class="o">/</span><span class="n">MapsWidget</span><span class="p">.</span><span class="n">appex</span><span class="o">/</span><span class="n">MapsWidget</span>
</span><span class='line'> <span class="mi">4223</span> <span class="o">??</span>         <span class="mi">0</span><span class="o">:</span><span class="mf">02.50</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">Bundle</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="n">D4438959</span><span class="o">-</span><span class="mi">3</span><span class="n">D50</span><span class="o">-</span><span class="mi">4</span><span class="n">D5B</span><span class="o">-</span><span class="n">AFD5</span><span class="o">-</span><span class="mi">635</span><span class="n">BAE010F57</span><span class="o">/</span><span class="n">Pin</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">PlugIns</span><span class="o">/</span><span class="n">PinToday</span><span class="p">.</span><span class="n">appex</span><span class="o">/</span><span class="n">PinToday</span>
</span><span class='line'> <span class="mi">4233</span> <span class="o">??</span>         <span class="mi">0</span><span class="o">:</span><span class="mf">00.78</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">Bundle</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="n">D4438959</span><span class="o">-</span><span class="mi">3</span><span class="n">D50</span><span class="o">-</span><span class="mi">4</span><span class="n">D5B</span><span class="o">-</span><span class="n">AFD5</span><span class="o">-</span><span class="mi">635</span><span class="n">BAE010F57</span><span class="o">/</span><span class="n">Pin</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">PlugIns</span><span class="o">/</span><span class="n">PinCleaner</span><span class="p">.</span><span class="n">appex</span><span class="o">/</span><span class="n">PinCleaner</span>
</span><span class='line'> <span class="mi">4316</span> <span class="o">??</span>         <span class="mi">0</span><span class="o">:</span><span class="mf">01.70</span> <span class="o">/</span><span class="n">Applications</span><span class="o">/</span><span class="n">MobileCal</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">PlugIns</span><span class="o">/</span><span class="n">CalendarWidget</span><span class="p">.</span><span class="n">appex</span><span class="o">/</span><span class="n">CalendarWidget</span>
</span><span class='line'> <span class="mi">4319</span> <span class="o">??</span>         <span class="mi">0</span><span class="o">:</span><span class="mf">01.99</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">Bundle</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="mi">61</span><span class="n">C2E8D7</span><span class="o">-</span><span class="mi">4</span><span class="n">C2D</span><span class="o">-</span><span class="mi">4323</span><span class="o">-</span><span class="n">A357</span><span class="o">-</span><span class="mf">7F</span><span class="n">AB9AE33339</span><span class="o">/</span><span class="n">WizIPhone</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">PlugIns</span><span class="o">/</span><span class="n">WizNoteIPhoneToday</span><span class="p">.</span><span class="n">appex</span><span class="o">/</span><span class="n">WizNoteIPhoneToday</span>
</span><span class='line'> <span class="mi">4322</span> <span class="o">??</span>         <span class="mi">0</span><span class="o">:</span><span class="mf">01.28</span> <span class="o">/</span><span class="n">private</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">Bundle</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="n">F576BB21</span><span class="o">-</span><span class="n">A1F2</span><span class="o">-</span><span class="mi">42</span><span class="n">B8</span><span class="o">-</span><span class="n">A18F</span><span class="o">-</span><span class="n">D2AFCE9E78D8</span><span class="o">/</span><span class="n">AlipayWallet</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">PlugIns</span><span class="o">/</span><span class="n">APTodayWidget</span><span class="p">.</span><span class="n">appex</span><span class="o">/</span><span class="n">APTodayWidget</span>
</span><span class='line'> <span class="mi">4418</span> <span class="o">??</span>         <span class="mi">0</span><span class="o">:</span><span class="mf">28.22</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">Bundle</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="mf">3654E1</span><span class="n">CC</span><span class="o">-</span><span class="n">CEE2</span><span class="o">-</span><span class="mi">44</span><span class="n">DB</span><span class="o">-</span><span class="n">A7E6</span><span class="o">-</span><span class="n">B4268A59F3C6</span><span class="o">/</span><span class="n">WeChat</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">WeChat</span>
</span><span class='line'> <span class="mi">4429</span> <span class="o">??</span>         <span class="mi">0</span><span class="o">:</span><span class="mf">08.09</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">Bundle</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="n">F576BB21</span><span class="o">-</span><span class="n">A1F2</span><span class="o">-</span><span class="mi">42</span><span class="n">B8</span><span class="o">-</span><span class="n">A18F</span><span class="o">-</span><span class="n">D2AFCE9E78D8</span><span class="o">/</span><span class="n">AlipayWallet</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">AlipayWallet</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里由于先前并不知道钉钉的可执行文件名，所以直接用 Application 关键字对所有进程进行过滤，知道后就可以直接用 DingTalk 进行过滤了 。包含钉钉可执行文件路径的一行为</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="mi">4147</span> <span class="o">??</span>         <span class="mi">1</span><span class="o">:</span><span class="mf">04.34</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">Bundle</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="mi">60</span><span class="n">B29D5D</span><span class="o">-</span><span class="mi">2360</span><span class="o">-</span><span class="mi">4</span><span class="n">C01</span><span class="o">-</span><span class="n">A49F</span><span class="o">-</span><span class="mi">8</span><span class="n">CA87C752EFE</span><span class="o">/</span><span class="n">DingTalk</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">DingTalk</span>
</span></code></pre></td></tr></table></div></figure>


<p>3、使用 cycript 获取钉钉 Document 文件夹路径</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="nl">iPhone</span><span class="p">:</span><span class="o">~</span> <span class="n">root</span><span class="err">#</span> <span class="n">cycript</span> <span class="o">-</span><span class="n">p</span>  <span class="mi">4147</span>
</span><span class='line'><span class="n">cy</span><span class="err">#</span> <span class="n">NSSearchPathForDirectoriesInDomains</span><span class="p">(</span><span class="n">NSDocumentDirectory</span><span class="p">,</span> <span class="n">NSUserDomainMask</span><span class="p">,</span> <span class="nb">YES</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'><span class="s">@&quot;/var/mobile/Containers/Data/Application/93BEEF52-2DE2-4687-9986-E50CBD961BB2/Documents&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用 <code>cycript -p + pid / 可执行文件名</code> 就可以在目标 App 的进程下运行方法了。在这一步顺便把钉钉的 Bundle ID 给打印出来，后面 thoes 会用到</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">cy</span><span class="err">#</span> <span class="p">[[</span><span class="bp">NSBundle</span> <span class="n">mainBundle</span><span class="p">]</span> <span class="n">bundleIdentifier</span><span class="p">]</span>
</span><span class='line'><span class="s">@&quot;com.laiwang.DingTalk&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>4、将 dumpdecrypted.dylib 拷贝到 Documents 目录下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">➜</span>  <span class="n">dumpdecrypted</span> <span class="nl">git</span><span class="p">:(</span><span class="n">master</span><span class="p">)</span> <span class="err">✗</span> <span class="n">scp</span> <span class="o">-</span><span class="n">P</span> <span class="mi">2223</span>  <span class="n">dumpdecrypted</span><span class="p">.</span><span class="n">dylib</span> <span class="n">root</span><span class="p">@</span><span class="nl">localhost</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">mobile</span><span class="o">/</span><span class="n">Containers</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="mi">93</span><span class="n">BEEF52</span><span class="o">-</span><span class="mi">2</span><span class="n">DE2</span><span class="o">-</span><span class="mi">4687</span><span class="o">-</span><span class="mi">9986</span><span class="o">-</span><span class="n">E50CBD961BB2</span><span class="o">/</span><span class="n">Documents</span>
</span></code></pre></td></tr></table></div></figure>


<p>5、开始砸壳</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="nl">iPhone</span><span class="p">:</span><span class="o">~</span> <span class="n">root</span><span class="err">#</span> <span class="n">cd</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">mobile</span><span class="o">/</span><span class="n">Containers</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="mi">93</span><span class="n">BEEF52</span><span class="o">-</span><span class="mi">2</span><span class="n">DE2</span><span class="o">-</span><span class="mi">4687</span><span class="o">-</span><span class="mi">9986</span><span class="o">-</span><span class="n">E50CBD961BB2</span><span class="o">/</span><span class="n">Documents</span>
</span><span class='line'><span class="nl">iPhone</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">mobile</span><span class="o">/</span><span class="n">Containers</span><span class="o">/</span><span class="n">Data</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="mi">93</span><span class="n">BEEF52</span><span class="o">-</span><span class="mi">2</span><span class="n">DE2</span><span class="o">-</span><span class="mi">4687</span><span class="o">-</span><span class="mi">9986</span><span class="o">-</span><span class="n">E50CBD961BB2</span><span class="o">/</span><span class="n">Documents</span> <span class="n">root</span><span class="err">#</span> <span class="n">DYLD_INSERT_LIBRARIES</span><span class="o">=</span><span class="n">dumpdecrypted</span><span class="p">.</span><span class="n">dylib</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">Bundle</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="mi">60</span><span class="n">B29D5D</span><span class="o">-</span><span class="mi">2360</span><span class="o">-</span><span class="mi">4</span><span class="n">C01</span><span class="o">-</span><span class="n">A49F</span><span class="o">-</span><span class="mi">8</span><span class="n">CA87C752EFE</span><span class="o">/</span><span class="n">DingTalk</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">DingTalk</span>
</span></code></pre></td></tr></table></div></figure>


<p>砸壳后，当前目录下会有一个 DingTalk.decrypted 文件，将这个砸壳之后的文件拷贝到电脑上进行反汇编及 class-dump 。</p>

<h4>进行 class-dump 及反汇编</h4>

<p>1、进入 DingTalk.decrypted 所在目录，执行 class-dump</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">➜</span>  <span class="n">DingTalk</span> <span class="k">class</span><span class="o">-</span><span class="n">dump</span> <span class="o">-</span><span class="n">S</span> <span class="o">-</span><span class="n">s</span>  <span class="o">-</span><span class="n">H</span> <span class="o">-</span><span class="n">o</span> <span class="n">DTClassDump</span>  <span class="n">DingTalk</span><span class="p">.</span><span class="n">decrypted</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到目录下多了 DTClassDump 文件夹，打开这个文件夹，全选里面的头文件，用 Xcode 打开。</p>

<p>2、打开 Hopper Disassembler 并将 DingTalk.decrypted 拖进面板中，Hopper Disassembler 会自动识别 DingTalk.decrypted 对应的 CPU 体系结构。确定进行后续操作后，Hopper Disassembler就开始进行反汇编了。反汇编的时间可能会<strong>有点长</strong>，所以最好把反汇编之后的 hop 文件保存一下，这样下次就可以直接打开了（不过即使这样打开也要挺久的，8G 内存也有点吃紧，老是转菊花 <em>(°:з」∠)</em> ）。</p>

<h2>逆向过程</h2>

<h4>定位消息控制器</h4>

<p>如果是从视图切入的话，使用 FLEXLoader （ Cydia 商店可下载 ） 是个不错的选择，它可以很方便地调试当前界面上的元素。当然，Revel 这种利器就不用多介绍了，用起来也是很舒畅。不过这里我使用了另外两种方式：</p>

<p>1、首先是使用 cycript。进入钉钉的聊天界面后，执行下面代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">cy</span><span class="err">#</span> <span class="p">[[[[[</span><span class="bp">UIApplication</span> <span class="n">sharedApplication</span><span class="p">]</span> <span class="n">keyWindow</span><span class="p">]</span> <span class="n">rootViewController</span><span class="p">]</span> <span class="n">viewControllers</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="n">topViewController</span><span class="p">]</span>
</span><span class='line'><span class="cp">#&quot;&lt;DTMessageOTOViewController: 0x104217c00&gt;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于大体知道钉钉界面的层级关系，使用代码获取当前界面的信息还是比较容易的。</p>

<p>2、第二种是使用 lldb 来打印控制器层级列表。<br>
这里涉及到 lldb 的远程调试，首先映射越狱设备 1234 端口到 Mac 本地 1234 端口：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">➜</span>  <span class="n">DTClassDump</span> <span class="n">iproxy</span> <span class="mi">1234</span> <span class="mi">1234</span> <span class="o">&amp;</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后在越狱设备上开启 debugserver：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="nl">iPhone</span><span class="p">:</span><span class="o">~</span> <span class="n">root</span><span class="err">#</span> <span class="n">debugserver</span> <span class="o">*:</span><span class="mi">1234</span> <span class="o">-</span><span class="n">a</span> <span class="n">DingTalk</span>
</span><span class='line'><span class="n">debugserver</span><span class="o">-</span><span class="l">@(</span><span class="err">#</span><span class="l">)</span><span class="nl">PROGRAM</span><span class="p">:</span><span class="n">debugserver</span>  <span class="nl">PROJECT</span><span class="p">:</span><span class="n">debugserver</span><span class="o">-</span><span class="mf">360.0.26.1</span>
</span><span class='line'> <span class="k">for</span> <span class="n">arm64</span><span class="p">.</span>
</span><span class='line'><span class="n">Listening</span> <span class="n">to</span> <span class="n">port</span> <span class="mi">1234</span> <span class="k">for</span> <span class="n">a</span> <span class="n">connection</span> <span class="n">from</span> <span class="o">*</span><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>接着执行一下命令，让 lldb 连接上 debugserver：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">➜</span>  <span class="n">DTClassDump</span> <span class="n">lldb</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">process</span> <span class="n">connect</span> <span class="nl">connect</span><span class="p">:</span><span class="c1">//localhost:1234</span>
</span><span class='line'>
</span><span class='line'><span class="o">*</span> <span class="kr">thread</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span> <span class="n">tid</span> <span class="o">=</span> <span class="mh">0xb7f8b</span><span class="p">,</span> <span class="mh">0x000000018e18816c</span> <span class="n">libsystem_kernel</span><span class="p">.</span><span class="n">dylib</span><span class="err">`</span><span class="n">mach_msg_trap</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span><span class="err">&#39;</span><span class="mi">505</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">main</span><span class="o">-</span><span class="kr">thread</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">stop</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">signal</span> <span class="n">SIGSTOP</span>
</span><span class='line'>    <span class="n">frame</span> <span class="err">#</span><span class="mi">0</span><span class="o">:</span> <span class="mh">0x000000018e18816c</span> <span class="n">libsystem_kernel</span><span class="p">.</span><span class="n">dylib</span><span class="err">`</span><span class="n">mach_msg_trap</span> <span class="o">+</span> <span class="mi">8</span>
</span><span class='line'><span class="n">libsystem_kernel</span><span class="p">.</span><span class="n">dylib</span><span class="err">`</span><span class="nl">mach_msg_trap</span><span class="p">:</span>
</span><span class='line'><span class="o">-&gt;</span>  <span class="mh">0x18e18816c</span> <span class="o">&lt;+</span><span class="mi">8</span><span class="o">&gt;:</span> <span class="n">ret</span>
</span><span class='line'>
</span><span class='line'><span class="n">libsystem_kernel</span><span class="p">.</span><span class="n">dylib</span><span class="err">`</span><span class="nl">mach_msg_overwrite_trap</span><span class="p">:</span>
</span><span class='line'>    <span class="mh">0x18e188170</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span> <span class="n">movn</span>   <span class="n">x16</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1f</span>
</span><span class='line'>    <span class="mh">0x18e188174</span> <span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;:</span> <span class="n">svc</span>    <span class="err">#</span><span class="mh">0x80</span>
</span><span class='line'>    <span class="mh">0x18e188178</span> <span class="o">&lt;+</span><span class="mi">8</span><span class="o">&gt;:</span> <span class="n">ret</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后我们就可以进行调试了。<strong><em>注：下面的 lldb 操作会用到 <a href="https://github.com/facebook/chisel">chisel</a> 插件的一些命令</em></strong>。<br></p>

<p>首先，导入 chisel 部分命令需要的 UIKit 框架：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">process</span> <span class="n">interrupt</span>
</span><span class='line'><span class="n">Process</span> <span class="mi">4600</span> <span class="n">stopped</span>
</span><span class='line'><span class="o">*</span> <span class="kr">thread</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span> <span class="n">tid</span> <span class="o">=</span> <span class="mh">0xb7f8b</span><span class="p">,</span> <span class="mh">0x000000018e18816c</span> <span class="n">libsystem_kernel</span><span class="p">.</span><span class="n">dylib</span><span class="err">`</span><span class="n">mach_msg_trap</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="mi">505</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">stop</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">signal</span> <span class="n">SIGSTOP</span>
</span><span class='line'>    <span class="n">frame</span> <span class="err">#</span><span class="mi">0</span><span class="o">:</span> <span class="mh">0x000000018e18816c</span> <span class="n">libsystem_kernel</span><span class="p">.</span><span class="n">dylib</span><span class="err">`</span><span class="n">mach_msg_trap</span> <span class="o">+</span> <span class="mi">8</span>
</span><span class='line'><span class="n">libsystem_kernel</span><span class="p">.</span><span class="n">dylib</span><span class="err">`</span><span class="nl">mach_msg_trap</span><span class="p">:</span>
</span><span class='line'><span class="o">-&gt;</span>  <span class="mh">0x18e18816c</span> <span class="o">&lt;+</span><span class="mi">8</span><span class="o">&gt;:</span> <span class="n">ret</span>
</span><span class='line'>
</span><span class='line'><span class="n">libsystem_kernel</span><span class="p">.</span><span class="n">dylib</span><span class="err">`</span><span class="nl">mach_msg_overwrite_trap</span><span class="p">:</span>
</span><span class='line'>    <span class="mh">0x18e188170</span> <span class="o">&lt;+</span><span class="mi">0</span><span class="o">&gt;:</span> <span class="n">movn</span>   <span class="n">x16</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1f</span>
</span><span class='line'>    <span class="mh">0x18e188174</span> <span class="o">&lt;+</span><span class="mi">4</span><span class="o">&gt;:</span> <span class="n">svc</span>    <span class="err">#</span><span class="mh">0x80</span>
</span><span class='line'>    <span class="mh">0x18e188178</span> <span class="o">&lt;+</span><span class="mi">8</span><span class="o">&gt;:</span> <span class="n">ret</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">expr</span> <span class="p">@</span><span class="n">import</span> <span class="n">UIKit</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>接着还是进入到聊天界面：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">pvc</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">DTTabBarController</span> <span class="mh">0x13bd4cb00</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">appeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">UILayoutContainerView</span> <span class="mh">0x13be75310</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="o">|</span> <span class="o">&lt;</span><span class="n">DTNavigationController</span> <span class="mh">0x13c8dda00</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">appeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">UILayoutContainerView</span> <span class="mh">0x13be7dee0</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="o">|</span>    <span class="o">|</span> <span class="o">&lt;</span><span class="n">DTConversationListController</span> <span class="mh">0x13c02ee00</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">disappeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span> <span class="o">&lt;</span><span class="bp">UIView</span> <span class="mh">0x13bd7ab40</span><span class="o">&gt;</span> <span class="n">not</span> <span class="k">in</span> <span class="n">the</span> <span class="n">window</span>
</span><span class='line'>   <span class="o">|</span>    <span class="o">|</span> <span class="o">&lt;</span><span class="n">DTMessageOTOViewController</span> <span class="mh">0x13c830400</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">appeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span> <span class="o">&lt;</span><span class="bp">UIView</span> <span class="mh">0x13d2291f0</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="o">|</span> <span class="o">&lt;</span><span class="n">DTNavigationController</span> <span class="mh">0x13c0e0c00</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">disappeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">UILayoutContainerView</span> <span class="mh">0x13bd66b30</span><span class="o">&gt;</span> <span class="n">not</span> <span class="k">in</span> <span class="n">the</span> <span class="n">window</span>
</span><span class='line'>   <span class="o">|</span>    <span class="o">|</span> <span class="o">&lt;</span><span class="n">DTDingTableViewController</span> <span class="mh">0x13c0b7e00</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">disappeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span>  <span class="p">(</span><span class="n">view</span> <span class="n">not</span> <span class="n">loaded</span><span class="p">)</span>
</span><span class='line'>   <span class="o">|</span> <span class="o">&lt;</span><span class="n">DTNavigationController</span> <span class="mh">0x13c985200</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">disappeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">UILayoutContainerView</span> <span class="mh">0x13be9d110</span><span class="o">&gt;</span> <span class="n">not</span> <span class="k">in</span> <span class="n">the</span> <span class="n">window</span>
</span><span class='line'>   <span class="o">|</span>    <span class="o">|</span> <span class="o">&lt;</span><span class="n">DTWorkViewController</span> <span class="mh">0x13be9ba00</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">disappeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span>  <span class="p">(</span><span class="n">view</span> <span class="n">not</span> <span class="n">loaded</span><span class="p">)</span>
</span><span class='line'>   <span class="o">|</span> <span class="o">&lt;</span><span class="n">DTNavigationController</span> <span class="mh">0x13c0f8c00</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">disappeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">UILayoutContainerView</span> <span class="mh">0x13bd6dae0</span><span class="o">&gt;</span> <span class="n">not</span> <span class="k">in</span> <span class="n">the</span> <span class="n">window</span>
</span><span class='line'>   <span class="o">|</span>    <span class="o">|</span> <span class="o">&lt;</span><span class="n">DTContactViewController</span> <span class="mh">0x13bd6bf80</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">disappeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span> <span class="o">&lt;</span><span class="bp">UIView</span> <span class="mh">0x13d120ee0</span><span class="o">&gt;</span> <span class="n">not</span> <span class="k">in</span> <span class="n">the</span> <span class="n">window</span>
</span><span class='line'>   <span class="o">|</span> <span class="o">&lt;</span><span class="n">DTNavigationController</span> <span class="mh">0x13c104c00</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">disappeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">UILayoutContainerView</span> <span class="mh">0x13bd733c0</span><span class="o">&gt;</span> <span class="n">not</span> <span class="k">in</span> <span class="n">the</span> <span class="n">window</span>
</span><span class='line'>   <span class="o">|</span>    <span class="o">|</span> <span class="o">&lt;</span><span class="n">DTSettingViewController</span> <span class="mh">0x13bd71cc0</span><span class="o">&gt;</span><span class="p">,</span> <span class="nl">state</span><span class="p">:</span> <span class="n">disappeared</span><span class="p">,</span> <span class="nl">view</span><span class="p">:</span>  <span class="p">(</span><span class="n">view</span> <span class="n">not</span> <span class="n">loaded</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到 chisel 不仅把目标控制器 <code>&lt;DTMessageOTOViewController 0x13c830400&gt;</code> 打印出来了，还顺带把当前整个控制器层级都给拉了出来。</p>

<h4>定位接受消息方法</h4>

<p>将消息标为已读的前提是钉钉接收到了该消息，进而可以推测是不是在接收消息后，钉钉发送了已读标志，所以我们先找出接收消息的回调方法。在不知道确切方法的情况下，浏览下下 class-dump 出来的 <code>DTMessageOTOViewController</code> 类信息多少会有收获的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//     Generated by class-dump 3.5 (64 bit).</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">//     class-dump is Copyright (C) 1997-1998, 2000-2001, 2004-2013 by Steve Nygard.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &quot;DTMessageBaseViewController.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#import &quot;DTCEmailTransitionViewDelegate.h&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@class</span> <span class="nc">DTBadgeView</span>, <span class="nc">DTCEmailTransitionView</span>, <span class="nc">DTCMailMode</span>, <span class="nc">DTTypingManager</span>, <span class="bp">NSString</span>, <span class="bp">UIButton</span>;
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">DTMessageOTOViewController</span> : <span class="nc">DTMessageBaseViewController</span> <span class="o">&lt;</span><span class="n">DTCEmailTransitionViewDelegate</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">handleNotificationMessage</span><span class="p">:(</span><span class="kt">id</span><span class="p">)</span><span class="n">arg1</span><span class="p">;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">receivedMessageListNotification:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">arg1</span><span class="p">;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">receivedMessageNotification:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">arg1</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>结合方法命名，我只关注了上方的三个方法。接下来可以逐个测试上面的方法，找出处理消息的回调了。</p>

<p>在 Hopper Disassembler 中， <code>DTMessageOTOViewController</code> 的 <code>handleNotificationMessage:</code> 的方法如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="p">;</span> <span class="o">================</span> <span class="n">B</span> <span class="n">E</span> <span class="n">G</span> <span class="n">I</span> <span class="n">N</span> <span class="n">N</span> <span class="n">I</span> <span class="n">N</span> <span class="n">G</span>   <span class="n">O</span> <span class="n">F</span>   <span class="n">P</span> <span class="n">R</span> <span class="n">O</span> <span class="n">C</span> <span class="n">E</span> <span class="n">D</span> <span class="n">U</span> <span class="n">R</span> <span class="n">E</span> <span class="o">================</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                 <span class="o">-</span><span class="p">[</span><span class="n">DTMessageOTOViewController</span> <span class="nl">handleNotificationMessage</span><span class="p">:]</span><span class="o">:</span>
</span><span class='line'><span class="mo">0000000100466</span><span class="mi">820</span>         <span class="n">stp</span>        <span class="n">x26</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mh">0x50</span><span class="p">]</span><span class="o">!</span>                     <span class="p">;</span> <span class="n">Objective</span> <span class="n">C</span> <span class="n">Implementation</span> <span class="n">defined</span> <span class="n">at</span> <span class="mh">0x1030ddb30</span> <span class="p">(</span><span class="n">instance</span> <span class="n">method</span><span class="p">),</span> <span class="n">DATA</span> <span class="n">XREF</span><span class="o">=</span><span class="mh">0x1030ddb30</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>如上所示，我们可以知道 <code>handleNotificationMessage:</code> 的相对地址是 0x0000000100466820，打开 lldb 进行调试：</p>

<p>1、获取 DingTalk 的 ASLR (地址空间配置随机加载) 偏移量</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">image</span> <span class="n">list</span> <span class="o">-</span><span class="n">o</span> <span class="o">-</span><span class="n">f</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">DingTalk</span>
</span><span class='line'><span class="p">[</span>  <span class="mi">0</span><span class="p">]</span> <span class="mh">0x0000000000004000</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">containers</span><span class="o">/</span><span class="n">Bundle</span><span class="o">/</span><span class="n">Application</span><span class="o">/</span><span class="mi">60</span><span class="n">B29D5D</span><span class="o">-</span><span class="mi">2360</span><span class="o">-</span><span class="mi">4</span><span class="n">C01</span><span class="o">-</span><span class="n">A49F</span><span class="o">-</span><span class="mi">8</span><span class="n">CA87C752EFE</span><span class="o">/</span><span class="n">DingTalk</span><span class="p">.</span><span class="n">app</span><span class="o">/</span><span class="n">DingTalk</span><span class="p">(</span><span class="mh">0x0000000100004000</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>2、设置 <code>handleNotificationMessage:</code> 断点信息。不过在设置前，得先明确下参数和返回值的传递规则。
<br></p>

<p>参数传递规则：前四个参数存放在 R0 - R3 中，剩余的通过栈进行传递。<br>
返回值传递规则：通过 R0 传递给调用者。</p>

<p>众所周知，Objective-C 的方法调用是通过 <code>objc_msgSend</code> 函数实现的，<code>objc_msgSend</code> 定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="kt">id</span> <span class="nf">objc_msgSend</span><span class="p">(</span><span class="kt">id</span> <span class="nb">self</span><span class="p">,</span> <span class="kt">SEL</span>   <span class="n">_cmd</span><span class="p">,...);</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以我们可以通过 R0 / arg0 获取消息接受者， R1 / arg1 获取发送的方法名。综上，可添加断点信息如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">br</span> <span class="n">set</span> <span class="o">-</span><span class="n">a</span> <span class="mh">0x0000000000004000</span><span class="o">+</span><span class="mh">0x0000000100466820</span>
</span><span class='line'><span class="n">Breakpoint</span> <span class="mi">1</span><span class="o">:</span> <span class="n">where</span> <span class="o">=</span> <span class="n">DingTalk</span><span class="err">`</span><span class="n">_mh_execute_header</span> <span class="o">+</span> <span class="mi">4588940</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="mh">0x000000010046a820</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">br</span> <span class="n">command</span> <span class="n">add</span> <span class="mi">1</span>
</span><span class='line'><span class="n">Enter</span> <span class="n">your</span> <span class="n">debugger</span> <span class="n">command</span><span class="p">(</span><span class="n">s</span><span class="p">).</span>  <span class="n">Type</span> <span class="err">&#39;</span><span class="n">DONE</span><span class="err">&#39;</span> <span class="n">to</span> <span class="n">end</span><span class="p">.</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">po</span> <span class="err">$</span><span class="n">x0</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">p</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="err">$</span><span class="n">x1</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">po</span> <span class="err">$</span><span class="n">x2</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">DONE</span>
</span></code></pre></td></tr></table></div></figure>


<p>3、向越狱设备的钉钉发送消息，触发断点</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span>  <span class="n">po</span> <span class="err">$</span><span class="n">x0</span>
</span><span class='line'><span class="o">&lt;</span><span class="nl">DTMessageOTOViewController</span><span class="p">:</span> <span class="mh">0x11e2edc00</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span>  <span class="n">p</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="err">$</span><span class="n">x1</span>
</span><span class='line'><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="err">$</span><span class="mi">2</span> <span class="o">=</span> <span class="mh">0x000000010296e9ba</span> <span class="s">&quot;handleNotificationMessage:&quot;</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span>  <span class="n">po</span> <span class="err">$</span><span class="n">x2</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">__NSArrayM</span> <span class="mh">0x170853e00</span><span class="o">&gt;</span><span class="p">(</span>
</span><span class='line'><span class="n">senderId</span> <span class="o">=</span> <span class="mi">72938616</span>
</span><span class='line'><span class="n">localMid</span> <span class="o">=</span> <span class="p">(</span><span class="n">null</span><span class="p">)</span>
</span><span class='line'><span class="n">mId</span> <span class="o">=</span> <span class="mi">21530513660</span>
</span><span class='line'><span class="n">attachmentsType</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">sendStatus</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">type</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">isDecrypt</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">Process</span> <span class="mi">4918</span> <span class="n">stopped</span>
</span><span class='line'><span class="o">*</span> <span class="kr">thread</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span> <span class="n">tid</span> <span class="o">=</span> <span class="mh">0xd51a3</span><span class="p">,</span> <span class="mh">0x000000010046a820</span> <span class="n">DingTalk</span><span class="err">`</span><span class="n">_mh_execute_header</span> <span class="o">+</span> <span class="mi">4614176</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="mi">709</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">main</span><span class="o">-</span><span class="kr">thread</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">stop</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">breakpoint</span> <span class="mf">1.1</span>
</span><span class='line'>    <span class="n">frame</span> <span class="err">#</span><span class="mi">0</span><span class="o">:</span> <span class="mh">0x000000010046a820</span> <span class="n">DingTalk</span><span class="err">`</span><span class="n">_mh_execute_header</span> <span class="o">+</span> <span class="mi">4614176</span>
</span><span class='line'><span class="n">DingTalk</span><span class="err">`</span><span class="nl">_mh_execute_header</span><span class="p">:</span>
</span><span class='line'><span class="o">-&gt;</span>  <span class="mh">0x10046a820</span> <span class="o">&lt;+</span><span class="mi">4614176</span><span class="o">&gt;:</span> <span class="n">stp</span>    <span class="n">x26</span><span class="p">,</span> <span class="n">x25</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mi">80</span><span class="p">]</span><span class="o">!</span>
</span><span class='line'>    <span class="mh">0x10046a824</span> <span class="o">&lt;+</span><span class="mi">4614180</span><span class="o">&gt;:</span> <span class="n">stp</span>    <span class="n">x24</span><span class="p">,</span> <span class="n">x23</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span><span class="p">]</span>
</span><span class='line'>    <span class="mh">0x10046a828</span> <span class="o">&lt;+</span><span class="mi">4614184</span><span class="o">&gt;:</span> <span class="n">stp</span>    <span class="n">x22</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">32</span><span class="p">]</span>
</span><span class='line'>    <span class="mh">0x10046a82c</span> <span class="o">&lt;+</span><span class="mi">4614188</span><span class="o">&gt;:</span> <span class="n">stp</span>    <span class="n">x20</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">48</span><span class="p">]</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到接收消息后，的确进入了 <code>handleNotificationMessage:</code> 方法。并且通过 LR （保存函数返回地址寄存器），我们可以定位到是 <code>receivedMessageListNotification:</code> 方法调用了 <code>handleNotificationMessage:</code> ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">p</span><span class="o">/</span><span class="n">x</span> <span class="err">$</span><span class="n">lr</span> <span class="o">-</span> <span class="mh">0x0000000000004000</span>
</span><span class='line'><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="err">$</span><span class="mi">6</span> <span class="o">=</span> <span class="mh">0x00000001004667d0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hopper Disassembler ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="p">;</span> <span class="o">================</span> <span class="n">B</span> <span class="n">E</span> <span class="n">G</span> <span class="n">I</span> <span class="n">N</span> <span class="n">N</span> <span class="n">I</span> <span class="n">N</span> <span class="n">G</span>   <span class="n">O</span> <span class="n">F</span>   <span class="n">P</span> <span class="n">R</span> <span class="n">O</span> <span class="n">C</span> <span class="n">E</span> <span class="n">D</span> <span class="n">U</span> <span class="n">R</span> <span class="n">E</span> <span class="o">================</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                 <span class="o">-</span><span class="p">[</span><span class="n">DTMessageOTOViewController</span> <span class="nl">receivedMessageListNotification</span><span class="p">:]</span><span class="o">:</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="mo">00000001004667</span><span class="n">c0</span>         <span class="n">ldr</span>        <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xc58</span><span class="p">]</span>                            <span class="p">;</span> <span class="s">&quot;handleNotificationMessage:&quot;</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="nl">handleNotificationMessage</span><span class="p">:)</span>
</span><span class='line'><span class="mo">00000001004667</span><span class="n">c4</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001004667</span><span class="n">c8</span>         <span class="n">mov</span>        <span class="n">x2</span><span class="p">,</span> <span class="n">x22</span>
</span><span class='line'><span class="mo">00000001004667</span><span class="n">cc</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001004667</span><span class="n">d0</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x22</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>进而，我们可以知道新消息到来时，钉钉会广播 <code>DTPushReceivedMessageListNotification</code> 通知：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">NSConcreteNotification</span> <span class="mh">0x170854430</span> <span class="p">{</span><span class="n">name</span> <span class="o">=</span> <span class="n">DTPushReceivedMessageListNotification</span><span class="p">;</span> <span class="n">object</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nl">DTReconnectedHandler</span><span class="p">:</span> <span class="mh">0x170015990</span><span class="o">&gt;</span><span class="p">;</span> <span class="n">userInfo</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">DTPushReceivedInfoKey</span> <span class="o">=</span>     <span class="p">(</span>
</span><span class='line'>        <span class="s">&quot;senderId = 72938616</span><span class="se">\n</span><span class="s">localMid = (null)</span><span class="se">\n</span><span class="s">mId = 21526791314</span><span class="se">\n</span><span class="s">attachmentsType = 1</span><span class="se">\n</span><span class="s">sendStatus = 0</span><span class="se">\n</span><span class="s">type = 1</span><span class="se">\n</span><span class="s">isDecrypt = 0</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>    <span class="p">);</span>
</span><span class='line'><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure>


<p>4、从反汇编代码中寻找线索</p>

<p>虽然定位到了 <code>handleNotificationMessage:</code> 方法，但最终发现这个方法并没有给我想要的信息，不过它的调用者 <code>receivedMessageListNotification:</code> 方法却提供了一些有用的线索：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="p">;</span> <span class="o">================</span> <span class="n">B</span> <span class="n">E</span> <span class="n">G</span> <span class="n">I</span> <span class="n">N</span> <span class="n">N</span> <span class="n">I</span> <span class="n">N</span> <span class="n">G</span>   <span class="n">O</span> <span class="n">F</span>   <span class="n">P</span> <span class="n">R</span> <span class="n">O</span> <span class="n">C</span> <span class="n">E</span> <span class="n">D</span> <span class="n">U</span> <span class="n">R</span> <span class="n">E</span> <span class="o">================</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                 <span class="o">-</span><span class="p">[</span><span class="n">DTMessageOTOViewController</span> <span class="nl">receivedMessageListNotification</span><span class="p">:]</span><span class="o">:</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="mo">0000000100466754</span>         <span class="n">cbz</span>        <span class="n">x20</span><span class="p">,</span> <span class="n">loc_1004667e0</span>
</span><span class='line'>
</span><span class='line'><span class="mo">000000010046675</span><span class="mi">8</span>         <span class="n">str</span>        <span class="n">x20</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x8</span><span class="p">]</span>
</span><span class='line'><span class="mo">000000010046675</span><span class="n">c</span>         <span class="n">adrp</span>       <span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1035bf000</span>
</span><span class='line'><span class="mo">0000000100466760</span>         <span class="n">ldr</span>        <span class="n">x8</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x5a0</span><span class="p">]</span>                            <span class="p">;</span> <span class="mh">0x1035bf5a0</span><span class="p">,</span><span class="n">__objc_class_DTMessageOTOViewController_class</span>
</span><span class='line'><span class="mo">0000000100466764</span>         <span class="n">str</span>        <span class="n">x8</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x10</span><span class="p">]</span>
</span><span class='line'><span class="mo">000000010046676</span><span class="mi">8</span>         <span class="n">adrp</span>       <span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x103568000</span>                            <span class="p">;</span> <span class="k">@selector</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span>
</span><span class='line'><span class="mo">000000010046676</span><span class="n">c</span>         <span class="n">ldr</span>        <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x378</span><span class="p">]</span>                            <span class="p">;</span> <span class="s">&quot;receivedMessageListNotification:&quot;</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="nl">receivedMessageListNotification</span><span class="p">:)</span>
</span><span class='line'><span class="mo">0000000100466770</span>         <span class="n">add</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x8</span>
</span><span class='line'><span class="mo">0000000100466774</span>         <span class="n">mov</span>        <span class="n">x2</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">000000010046677</span><span class="mi">8</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSendSuper2</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>DTMessageOTOViewController</code> 对象的 <code>receivedMessageListNotification:</code> 方法有效信息并不多，但它在调用 <code>handleNotificationMessage:</code> 方法前，调用了父类的 <code>receivedMessageListNotification:</code> 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'> <span class="p">;</span> <span class="o">================</span> <span class="n">B</span> <span class="n">E</span> <span class="n">G</span> <span class="n">I</span> <span class="n">N</span> <span class="n">N</span> <span class="n">I</span> <span class="n">N</span> <span class="n">G</span>   <span class="n">O</span> <span class="n">F</span>   <span class="n">P</span> <span class="n">R</span> <span class="n">O</span> <span class="n">C</span> <span class="n">E</span> <span class="n">D</span> <span class="n">U</span> <span class="n">R</span> <span class="n">E</span> <span class="o">================</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                     <span class="o">-</span><span class="p">[</span><span class="n">DTMessageBaseViewController</span> <span class="nl">receivedMessageListNotification</span><span class="p">:]</span><span class="o">:</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="n">ldr</span>        <span class="n">x24</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xd58</span><span class="p">]</span> <span class="p">;</span> <span class="s">&quot;dataSource&quot;</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="n">dataSource</span><span class="p">)</span>
</span><span class='line'><span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="n">mov</span>        <span class="n">x1</span><span class="p">,</span> <span class="n">x24</span>
</span><span class='line'><span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="n">mov</span>        <span class="n">x29</span><span class="p">,</span> <span class="n">x29</span>
</span><span class='line'><span class="n">bl</span>         <span class="n">imp___stubs__objc_retainAutoreleasedReturnValue</span>
</span><span class='line'><span class="n">mov</span>        <span class="n">x25</span><span class="p">,</span> <span class="n">x0</span>
</span><span class='line'><span class="n">adrp</span>       <span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x103568000</span> <span class="p">;</span> <span class="k">@selector</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span>
</span><span class='line'><span class="n">ldr</span>        <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xc00</span><span class="p">]</span> <span class="p">;</span> <span class="s">&quot;noRepeatSortMessagesWithNotificationMessageList:&quot;</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="nl">noRepeatSortMessagesWithNotificationMessageList</span><span class="p">:)</span>
</span><span class='line'><span class="n">mov</span>        <span class="n">x2</span><span class="p">,</span> <span class="n">x22</span>
</span><span class='line'><span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="n">adrp</span>       <span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x103568000</span> <span class="p">;</span> <span class="k">@selector</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span>
</span><span class='line'><span class="n">ldr</span>        <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xc10</span><span class="p">]</span> <span class="p">;</span> <span class="s">&quot;dealMessageListWithNoRepeatSortArray:finishBlock:&quot;</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="nl">dealMessageListWithNoRepeatSortArray</span><span class="p">:</span><span class="nl">finishBlock</span><span class="p">:)</span>
</span><span class='line'><span class="n">add</span>        <span class="n">x3</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x8</span>
</span><span class='line'><span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x26</span>
</span><span class='line'><span class="n">mov</span>        <span class="n">x2</span><span class="p">,</span> <span class="n">x25</span>
</span><span class='line'><span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过反汇编代码可以看出，这个 <code>dataSource</code> 先后调用了 <code>noRepeatSortMessagesWithNotificationMessageList:</code> 和 <code>dealMessageListWithNoRepeatSortArray:finishBlock:</code> 方法，会不会在后一个方法发送已读标志呢？在确认之前，我们先看下 <code>dataSource</code> 这个方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@property</span><span class="p">(</span><span class="k">retain</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="n">DTMessageControllerDataSource</span> <span class="o">*</span><span class="n">dataSource</span><span class="p">;</span> <span class="c1">// @synthesize dataSource=_dataSource;</span>
</span></code></pre></td></tr></table></div></figure>


<p>数据源被剥离到一个独立的对象了，这种做法在界面比较复杂的情况中很常见，能有效减少控制器中的代码。那么 <code>DTMessageControllerDataSource</code> 里面会有什么有用的信息么？</p>

<h4>定位发送已读标志方法</h4>

<p>上文说到了 DTMessageControllerDataSource 这个类，这个类定义如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">DTMessageControllerDataSource</span> : <span class="bp">NSObject</span> <span class="o">&lt;</span><span class="n">UIViewControllerPreviewingDelegate</span><span class="p">,</span> <span class="n">DTMessageCollectionViewCellDataSource</span><span class="p">,</span> <span class="n">EGORefreshTableHeaderDelegate</span><span class="p">,</span> <span class="n">DTMessageConllectionViewDataSource</span><span class="p">,</span> <span class="n">DTMessageControllerDataSourceProtocal</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">_Bool</span><span class="p">)</span><span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:(</span><span class="kt">id</span><span class="p">)</span><span class="n">arg1</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nl">sendMessageReadStatusWithMessage</span><span class="p">:(</span><span class="kt">id</span><span class="p">)</span><span class="n">arg1</span><span class="p">;</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>结合命名方法，我注意到了上面两个方法。和上文步骤一样，我先使用 lldb 调试了 <code>needSendReadStatusInCellForRowWithMessage:</code> 方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'>    <span class="p">;</span> <span class="o">================</span> <span class="n">B</span> <span class="n">E</span> <span class="n">G</span> <span class="n">I</span> <span class="n">N</span> <span class="n">N</span> <span class="n">I</span> <span class="n">N</span> <span class="n">G</span>   <span class="n">O</span> <span class="n">F</span>   <span class="n">P</span> <span class="n">R</span> <span class="n">O</span> <span class="n">C</span> <span class="n">E</span> <span class="n">D</span> <span class="n">U</span> <span class="n">R</span> <span class="n">E</span> <span class="o">================</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>                 <span class="o">-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">:</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a070c</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0710</span>         <span class="n">ldp</span>        <span class="n">x29</span><span class="p">,</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x20</span><span class="p">]</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0714</span>         <span class="n">ldp</span>        <span class="n">x20</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x10</span><span class="p">]</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0718</span>         <span class="n">ldp</span>        <span class="n">x22</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span><span class="o">!</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x30</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a071c</span>         <span class="n">ret</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>不过这次因为要改变返回值，我直接把断点打在了 <code>0x00000001001a070c</code> 这个地方：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">Process</span> <span class="mi">4961</span> <span class="n">stopped</span>
</span><span class='line'><span class="o">*</span> <span class="kr">thread</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span> <span class="n">tid</span> <span class="o">=</span> <span class="mh">0xdc358</span><span class="p">,</span> <span class="mh">0x00000001001d070c</span> <span class="n">DingTalk</span><span class="err">`</span><span class="n">_mh_execute_header</span> <span class="o">+</span> <span class="mi">1705740</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="mi">137</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">main</span><span class="o">-</span><span class="kr">thread</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">stop</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">instruction</span> <span class="n">step</span> <span class="n">over</span>
</span><span class='line'>    <span class="n">frame</span> <span class="err">#</span><span class="mi">0</span><span class="o">:</span> <span class="mh">0x00000001001d070c</span> <span class="n">DingTalk</span><span class="err">`</span><span class="n">_mh_execute_header</span> <span class="o">+</span> <span class="mi">1705740</span>
</span><span class='line'><span class="n">DingTalk</span><span class="err">`</span><span class="nl">_mh_execute_header</span><span class="p">:</span>
</span><span class='line'><span class="o">-&gt;</span>  <span class="mh">0x1001d070c</span> <span class="o">&lt;+</span><span class="mi">1705740</span><span class="o">&gt;:</span> <span class="n">mov</span>    <span class="n">x0</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'>    <span class="mh">0x1001d0710</span> <span class="o">&lt;+</span><span class="mi">1705744</span><span class="o">&gt;:</span> <span class="n">ldp</span>    <span class="n">x29</span><span class="p">,</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">32</span><span class="p">]</span>
</span><span class='line'>    <span class="mh">0x1001d0714</span> <span class="o">&lt;+</span><span class="mi">1705748</span><span class="o">&gt;:</span> <span class="n">ldp</span>    <span class="n">x20</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span><span class="p">]</span>
</span><span class='line'>    <span class="mh">0x1001d0718</span> <span class="o">&lt;+</span><span class="mi">1705752</span><span class="o">&gt;:</span> <span class="n">ldp</span>    <span class="n">x22</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">],</span> <span class="err">#</span><span class="mi">48</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">ni</span>
</span><span class='line'><span class="n">Process</span> <span class="mi">4961</span> <span class="n">stopped</span>
</span><span class='line'><span class="o">*</span> <span class="kr">thread</span> <span class="err">#</span><span class="mi">1</span><span class="o">:</span> <span class="n">tid</span> <span class="o">=</span> <span class="mh">0xdc358</span><span class="p">,</span> <span class="mh">0x00000001001d0710</span> <span class="n">DingTalk</span><span class="err">`</span><span class="n">_mh_execute_header</span> <span class="o">+</span> <span class="mi">1705744</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="err">&#39;</span><span class="mi">137</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="err">&#39;</span><span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">main</span><span class="o">-</span><span class="kr">thread</span><span class="err">&#39;</span><span class="p">,</span> <span class="n">stop</span> <span class="n">reason</span> <span class="o">=</span> <span class="n">instruction</span> <span class="n">step</span> <span class="n">over</span>
</span><span class='line'>    <span class="n">frame</span> <span class="err">#</span><span class="mi">0</span><span class="o">:</span> <span class="mh">0x00000001001d0710</span> <span class="n">DingTalk</span><span class="err">`</span><span class="n">_mh_execute_header</span> <span class="o">+</span> <span class="mi">1705744</span>
</span><span class='line'><span class="n">DingTalk</span><span class="err">`</span><span class="nl">_mh_execute_header</span><span class="p">:</span>
</span><span class='line'><span class="o">-&gt;</span>  <span class="mh">0x1001d0710</span> <span class="o">&lt;+</span><span class="mi">1705744</span><span class="o">&gt;:</span> <span class="n">ldp</span>    <span class="n">x29</span><span class="p">,</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">32</span><span class="p">]</span>
</span><span class='line'>    <span class="mh">0x1001d0714</span> <span class="o">&lt;+</span><span class="mi">1705748</span><span class="o">&gt;:</span> <span class="n">ldp</span>    <span class="n">x20</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mi">16</span><span class="p">]</span>
</span><span class='line'>    <span class="mh">0x1001d0718</span> <span class="o">&lt;+</span><span class="mi">1705752</span><span class="o">&gt;:</span> <span class="n">ldp</span>    <span class="n">x22</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">],</span> <span class="err">#</span><span class="mi">48</span>
</span><span class='line'>    <span class="mh">0x1001d071c</span> <span class="o">&lt;+</span><span class="mi">1705756</span><span class="o">&gt;:</span> <span class="n">ret</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">p</span> <span class="err">$</span><span class="n">x0</span>
</span><span class='line'><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="err">$</span><span class="mi">6</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="k">register</span> <span class="n">write</span> <span class="err">$</span><span class="n">x0</span> <span class="mi">0</span>
</span><span class='line'><span class="p">(</span><span class="n">lldb</span><span class="p">)</span> <span class="n">c</span>
</span></code></pre></td></tr></table></div></figure>


<p>改写 R0 (返回值) 为 0 并让进程继续运行后，消息发送方的已读标志果然没有出现，始终是处于未读状态，而接收方也看到了这条消息。那么 <code>needSendUnreadStatusWithMessage:</code> 方法是如何判断该返回YES或NO呢？除去了部分对结果不产生影响的分支后，其汇编代码如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="mo">00000001001</span><span class="n">a05c8</span>         <span class="n">stp</span>        <span class="n">x22</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="o">-</span><span class="mh">0x30</span><span class="p">]</span><span class="o">!</span>                     <span class="p">;</span> <span class="n">Objective</span> <span class="n">C</span> <span class="n">Implementation</span> <span class="n">defined</span> <span class="n">at</span> <span class="mh">0x103088d78</span> <span class="p">(</span><span class="n">instance</span> <span class="n">method</span><span class="p">),</span> <span class="n">DATA</span> <span class="n">XREF</span><span class="o">=</span><span class="mh">0x103088d78</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05cc</span>         <span class="n">stp</span>        <span class="n">x20</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x10</span><span class="p">]</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05d0</span>         <span class="n">stp</span>        <span class="n">x29</span><span class="p">,</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x20</span><span class="p">]</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05d4</span>         <span class="n">add</span>        <span class="n">x29</span><span class="p">,</span> <span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05d8</span>         <span class="n">mov</span>        <span class="n">x20</span><span class="p">,</span> <span class="n">x0</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05dc</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x2</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05e0</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_retain</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05e4</span>         <span class="n">mov</span>        <span class="n">x19</span><span class="p">,</span> <span class="n">x0</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05e8</span>         <span class="n">adrp</span>       <span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x10355d000</span>                            <span class="p">;</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">filteredImageUsingContrastFilterOnImage</span><span class="p">:)</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05ec</span>         <span class="n">ldr</span>        <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x4b0</span><span class="p">]</span>                            <span class="p">;</span> <span class="s">&quot;collectionView&quot;</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="n">collectionView</span><span class="p">)</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05f0</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05f4</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05f8</span>         <span class="n">mov</span>        <span class="n">x29</span><span class="p">,</span> <span class="n">x29</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a05fc</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_retainAutoreleasedReturnValue</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0600</span>         <span class="n">mov</span>        <span class="n">x20</span><span class="p">,</span> <span class="n">x0</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0604</span>         <span class="n">adrp</span>       <span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x103559000</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0608</span>         <span class="n">ldr</span>        <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xd58</span><span class="p">]</span>                            <span class="p">;</span> <span class="s">&quot;dataSource&quot;</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="n">dataSource</span><span class="p">)</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a060c</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0610</span>         <span class="n">mov</span>        <span class="n">x29</span><span class="p">,</span> <span class="n">x29</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0614</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_retainAutoreleasedReturnValue</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0618</span>         <span class="n">mov</span>        <span class="n">x21</span><span class="p">,</span> <span class="n">x0</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a061c</span>         <span class="n">adrp</span>       <span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x103563000</span>                            <span class="p">;</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">updateConversationClientExtension</span><span class="p">:</span><span class="nl">message</span><span class="p">:</span><span class="nl">wkBizConversation</span><span class="p">:</span><span class="nl">needSaveToDB</span><span class="p">:)</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0620</span>         <span class="n">ldr</span>        <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x660</span><span class="p">]</span>                            <span class="p">;</span> <span class="s">&quot;needSendUnreadStatusWithMessage:&quot;</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="nl">needSendUnreadStatusWithMessage</span><span class="p">:)</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0624</span>         <span class="n">mov</span>        <span class="n">x2</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0628</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a062c</span>         <span class="n">mov</span>        <span class="n">x22</span><span class="p">,</span> <span class="n">x0</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0630</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x21</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0634</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_release</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0638</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a063c</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_release</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0640</span>         <span class="n">cbz</span>        <span class="n">w22</span><span class="p">,</span> <span class="n">loc_1001a0700</span>
</span><span class='line'>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0644</span>         <span class="n">adrp</span>       <span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x10355b000</span>                            <span class="p">;</span> <span class="k">@selector</span><span class="p">(</span><span class="n">DT_S13_normal</span><span class="p">)</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0648</span>         <span class="n">ldr</span>        <span class="n">x20</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x740</span><span class="p">]</span>                           <span class="p">;</span> <span class="s">&quot;attachmentsType&quot;</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="n">attachmentsType</span><span class="p">)</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a064c</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0650</span>         <span class="n">mov</span>        <span class="n">x1</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0654</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0658</span>         <span class="n">cmp</span>        <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x67</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a065c</span>         <span class="n">b</span><span class="p">.</span><span class="n">eq</span>       <span class="n">loc_1001a0700</span>
</span><span class='line'>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0660</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0664</span>         <span class="n">mov</span>        <span class="n">x1</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0668</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a066c</span>         <span class="n">cmp</span>        <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xca</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0670</span>         <span class="n">b</span><span class="p">.</span><span class="n">eq</span>       <span class="n">loc_1001a0700</span>
</span><span class='line'>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0674</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0678</span>         <span class="n">mov</span>        <span class="n">x1</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a067c</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0680</span>         <span class="n">cmp</span>        <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x4</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0684</span>         <span class="n">b</span><span class="p">.</span><span class="n">eq</span>       <span class="n">loc_1001a0700</span>
</span><span class='line'>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0688</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a068c</span>         <span class="n">mov</span>        <span class="n">x1</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0690</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0694</span>         <span class="n">cmp</span>        <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x2</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0698</span>         <span class="n">b</span><span class="p">.</span><span class="n">eq</span>       <span class="n">loc_1001a0700</span>
</span><span class='line'>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a069c</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06a0</span>         <span class="n">mov</span>        <span class="n">x1</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06a4</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06a8</span>         <span class="n">cmp</span>        <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x66</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06ac</span>         <span class="n">b</span><span class="p">.</span><span class="n">eq</span>       <span class="n">loc_1001a0700</span>
</span><span class='line'>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06b0</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06b4</span>         <span class="n">mov</span>        <span class="n">x1</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06b8</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06bc</span>         <span class="n">cmp</span>        <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x10</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06c0</span>         <span class="n">b</span><span class="p">.</span><span class="n">eq</span>       <span class="n">loc_1001a0700</span>
</span><span class='line'>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06c4</span>         <span class="n">adrp</span>       <span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x103563000</span>                            <span class="p">;</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">updateConversationClientExtension</span><span class="p">:</span><span class="nl">message</span><span class="p">:</span><span class="nl">wkBizConversation</span><span class="p">:</span><span class="nl">needSaveToDB</span><span class="p">:)</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06c8</span>         <span class="n">ldr</span>        <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x640</span><span class="p">]</span>                            <span class="p">;</span> <span class="s">&quot;isMsgNeedShowFullWidth&quot;</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="n">isMsgNeedShowFullWidth</span><span class="p">)</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06cc</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06d0</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06d4</span>         <span class="n">tbnz</span>       <span class="n">w0</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="n">loc_1001a0700</span>
</span><span class='line'>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06d8</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06dc</span>         <span class="n">mov</span>        <span class="n">x1</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06e0</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06e4</span>         <span class="n">cmp</span>        <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1f4</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06e8</span>         <span class="n">b</span><span class="p">.</span><span class="n">eq</span>       <span class="n">loc_1001a0700</span>
</span><span class='line'>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06ec</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06f0</span>         <span class="n">mov</span>        <span class="n">x1</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06f4</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06f8</span>         <span class="n">cmp</span>        <span class="n">x0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1f5</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a06fc</span>         <span class="n">b</span><span class="p">.</span><span class="n">ne</span>       <span class="n">loc_1001a0720</span>
</span><span class='line'>
</span><span class='line'>                     <span class="nl">loc_1001a0700</span><span class="p">:</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0700</span>         <span class="n">movz</span>       <span class="n">w20</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x0</span>                                   <span class="p">;</span> <span class="n">CODE</span> <span class="n">XREF</span><span class="o">=-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">+</span><span class="mi">120</span><span class="p">,</span> <span class="o">-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">+</span><span class="mi">148</span><span class="p">,</span> <span class="o">-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">+</span><span class="mi">168</span><span class="p">,</span> <span class="o">-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">+</span><span class="mi">188</span><span class="p">,</span> <span class="o">-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">+</span><span class="mi">208</span><span class="p">,</span> <span class="o">-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">+</span><span class="mi">228</span><span class="p">,</span> <span class="o">-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">+</span><span class="mi">248</span><span class="p">,</span> <span class="o">-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">+</span><span class="mi">268</span><span class="p">,</span> <span class="o">-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">+</span><span class="mi">288</span>
</span><span class='line'>
</span><span class='line'>                     <span class="nl">loc_1001a0704</span><span class="p">:</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0704</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x19</span>                                     <span class="p">;</span> <span class="n">CODE</span> <span class="n">XREF</span><span class="o">=-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">+</span><span class="mi">372</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0708</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_release</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a070c</span>         <span class="n">mov</span>        <span class="n">x0</span><span class="p">,</span> <span class="n">x20</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0710</span>         <span class="n">ldp</span>        <span class="n">x29</span><span class="p">,</span> <span class="n">x30</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x20</span><span class="p">]</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0714</span>         <span class="n">ldp</span>        <span class="n">x20</span><span class="p">,</span> <span class="n">x19</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x10</span><span class="p">]</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0718</span>         <span class="n">ldp</span>        <span class="n">x22</span><span class="p">,</span> <span class="n">x21</span><span class="p">,</span> <span class="p">[</span><span class="n">sp</span><span class="p">]</span><span class="o">!</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x30</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a071c</span>         <span class="n">ret</span>
</span><span class='line'>                        <span class="p">;</span> <span class="n">endp</span>
</span><span class='line'>
</span><span class='line'>                     <span class="nl">loc_1001a0720</span><span class="p">:</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0720</span>         <span class="n">adrp</span>       <span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1035b5000</span>                            <span class="p">;</span> <span class="n">CODE</span> <span class="n">XREF</span><span class="o">=-</span><span class="p">[</span><span class="n">DTMessageControllerDataSource</span> <span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:]</span><span class="o">+</span><span class="mi">308</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0724</span>         <span class="n">ldr</span>        <span class="n">x0</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0xdd0</span><span class="p">]</span>                            <span class="p">;</span> <span class="n">objc_cls_ref_DTMessageServiceV2</span><span class="p">,</span><span class="n">__objc_class_DTMessageServiceV2_class</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0728</span>         <span class="n">adrp</span>       <span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x103563000</span>                            <span class="p">;</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">updateConversationClientExtension</span><span class="p">:</span><span class="nl">message</span><span class="p">:</span><span class="nl">wkBizConversation</span><span class="p">:</span><span class="nl">needSaveToDB</span><span class="p">:)</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a072c</span>         <span class="n">ldr</span>        <span class="n">x1</span><span class="p">,</span> <span class="p">[</span><span class="n">x8</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x668</span><span class="p">]</span>                            <span class="p">;</span> <span class="s">&quot;isEncryptSpaceType:&quot;</span><span class="p">,</span><span class="k">@selector</span><span class="p">(</span><span class="nl">isEncryptSpaceType</span><span class="p">:)</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0730</span>         <span class="n">mov</span>        <span class="n">x2</span><span class="p">,</span> <span class="n">x19</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0734</span>         <span class="n">bl</span>         <span class="n">imp___stubs__objc_msgSend</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a0738</span>         <span class="n">eor</span>        <span class="n">w20</span><span class="p">,</span> <span class="n">w0</span><span class="p">,</span> <span class="err">#</span><span class="mh">0x1</span>
</span><span class='line'><span class="mo">00000001001</span><span class="n">a073c</span>         <span class="n">b</span>          <span class="n">loc_1001a0704</span>
</span></code></pre></td></tr></table></div></figure>


<p>整理一下，可以用以下 Objective-C 代码进行表示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">needSendUnreadStatusWithMessage:</span><span class="p">(</span><span class="n">DTBizMessage</span> <span class="o">*</span><span class="p">)</span><span class="nv">message</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">message</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">message</span><span class="p">.</span><span class="n">creatorType</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">message</span><span class="p">.</span><span class="n">isMine</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">message</span><span class="p">.</span><span class="n">readStatus</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>既然知道了这块的代码逻辑，改变其行为也就不在话下了。</p>

<h4>编写安装 Tweak</h4>

<p>1、创建一个 Tweak 工程模版：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">➜</span>  <span class="n">DingTalk</span> <span class="n">nic</span><span class="p">.</span><span class="n">pl</span>
</span><span class='line'><span class="n">NIC</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">New</span> <span class="n">Instance</span> <span class="n">Creator</span>
</span><span class='line'><span class="o">------------------------------</span>
</span><span class='line'>  <span class="p">[</span><span class="mf">1.</span><span class="p">]</span> <span class="n">iphone</span><span class="o">/</span><span class="n">activator_event</span>
</span><span class='line'>  <span class="p">[</span><span class="mf">2.</span><span class="p">]</span> <span class="n">iphone</span><span class="o">/</span><span class="n">activator_event</span>
</span><span class='line'>  <span class="p">[</span><span class="mf">3.</span><span class="p">]</span> <span class="n">iphone</span><span class="o">/</span><span class="n">activator_listener</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="p">[</span><span class="mf">26.</span><span class="p">]</span> <span class="n">iphone</span><span class="o">/</span><span class="n">tweak</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'><span class="n">Choose</span> <span class="n">a</span> <span class="n">Template</span> <span class="p">(</span><span class="n">required</span><span class="p">)</span><span class="o">:</span> <span class="mi">26</span>
</span><span class='line'><span class="n">Project</span> <span class="n">Name</span> <span class="p">(</span><span class="n">required</span><span class="p">)</span><span class="o">:</span> <span class="n">DingTalkRecallBarrier</span>
</span><span class='line'><span class="n">Package</span> <span class="n">Name</span> <span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">yourcompany</span><span class="p">.</span><span class="n">dingtalkrecallbarrier</span><span class="p">]</span><span class="o">:</span> <span class="n">com</span><span class="p">.</span><span class="n">tripleCC</span><span class="p">.</span><span class="n">dingtalkrecallbarrier</span>
</span><span class='line'><span class="n">Author</span><span class="o">/</span><span class="n">Maintainer</span> <span class="n">Name</span> <span class="p">[</span><span class="n">tripleCC</span><span class="p">]</span><span class="o">:</span> <span class="n">tripleCC</span>
</span><span class='line'><span class="p">[</span><span class="n">iphone</span><span class="o">/</span><span class="n">tweak</span><span class="p">]</span> <span class="n">MobileSubstrate</span> <span class="n">Bundle</span> <span class="n">filter</span> <span class="p">[</span><span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">springboard</span><span class="p">]</span><span class="o">:</span> <span class="n">com</span><span class="p">.</span><span class="n">laiwang</span><span class="p">.</span><span class="n">DingTalk</span>
</span><span class='line'><span class="p">[</span><span class="n">iphone</span><span class="o">/</span><span class="n">tweak</span><span class="p">]</span> <span class="n">List</span> <span class="n">of</span> <span class="n">applications</span> <span class="n">to</span> <span class="n">terminate</span> <span class="n">upon</span> <span class="n">installation</span> <span class="p">(</span><span class="n">space</span><span class="o">-</span><span class="n">separated</span><span class="p">,</span> <span class="sc">&#39;-&#39;</span> <span class="k">for</span> <span class="n">none</span><span class="p">)</span> <span class="p">[</span><span class="n">SpringBoard</span><span class="p">]</span><span class="o">:</span> <span class="n">DingTalk</span>
</span><span class='line'><span class="n">Instantiating</span> <span class="n">iphone</span><span class="o">/</span><span class="n">tweak</span> <span class="k">in</span> <span class="n">dingtalkrecallbarrier</span><span class="o">/</span><span class="p">...</span>
</span><span class='line'><span class="n">Done</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>2、编写 Tweak.m 和 Makefile 文件了：</p>

<p>Tweak.m：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="o">%</span><span class="n">hook</span> <span class="n">DTMessageControllerDataSource</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nl">needSendReadStatusInCellForRowWithMessage</span><span class="p">:(</span><span class="kt">id</span><span class="p">)</span><span class="n">arg1</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">%</span><span class="n">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Makefile：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">ARCHS</span> <span class="o">=</span> <span class="n">arm64</span>
</span><span class='line'><span class="n">TARGET</span> <span class="o">=</span> <span class="nl">iphone</span><span class="p">:</span><span class="nl">latest</span><span class="p">:</span><span class="mf">8.0</span>
</span><span class='line'><span class="n">include</span> <span class="err">$</span><span class="p">(</span><span class="n">THEOS</span><span class="p">)</span><span class="o">/</span><span class="n">makefiles</span><span class="o">/</span><span class="n">common</span><span class="p">.</span><span class="n">mk</span>
</span><span class='line'>
</span><span class='line'><span class="n">TWEAK_NAME</span> <span class="o">=</span> <span class="n">DingTalkRecallBarrier</span>
</span><span class='line'><span class="n">DingTalkRecallBarrier_FILES</span> <span class="o">=</span> <span class="n">Tweak</span><span class="p">.</span><span class="n">xm</span>
</span><span class='line'>
</span><span class='line'><span class="n">include</span> <span class="err">$</span><span class="p">(</span><span class="n">THEOS_MAKE_PATH</span><span class="p">)</span><span class="o">/</span><span class="n">tweak</span><span class="p">.</span><span class="n">mk</span>
</span><span class='line'>
</span><span class='line'><span class="n">after</span><span class="o">-</span><span class="n">install</span><span class="o">::</span>
</span><span class='line'>        <span class="n">install</span><span class="p">.</span><span class="n">exec</span> <span class="s">&quot;killall -9 DingTalk&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的 <code>needSendReadStatusInCellForRowWithMessage:</code> 直接返回 NO ，因为即使不执行原来的方法，也不会影响 App 的正常运行。</p>

<p>3、将 Tweak 编译打包安装到越狱设备上：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="err">➜</span>  <span class="n">dingtalkrecallbarrier</span> <span class="n">export</span> <span class="n">THEOS_DEVICE_IP</span><span class="o">=</span><span class="n">localhost</span>
</span><span class='line'><span class="err">➜</span>  <span class="n">dingtalkrecallbarrier</span> <span class="n">export</span> <span class="n">THEOS_DEVICE_PORT</span><span class="o">=</span><span class="mi">2223</span>
</span><span class='line'><span class="err">➜</span>  <span class="n">dingtalkrecallbarrier</span> <span class="n">make</span> <span class="n">package</span> <span class="n">install</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">Making</span> <span class="n">all</span> <span class="k">for</span> <span class="n">tweak</span> <span class="n">DingTalkRecallBarrier</span><span class="err">…</span>
</span><span class='line'><span class="n">make</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">:</span> <span class="n">Nothing</span> <span class="n">to</span> <span class="n">be</span> <span class="n">done</span> <span class="k">for</span> <span class="err">`</span><span class="n">internal</span><span class="o">-</span><span class="n">library</span><span class="o">-</span><span class="n">compile</span><span class="err">&#39;</span><span class="p">.</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">Making</span> <span class="n">stage</span> <span class="k">for</span> <span class="n">tweak</span> <span class="n">DingTalkRecallBarrier</span><span class="err">…</span>
</span><span class='line'><span class="cp">#Filter plist</span>
</span><span class='line'><span class="cp">#PreferenceLoader plist</span>
</span><span class='line'><span class="n">dm</span><span class="p">.</span><span class="nl">pl</span><span class="p">:</span> <span class="n">building</span> <span class="n">package</span> <span class="err">`</span><span class="n">com</span><span class="p">.</span><span class="n">triplecc</span><span class="p">.</span><span class="nl">dingtalkrecallbarrier</span><span class="p">:</span><span class="n">iphoneos</span><span class="o">-</span><span class="n">arm</span><span class="err">&#39;</span> <span class="k">in</span> <span class="err">`</span><span class="p">.</span><span class="o">/</span><span class="n">packages</span><span class="o">/</span><span class="n">com</span><span class="p">.</span><span class="n">triplecc</span><span class="p">.</span><span class="n">dingtalkrecallbarrier_0</span><span class="mf">.0.1</span><span class="o">-</span><span class="mi">13</span><span class="o">+</span><span class="n">debug_iphoneos</span><span class="o">-</span><span class="n">arm</span><span class="p">.</span><span class="n">deb</span><span class="err">&#39;</span>
</span><span class='line'><span class="o">==&gt;</span> <span class="n">Installing</span><span class="err">…</span>
</span><span class='line'><span class="n">Selecting</span> <span class="n">previously</span> <span class="n">unselected</span> <span class="n">package</span> <span class="n">com</span><span class="p">.</span><span class="n">triplecc</span><span class="p">.</span><span class="n">dingtalkrecallbarrier</span><span class="p">.</span>
</span><span class='line'><span class="p">(</span><span class="n">Reading</span> <span class="n">database</span> <span class="p">...</span> <span class="mi">1230</span> <span class="n">files</span> <span class="n">and</span> <span class="n">directories</span> <span class="n">currently</span> <span class="n">installed</span><span class="p">.)</span>
</span><span class='line'><span class="n">Preparing</span> <span class="n">to</span> <span class="n">unpack</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">_theos_install</span><span class="p">.</span><span class="n">deb</span> <span class="p">...</span>
</span><span class='line'><span class="n">Unpacking</span> <span class="n">com</span><span class="p">.</span><span class="n">triplecc</span><span class="p">.</span><span class="n">dingtalkrecallbarrier</span> <span class="p">(</span><span class="mf">0.0.1</span><span class="o">-</span><span class="mi">13</span><span class="o">+</span><span class="n">debug</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'><span class="n">Setting</span> <span class="n">up</span> <span class="n">com</span><span class="p">.</span><span class="n">triplecc</span><span class="p">.</span><span class="n">dingtalkrecallbarrier</span> <span class="p">(</span><span class="mf">0.0.1</span><span class="o">-</span><span class="mi">13</span><span class="o">+</span><span class="n">debug</span><span class="p">)</span> <span class="p">...</span>
</span><span class='line'><span class="n">install</span><span class="p">.</span><span class="n">exec</span> <span class="s">&quot;killall -9 DingTalk&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>小结</h2>

<p>第一次逆向实践，虽说编写的 Tweak 代码才几行，但其定位过程却是一波三折，可能因为经验不足导致定位不准确吧，不过逆向需要很好的耐心倒不假。因为以前做过即时通讯，所以对钉钉消息收发流程多少还是会有点自己的理解，这无形中也推进了我逆向的进度。</p>

<p>最后，这次逆向让我时隔三年之后，再一次有机会利用终端调试程序，还记得以前是做 Linux 应用程序时在嵌入式设备中使用 gdb 进行调试。决定以后在 Xcode 中也要多用命令行进行调试了，实在是舒畅。</p>

<h2>参考</h2>

<p><a href="https://book.douban.com/subject/26363333/">iOS应用逆向工程</a><br>
<a href="http://www.swiftyper.com/2017/02/15/dingtalk-fake-gps/">iOS 逆向实战 - 钉钉签到远程“打卡”</a><br>
<a href="http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.dui0802b/CSET_CSINC.html">ARM 64 常用汇编指令</a><br>
<a href="https://lldb.llvm.org/tutorial.html">The LLDB Debugger Tutorial</a><br></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">tripleCC</span></span>

      




<time class='entry-date' datetime='2017-05-13T16:54:37+08:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>4:54 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017-04-28-gei-apptian-jia-xuan-fu-zhu-shou/" title="Previous Post: 给 APP 添加悬浮助手">&laquo; 给 APP 添加悬浮助手</a>
      
      
        <a class="basic-alignment right" href="/blog/2017-06-08-cocoapodshe-localization/" title="Next Post: CocoaPods和Localization">CocoaPods和Localization &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>关于我</h1>
  <p> 曾经的嵌入式软件开发者，现已皈依苹果大法门下。目前混迹杭州，喜欢没事就去西湖浪荡。轻微完美主义者，跑步爱好者。 </p>
  <a href="http://www.jianshu.com/users/97e39e95c2cc"> 我的简书 </a><br>
  <a href="https://github.com/tripleCC"> 我的GitHub </a><br>
  <a href="https://twitter.com/tripleCCBrian"> 我的Twitter </a>
</section>
<section>
  <h1>最近发布</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017-07-04-objective-c/">Objective-C</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-06-23-ru-he-kuai-su-da-jian-biao-dan-jie-mian/">闲谈 IGListKit</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-06-08-cocoapodshe-localization/">CocoaPods和Localization</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-05-13-wan-wan-ni-xiang-zhi-lan-jie-ding-ding-xin-xi-de-yi-du-zhuang-tai/">玩玩逆向之拦截钉钉消息已读状态</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-04-28-gei-apptian-jia-xuan-fu-zhu-shou/">给 APP 添加悬浮助手</a>
      </li>
    
  </ul>
</section>




<section>
    <h1>友情链接</h1>
    <ul>
        <li>
            <a href="http://wxgbridgeq.github.io/">小乔的个人学习博客</a>
        </li>
        <li>
        	<a href="http://www.swiftyper.com/">Swiftyper-小锅</a>
        </li>
    </ul>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - tripleCC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'tripleCC';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://triplecc.github.io/blog/2017-05-13-wan-wan-ni-xiang-zhi-lan-jie-ding-ding-xin-xi-de-yi-du-zhuang-tai/';
        var disqus_url = 'http://triplecc.github.io/blog/2017-05-13-wan-wan-ni-xiang-zhi-lan-jie-ding-ding-xin-xi-de-yi-du-zhuang-tai/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
