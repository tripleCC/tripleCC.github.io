
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>使用AssetsLibrary和PhotoKit做一个简易的相片选择器 - tripleCC的技术博客</title>
  <meta name="author" content="tripleCC">

  
  <meta name="description" content="iOS8之后，苹果推出了PhotoKit，让开发者在处理相册相关的业务时，可以更加得心应手。github上的开发者针对PhotoKit做了一层很优秀的封装CTAssetsPickerController，如果只需要支持iOS8+， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="/atom.xml" rel="alternate" title="tripleCC的技术博客" type="application/atom+xml">
  
  <link rel="canonical" href="http://triplecc.github.io/blog/2016-09-10-shi-yong-assetslibraryhe-photokitzuo-%5B%3F%5D-ge-xiang-pian-xuan-ze-qi/">
  <link href="/favicon.png" rel="shortcut icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--[good job! gfw]><script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script><!-->
  <script src="http://cdn.staticfile.org/jquery/1.9.1/jquery.min.js"></script>
  <link href="/stylesheets/google-fonts.css" rel="stylesheet" type="text/css">
  

  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">tripleCC的技术博客</a></h1>
  
    <h2>ʕ•̫͡•ʔ-̫͡-ʕ•͓͡•ʔ-̫͡-ʕ•̫͡•ʔ-̫͡-ʕ•͓͡•ʔ-̫͡-ʔ</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="triplecc.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">使用AssetsLibrary和PhotoKit做一个简易的相片选择器</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-09-10T21:25:36+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:25 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>iOS8之后，苹果推出了PhotoKit，让开发者在处理相册相关的业务时，可以更加得心应手。github上的开发者针对PhotoKit做了一层很优秀的封装<a href="https://github.com/chiunam/CTAssetsPickerController">CTAssetsPickerController</a>，如果只需要支持iOS8+，那么可定制程度非常高的<a href="https://github.com/chiunam/CTAssetsPickerController">CTAssetsPickerController</a>是个不错的选择。<br>
但是由于现有的业务还是需要支持iOS7，所以并不能完全舍弃使用<code>AssetsLibrary</code>的方式来访问相册。因此也就需要自己封装一套兼容iOS7的相册管理器。</p>

<p>本文涉及代码：<a href="https://github.com/tobevoid/TBVAssetsPicker">TBVAssetsPicker</a></p>

<!--more-->


<h3>统一asset以及collection</h3>

<table>
<thead>
<tr>
<th style="text-align:left;"> AssetsLibrary </th>
<th style="text-align:left;"> PhotoKit </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;"> ALAssetsGroup </td>
<td style="text-align:left;"> PHAssetCollection </td>
</tr>
<tr>
<td style="text-align:left;"> ALAsset </td>
<td style="text-align:left;"> PHAsset </td>
</tr>
<tr>
<td style="text-align:left;"> TBVAsset </td>
<td style="text-align:left;"> TBVCollection </td>
</tr>
</tbody>
</table>


<p>相片选择器最终需要向外部提供统一的标识相片的结构。同样，统一结构能让相片选择器更加优雅地实现内部逻辑。所以这里我声明了两个对应的类：<code>TBVAsset</code>、<code>TBVCollection</code>，并提供一些最基本的功能。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">TBVAsset</span> : <span class="bp">NSObject</span>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> *  PHAsset or ALAsset</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="bp">NSObject</span>  <span class="o">*</span><span class="n">asset</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">assetWithOriginAsset:</span><span class="p">(</span><span class="bp">NSObject</span> <span class="o">*</span><span class="p">)</span><span class="nv">asset</span><span class="p">;</span>
</span><span class='line'><span class="cm">/** 本地标识 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">assetLocalIdentifer</span><span class="p">;</span>
</span><span class='line'><span class="cm">/** 源照片尺寸 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">CGSize</span><span class="p">)</span><span class="nf">assetPixelSize</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">TBVCollection</span> : <span class="bp">NSObject</span>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> *  ALAssetsGroup or PHAssetCollection</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="bp">NSObject</span>  <span class="o">*</span><span class="n">collection</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">collectionWithOriginCollection:</span><span class="p">(</span><span class="bp">NSObject</span> <span class="o">*</span><span class="p">)</span><span class="nv">aCollection</span><span class="p">;</span>
</span><span class='line'><span class="cm">/** 相簿名 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">)</span><span class="nf">collectionTitle</span><span class="p">;</span>
</span><span class='line'><span class="cm">/** 估算的相簿相片个数 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSInteger</span><span class="p">)</span><span class="nf">collectionEstimatedAssetCount</span><span class="p">;</span>
</span><span class='line'><span class="cm">/** 精确的相簿相片个数 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSInteger</span><span class="p">)</span><span class="nf">collectionAccurateAssetCountWithFetchOptions:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">filterOptions</span><span class="p">;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSInteger</span><span class="p">)</span><span class="nf">collectionAccurateAssetCountWithMediaType:</span><span class="p">(</span><span class="n">TBVAssetsPickerMediaType</span><span class="p">)</span><span class="nv">mediaType</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>有了这些最基本的功能，在实现相册选择器时，就可以方便地对资源进行操作了。<br>
其实对于这部分的兼容处理，主要就是对两个不同的库进行封装，使其呈现同样的外观，后续的几步大体也是围绕这个目标进行。</p>

<h3>封装manager</h3>

<p>由于是两个不同版本的库，并且AssetsLibrary已经在iOS9时被弃用，使用时会产生<code>deprecated</code>警告，所以我分别对<code>ALAssetsLibrary</code>和<code>PHCachingImageManager</code>进行了封装，然后通过统一的接口<code>TBVAssetsManagerProtocol</code>暴露其功能。</p>

<p>一般相册选择器具有如下页面及对应功能（UI展示）：</p>

<ul>
<li>首页

<ul>
<li>相簿名</li>
<li>相簿缩略图</li>
<li>相簿拥有相片数</li>
</ul>
</li>
<li>预览页

<ul>
<li>相片缩略图</li>
<li>选中相片大小</li>
</ul>
</li>
<li>浏览页

<ul>
<li>相片大图</li>
<li>选中相片大小</li>
</ul>
</li>
</ul>


<p>所以我提供的接口如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">//====================================</span>
</span><span class='line'><span class="c1">//              image</span>
</span><span class='line'><span class="c1">//====================================</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** requestImage返回都是一个RACTuple，first是Image，second是是否为degraded */</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** 请求特定大小的图片 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestImageForAsset:</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="p">)</span><span class="nv">asset</span>
</span><span class='line'>                         <span class="nf">targetSize:</span><span class="p">(</span><span class="bp">CGSize</span><span class="p">)</span><span class="nv">targetSize</span>
</span><span class='line'>                        <span class="nf">contentMode:</span><span class="p">(</span><span class="n">TBVAssetsPickerContentMode</span><span class="p">)</span><span class="nv">contentMode</span><span class="p">;</span>
</span><span class='line'><span class="cm">/** 请求相簿缩略图 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestPosterImageForCollection:</span><span class="p">(</span><span class="n">TBVCollection</span> <span class="o">*</span><span class="p">)</span><span class="nv">collection</span>
</span><span class='line'>                                     <span class="nf">mediaType:</span><span class="p">(</span><span class="n">TBVAssetsPickerMediaType</span><span class="p">)</span><span class="nv">mediaType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** 请求相片缩略图 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestPosterImageForAsset:</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="p">)</span><span class="nv">asset</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** 请求相片原图 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestFullResolutionImageForAsset:</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="p">)</span><span class="nv">asset</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//====================================</span>
</span><span class='line'><span class="c1">//              asset / collection</span>
</span><span class='line'><span class="c1">//====================================</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** 请求相片资源大小 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestSizeForAssets:</span><span class="p">(</span><span class="bp">NSArray</span> <span class="o">&lt;</span><span class="n">TBVAsset</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nv">assets</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** 请求所有相簿 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestAllCollections</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** 请求所有相片资源 */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestAssetsForCollection:</span><span class="p">(</span><span class="n">TBVCollection</span> <span class="o">*</span><span class="p">)</span><span class="nv">collection</span>
</span><span class='line'>                                <span class="nf">mediaType:</span><span class="p">(</span><span class="n">TBVAssetsPickerMediaType</span><span class="p">)</span><span class="nv">mediaType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** 请求相机胶卷相簿（针对一般业务首先进入相机胶卷的预览页） */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestCameraRollCollection</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//====================================</span>
</span><span class='line'><span class="c1">//              video</span>
</span><span class='line'><span class="c1">//====================================</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** 请求AVPlayerItem */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestVideoForAsset:</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="p">)</span><span class="nv">asset</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** 请求AVURLAsset */</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestURLAssetForAsset:</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="p">)</span><span class="nv">asset</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>实现以上接口，一般相册选择器的功能点就已经完成大半了。<br></p>

<h2>TBVAssetsPickerManager</h2>

<p>由于自定义的相册manager都遵守<code>TBVAssetsManagerProtocol</code>，<code>TBVAssetsPickerManager</code>
的实现就变得相对简单，没有一大串令人厌烦的<code>if-else</code>。当然<code>TBVAssetsPickerManager</code>本身也是遵守<code>TBVAssetsManagerProtocol</code>的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">TBVAssetsPickerManager</span><span class="p">()</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="bp">NSObject</span><span class="o">&lt;</span><span class="n">TBVAssetsManagerProtocol</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">realManager</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">strong</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">requestIdList</span><span class="p">;</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">assign</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="kt">BOOL</span> <span class="n">photoKitAvailable</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark life cycle</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="n">init</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_photoKitAvailable</span> <span class="o">=</span> <span class="n">NSClassFromString</span><span class="p">(</span><span class="s">@&quot;PHImageManager&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark TBVAssetsManagerProtocol</span>
</span><span class='line'><span class="p">....</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark getter setter</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="bp">NSObject</span> <span class="o">*</span><span class="p">)</span><span class="n">realManager</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">_realManager</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">.</span><span class="n">photoKitAvailable</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">_realManager</span> <span class="o">=</span> <span class="p">[[</span><span class="n">TBVCachingImageManager</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">_realManager</span> <span class="o">=</span> <span class="p">[[</span><span class="n">TBVAssetsLibrary</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">_realManager</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样<code>_realManager</code>拿到的就是当前版本最新的相册manager了。</p>

<h3>接口的实现</h3>

<p>其实接口文档描述的还是非常清晰的，所以这里只是罗列了下代码，并没有针对每一步做解释，因为这些基本的操作进去头文件看看就全明白了。</p>

<h6>- requestImageForAsset:targetSize:(CGSize)targetSize:contentMode:</h6>

<p>这个接口主要用来获取非原图。</p>

<ul>
<li>TBVCachingImageManager

<ul>
<li>关于PHImageRequestOptions的deliveryMode，

<ul>
<li>设置为PHImageRequestOptionsDeliveryModeOpportunistic并且synchronous为NO时，请求可能会先返回一张缩略图，然后再返回一张大图，这个可以通过获取请求回调字典中PHImageResultIsDegradedKey对应value来判别</li>
<li>PHImageRequestOptionsDeliveryModeHighQualityFormat和PHImageRequestOptionsDeliveryModeFastFormat都返回一张图片，只不过前者返回的图片的质量高于或等于请求的质量，而后者可能返回一张质量稍低的图片</li>
</ul>
</li>
</ul>
</li>
<li>TBVAssetsLibrary

<ul>
<li>由于AssetsLibrary并没有提供获取特定尺寸的相片接口，所以这里只是返回thumbnail、aspectRatioThumbnail、fullScreenImage中尺寸和目标大小最接近的一张图片。</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// TBVCachingImageManager</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestImageForAsset:</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="p">)</span><span class="nv">asset</span>
</span><span class='line'>                         <span class="nf">targetSize:</span><span class="p">(</span><span class="bp">CGSize</span><span class="p">)</span><span class="nv">targetSize</span>
</span><span class='line'>                        <span class="nf">contentMode:</span><span class="p">(</span><span class="n">TBVAssetsPickerContentMode</span><span class="p">)</span><span class="nv">contentMode</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">PHImageRequestID</span> <span class="n">requestId</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">imageManager</span>
</span><span class='line'>                                      <span class="nl">requestImageForAsset</span><span class="p">:(</span><span class="n">PHAsset</span> <span class="o">*</span><span class="p">)</span><span class="n">asset</span><span class="p">.</span><span class="n">asset</span>
</span><span class='line'>                                      <span class="nl">targetSize</span><span class="p">:</span><span class="n">targetSize</span>
</span><span class='line'>                                      <span class="nl">contentMode</span><span class="p">:[</span><span class="nb">self</span> <span class="nl">contentModeForCustomContentMode</span><span class="p">:</span><span class="n">contentMode</span><span class="p">]</span>
</span><span class='line'>                                      <span class="nl">options</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">defaultImageRequestOptions</span>
</span><span class='line'>                                      <span class="nl">resultHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">UIImage</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">result</span><span class="p">,</span>
</span><span class='line'>                                                      <span class="bp">NSDictionary</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                          <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:</span><span class="n">RACTuplePack</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">PHImageResultIsDegradedKey</span><span class="p">])];</span>
</span><span class='line'>                                          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="n">PHImageResultIsDegradedKey</span><span class="p">]</span> <span class="n">boolValue</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                                              <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>                                          <span class="p">}</span>
</span><span class='line'>                                      <span class="p">}];</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">RACDisposable</span> <span class="nl">disposableWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">imageManager</span> <span class="nl">cancelImageRequest</span><span class="p">:</span><span class="n">requestId</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TBVAssetsLibrary</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestImageForAsset:</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="p">)</span><span class="nv">aAsset</span>
</span><span class='line'>                         <span class="nf">targetSize:</span><span class="p">(</span><span class="bp">CGSize</span><span class="p">)</span><span class="nv">targetSize</span>
</span><span class='line'>                        <span class="nf">contentMode:</span><span class="p">(</span><span class="n">TBVAssetsPickerContentMode</span><span class="p">)</span><span class="nv">contentMode</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[[</span><span class="n">RACSignal</span> <span class="k">return</span><span class="o">:</span><span class="n">aAsset</span><span class="p">.</span><span class="n">asset</span><span class="p">]</span>
</span><span class='line'>                <span class="nl">deliverOn</span><span class="p">:[</span><span class="n">RACScheduler</span> <span class="n">scheduler</span><span class="p">]]</span>
</span><span class='line'>                <span class="nl">map</span><span class="p">:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="bp">ALAsset</span> <span class="o">*</span> <span class="n">asset</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">CGImageRef</span> <span class="n">resultImageRef</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">BOOL</span> <span class="n">degraded</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">targetSize</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">CGImageGetWidth</span><span class="p">(</span><span class="n">asset</span><span class="p">.</span><span class="n">thumbnail</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>            <span class="n">targetSize</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">CGImageGetHeight</span><span class="p">(</span><span class="n">asset</span><span class="p">.</span><span class="n">thumbnail</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// TBVAssetsPickerContentModeFill</span>
</span><span class='line'>            <span class="n">resultImageRef</span> <span class="o">=</span> <span class="n">asset</span><span class="p">.</span><span class="n">thumbnail</span><span class="p">;</span>
</span><span class='line'>            <span class="n">degraded</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resultImageRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">CGImageRef</span> <span class="n">aspectRatioThumbnail</span> <span class="o">=</span> <span class="n">asset</span><span class="p">.</span><span class="n">aspectRatioThumbnail</span><span class="p">;</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">targetSize</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">CGImageGetWidth</span><span class="p">(</span><span class="n">aspectRatioThumbnail</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
</span><span class='line'>                <span class="n">targetSize</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">CGImageGetHeight</span><span class="p">(</span><span class="n">aspectRatioThumbnail</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>                <span class="c1">// TBVAssetsPickerContentModeFit</span>
</span><span class='line'>                <span class="n">resultImageRef</span> <span class="o">=</span> <span class="n">aspectRatioThumbnail</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">resultImageRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="bp">ALAssetRepresentation</span> <span class="o">*</span><span class="n">assetRepresentation</span> <span class="o">=</span> <span class="p">[</span><span class="n">asset</span> <span class="n">defaultRepresentation</span><span class="p">];</span>
</span><span class='line'>                <span class="n">resultImageRef</span> <span class="o">=</span> <span class="p">[</span><span class="n">assetRepresentation</span> <span class="n">fullScreenImage</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="bp">UIImage</span> <span class="o">*</span><span class="n">resultImage</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">resultImageRef</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">resultImage</span> <span class="o">=</span> <span class="p">[</span><span class="bp">UIImage</span> <span class="nl">imageWithCGImage</span><span class="p">:</span><span class="n">resultImageRef</span>
</span><span class='line'>                                              <span class="nl">scale</span><span class="p">:</span><span class="n">BQAP_SCREEN_SCALE</span>
</span><span class='line'>                                        <span class="nl">orientation</span><span class="p">:</span><span class="n">UIImageOrientationUp</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">RACTuplePack</span><span class="p">(</span><span class="n">resultImage</span><span class="p">,</span> <span class="l">@(</span><span class="n">degraded</span><span class="l">)</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h6>-requestPosterImageForCollection:mediaType:</h6>

<ul>
<li>TBVCachingImageManager

<ul>
<li>通过-fetchKeyAssetsInAssetCollection:options:获取相簿keyAssets，最多可以返回三个</li>
<li>最终还是通过requestPosterImageForAsset:获取缩略图</li>
<li>获取keyAssets前，需要设置options对资源进行过滤：</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">tbv_fetchOptionsWithCustomMediaType:</span><span class="p">(</span><span class="n">TBVAssetsPickerMediaType</span><span class="p">)</span><span class="nv">mediaType</span> <span class="p">{</span>
</span><span class='line'>    <span class="bp">NSArray</span> <span class="o">*</span><span class="n">mediaTypes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">tbv_mediaTypesWithCustonMediaType</span><span class="p">:</span><span class="n">mediaType</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mediaTypes</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">PHFetchOptions</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="p">[[</span><span class="n">PHFetchOptions</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="bp">NSMutableString</span> <span class="o">*</span><span class="n">predicateString</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableString</span> <span class="n">string</span><span class="p">];</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="bp">NSNumber</span> <span class="o">*</span><span class="n">mediaType</span> <span class="k">in</span> <span class="n">mediaTypes</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="n">predicateString</span> <span class="nl">appendFormat</span><span class="p">:</span><span class="s">@&quot;mediaType = %@&quot;</span><span class="p">,</span> <span class="n">mediaType</span><span class="p">];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">mediaType</span> <span class="nl">isEqual</span><span class="p">:</span><span class="n">mediaTypes</span><span class="p">.</span><span class="n">lastObject</span><span class="p">])</span> <span class="p">[</span><span class="n">predicateString</span> <span class="nl">appendString</span><span class="p">:</span><span class="s">@&quot; || &quot;</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">options</span><span class="p">.</span><span class="n">predicate</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSPredicate</span> <span class="nl">predicateWithFormat</span><span class="p">:</span><span class="n">predicateString</span><span class="p">];</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">options</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>TBVAssetsLibrary

<ul>
<li>ALAssetsGroup有posterImage属性，直接返回相簿缩略图</li>
<li>和PhotoKit不同，AssetLibrary通过ALAssetsGroup的setAssetsFilter方法进行过滤</li>
</ul>
</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="n">group</span> <span class="nl">setAssetsFilter</span><span class="p">:[</span><span class="bp">ALAssetsFilter</span> <span class="nl">tbv_assetsFilterWithCustomMediaType</span><span class="p">:</span><span class="n">mediaType</span><span class="p">]];</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样设置以后，后续针对group的操作都会在过滤的结果中进行了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// TBVCachingImageManager</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestPosterImageForCollection:</span><span class="p">(</span><span class="n">TBVCollection</span> <span class="o">*</span><span class="p">)</span><span class="nv">collection</span>
</span><span class='line'>                              <span class="nf">mediaType:</span><span class="p">(</span><span class="n">TBVAssetsPickerMediaType</span><span class="p">)</span><span class="nv">mediaType</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">PHFetchOptions</span> <span class="o">*</span><span class="n">fetchOptions</span> <span class="o">=</span> <span class="p">[</span><span class="n">PHFetchOptions</span> <span class="nl">tbv_fetchOptionsWithCustomMediaType</span><span class="p">:</span><span class="n">mediaType</span><span class="p">];</span>
</span><span class='line'>        <span class="n">fetchOptions</span><span class="p">.</span><span class="n">sortDescriptors</span> <span class="o">=</span> <span class="l">@[</span><span class="p">[</span><span class="bp">NSSortDescriptor</span> <span class="nl">sortDescriptorWithKey</span><span class="p">:</span><span class="s">@&quot;creationDate&quot;</span>
</span><span class='line'>                                                                       <span class="nl">ascending</span><span class="p">:</span><span class="nb">YES</span><span class="p">]</span><span class="l">]</span><span class="p">;</span>
</span><span class='line'>        <span class="n">PHAssetCollection</span> <span class="o">*</span><span class="n">realCollection</span> <span class="o">=</span> <span class="p">(</span><span class="n">PHAssetCollection</span> <span class="o">*</span><span class="p">)</span><span class="n">collection</span><span class="p">.</span><span class="n">collection</span><span class="p">;</span>
</span><span class='line'>        <span class="cm">/* fetchKeyAssetsInAssetCollection 获取至多三张 */</span>
</span><span class='line'>        <span class="n">PHFetchResult</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">PHAsset</span> <span class="nl">fetchKeyAssetsInAssetCollection</span><span class="p">:</span><span class="n">realCollection</span>
</span><span class='line'>                                                                 <span class="nl">options</span><span class="p">:</span><span class="n">fetchOptions</span><span class="p">];</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:[</span><span class="n">RACSignal</span> <span class="n">empty</span><span class="p">]];</span>
</span><span class='line'>            <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">TBVAsset</span> <span class="o">*</span><span class="n">posterAsset</span> <span class="o">=</span> <span class="p">[</span><span class="n">TBVAsset</span> <span class="nl">assetWithOriginAsset</span><span class="p">:</span><span class="n">result</span><span class="p">.</span><span class="n">firstObject</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:[</span><span class="nb">self</span> <span class="nl">requestPosterImageForAsset</span><span class="p">:</span><span class="n">posterAsset</span><span class="p">]];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}]</span> <span class="n">switchToLatest</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TBVAssetsLibrary</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestAssetsForCollection:</span><span class="p">(</span><span class="n">TBVCollection</span> <span class="o">*</span><span class="p">)</span><span class="nv">collection</span>
</span><span class='line'>                                <span class="nf">mediaType:</span><span class="p">(</span><span class="n">TBVAssetsPickerMediaType</span><span class="p">)</span><span class="nv">mediaType</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">assets</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>        <span class="bp">ALAssetsGroup</span> <span class="o">*</span><span class="n">group</span> <span class="o">=</span> <span class="p">(</span><span class="bp">ALAssetsGroup</span> <span class="o">*</span><span class="p">)</span><span class="n">collection</span><span class="p">.</span><span class="n">collection</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[</span><span class="n">group</span> <span class="nl">setAssetsFilter</span><span class="p">:[</span><span class="bp">ALAssetsFilter</span> <span class="nl">tbv_assetsFilterWithCustomMediaType</span><span class="p">:</span><span class="n">mediaType</span><span class="p">]];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">group</span> <span class="nl">enumerateAssetsUsingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">ALAsset</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="bp">NSUInteger</span> <span class="n">index</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="p">[</span><span class="n">assets</span> <span class="nl">addObject</span><span class="p">:[</span><span class="n">TBVAsset</span> <span class="nl">assetWithOriginAsset</span><span class="p">:</span><span class="n">result</span><span class="p">]];</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:</span><span class="n">assets</span><span class="p">];</span>
</span><span class='line'>                <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h6>-requestPosterImageForAsset:</h6>

<p>获取asset的缩略图，需要注意的一点就是：在获取缩略图的情况下，Fill比Fit获取的图片要清晰</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// TBVCachingImageManager</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestPosterImageForAsset:</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="p">)</span><span class="nv">asset</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">CGSize</span> <span class="n">posterSize</span> <span class="o">=</span> <span class="n">CGSizeMake</span><span class="p">(</span><span class="n">kBQPosterImageWidth</span> <span class="o">*</span> <span class="n">BQAP_SCREEN_SCALE</span><span class="p">,</span>
</span><span class='line'>                                       <span class="n">kBQPosterImageHeight</span> <span class="o">*</span> <span class="n">BQAP_SCREEN_SCALE</span><span class="p">);</span>
</span><span class='line'>        <span class="cm">/* 在获取缩略图的情况下，Fill比Fit获取的图片要清晰 */</span>
</span><span class='line'>        <span class="n">PHImageRequestID</span> <span class="n">requestId</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">imageManager</span>
</span><span class='line'>                                      <span class="nl">requestImageForAsset</span><span class="p">:(</span><span class="n">PHAsset</span> <span class="o">*</span><span class="p">)</span><span class="n">asset</span><span class="p">.</span><span class="n">asset</span>
</span><span class='line'>                                      <span class="nl">targetSize</span><span class="p">:</span><span class="n">posterSize</span>
</span><span class='line'>                                      <span class="nl">contentMode</span><span class="p">:</span><span class="n">PHImageContentModeAspectFill</span>
</span><span class='line'>                                      <span class="nl">options</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">defaultImageRequestOptions</span>
</span><span class='line'>                                      <span class="nl">resultHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">UIImage</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">result</span><span class="p">,</span>
</span><span class='line'>                                                      <span class="bp">NSDictionary</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                          <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:</span><span class="n">RACTuplePack</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">PHImageResultIsDegradedKey</span><span class="p">])];</span>
</span><span class='line'>                                          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="n">PHImageResultIsDegradedKey</span><span class="p">]</span> <span class="n">boolValue</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                                              <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>                                          <span class="p">}</span>
</span><span class='line'>                                      <span class="p">}];</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">RACDisposable</span> <span class="nl">disposableWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">imageManager</span> <span class="nl">cancelImageRequest</span><span class="p">:</span><span class="n">requestId</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TBVAssetsLibrary</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestPosterImageForAsset:</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="p">)</span><span class="nv">asset</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">CGSize</span> <span class="n">posterSize</span> <span class="o">=</span> <span class="n">CGSizeMake</span><span class="p">(</span><span class="n">kBQPosterImageWidth</span> <span class="o">*</span> <span class="n">BQAP_SCREEN_SCALE</span><span class="p">,</span>
</span><span class='line'>                                       <span class="n">kBQPosterImageHeight</span> <span class="o">*</span> <span class="n">BQAP_SCREEN_SCALE</span><span class="p">);</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:[</span><span class="nb">self</span> <span class="nl">requestImageForAsset</span><span class="p">:</span><span class="n">asset</span>
</span><span class='line'>                                             <span class="nl">targetSize</span><span class="p">:</span><span class="n">posterSize</span>
</span><span class='line'>                                            <span class="nl">contentMode</span><span class="p">:</span><span class="n">TBVAssetsPickerContentModeFill</span><span class="p">]];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}]</span> <span class="n">switchToLatest</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h6>-requestFullResolutionImageForAsset:</h6>

<p>获取原图时有一点很重要，就是尽量不要快速连续地获取原图，大图也可以列入这个范畴。连续地获取大图或者原图，设备的内存会急剧增高，甚至崩溃，这种情况通常在上传图片时比较常见。
所以在上传图片时，尽量上传一张原图后再获取下一张原图进行上传，而不是全部获取完成之后再上传。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// TBVCachingImageManager</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestFullResolutionImageForAsset:</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="p">)</span><span class="nv">asset</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nb">self</span><span class="p">.</span><span class="n">defaultImageRequestOptions</span><span class="p">.</span><span class="n">networkAccessAllowed</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'>        <span class="n">PHImageRequestID</span> <span class="n">requestId</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">imageManager</span>
</span><span class='line'>                                      <span class="nl">requestImageForAsset</span><span class="p">:(</span><span class="n">PHAsset</span> <span class="o">*</span><span class="p">)</span><span class="n">asset</span><span class="p">.</span><span class="n">asset</span>
</span><span class='line'>                                      <span class="nl">targetSize</span><span class="p">:</span><span class="n">PHImageManagerMaximumSize</span>
</span><span class='line'>                                      <span class="nl">contentMode</span><span class="p">:</span><span class="n">PHImageContentModeDefault</span>
</span><span class='line'>                                      <span class="nl">options</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">defaultImageRequestOptions</span>
</span><span class='line'>                                      <span class="nl">resultHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">UIImage</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">result</span><span class="p">,</span>
</span><span class='line'>                                                      <span class="bp">NSDictionary</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                          <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:</span><span class="n">RACTuplePack</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">PHImageResultIsDegradedKey</span><span class="p">])];</span>
</span><span class='line'>                                          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">info</span><span class="p">[</span><span class="n">PHImageResultIsDegradedKey</span><span class="p">]</span> <span class="n">boolValue</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>                                              <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>                                          <span class="p">}</span>
</span><span class='line'>                                      <span class="p">}];</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="n">RACDisposable</span> <span class="nl">disposableWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">imageManager</span> <span class="nl">cancelImageRequest</span><span class="p">:</span><span class="n">requestId</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TBVAssetsLibrary</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestFullResolutionImageForAsset:</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="p">)</span><span class="nv">asset</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[[</span><span class="n">RACSignal</span> <span class="k">return</span><span class="o">:</span><span class="n">asset</span><span class="p">.</span><span class="n">asset</span><span class="p">]</span>
</span><span class='line'>        <span class="nl">deliverOn</span><span class="p">:[</span><span class="n">RACScheduler</span> <span class="n">scheduler</span><span class="p">]]</span>
</span><span class='line'>        <span class="nl">map</span><span class="p">:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="bp">ALAsset</span> <span class="o">*</span> <span class="n">asset</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="bp">ALAssetRepresentation</span> <span class="o">*</span><span class="n">assetRepresentation</span> <span class="o">=</span> <span class="p">[</span><span class="n">asset</span> <span class="n">defaultRepresentation</span><span class="p">];</span>
</span><span class='line'>            <span class="n">CGImageRef</span> <span class="n">fullResolutionImage</span> <span class="o">=</span> <span class="p">[</span><span class="n">assetRepresentation</span> <span class="n">fullResolutionImage</span><span class="p">];</span>
</span><span class='line'>            <span class="bp">UIImage</span> <span class="o">*</span><span class="n">resultImage</span> <span class="o">=</span> <span class="p">[</span><span class="bp">UIImage</span> <span class="nl">imageWithCGImage</span><span class="p">:</span><span class="n">fullResolutionImage</span>
</span><span class='line'>                                                       <span class="nl">scale</span><span class="p">:</span><span class="n">BQAP_SCREEN_SCALE</span>
</span><span class='line'>                                                 <span class="nl">orientation</span><span class="p">:</span><span class="n">UIImageOrientationUp</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span> <span class="n">RACTuplePack</span><span class="p">(</span><span class="n">resultImage</span><span class="p">,</span> <span class="l">@(</span><span class="nb">NO</span><span class="l">)</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h6>-requestSizeForAssets:</h6>

<p>请求大小是针对的图片，所以对非图片的asset进行了过滤</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// TBVCachingImageManager</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestSizeForAssets:</span><span class="p">(</span><span class="bp">NSArray</span><span class="o">&lt;</span><span class="n">TBVAsset</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nv">assets</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">RACSequence</span> <span class="o">*</span><span class="n">requestSequence</span> <span class="o">=</span> <span class="p">[[</span><span class="n">assets</span><span class="p">.</span><span class="n">rac_sequence</span>
</span><span class='line'>        <span class="nl">filter</span><span class="p">:</span><span class="o">^</span><span class="kt">BOOL</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="n">asset</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">((</span><span class="n">PHAsset</span> <span class="o">*</span><span class="p">)</span><span class="n">asset</span><span class="p">.</span><span class="n">asset</span><span class="p">).</span><span class="n">mediaType</span> <span class="o">==</span> <span class="n">PHAssetMediaTypeImage</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}]</span>
</span><span class='line'>        <span class="nl">map</span><span class="p">:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="n">asset</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nb">self</span><span class="p">.</span><span class="n">defaultImageRequestOptions</span><span class="p">.</span><span class="n">deliveryMode</span> <span class="o">=</span> <span class="n">PHImageRequestOptionsDeliveryModeHighQualityFormat</span><span class="p">;</span>
</span><span class='line'>                <span class="n">PHImageRequestID</span> <span class="n">requestId</span> <span class="o">=</span><span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">imageManager</span>
</span><span class='line'>                                             <span class="nl">requestImageDataForAsset</span><span class="p">:(</span><span class="n">PHAsset</span> <span class="o">*</span><span class="p">)</span><span class="n">asset</span><span class="p">.</span><span class="n">asset</span>
</span><span class='line'>                                             <span class="nl">options</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">defaultImageRequestOptions</span>
</span><span class='line'>                                             <span class="nl">resultHandler</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSData</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">imageData</span><span class="p">,</span>
</span><span class='line'>                                                             <span class="bp">NSString</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">dataUTI</span><span class="p">,</span>
</span><span class='line'>                                                             <span class="n">UIImageOrientation</span> <span class="n">orientation</span><span class="p">,</span>
</span><span class='line'>                                                             <span class="bp">NSDictionary</span> <span class="o">*</span> <span class="n">_Nullable</span> <span class="n">info</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                                                 <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:</span><span class="l">@(</span><span class="n">imageData</span><span class="p">.</span><span class="n">length</span><span class="l">)</span><span class="p">];</span>
</span><span class='line'>                                                 <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>                                             <span class="p">}];</span>
</span><span class='line'>                <span class="k">return</span> <span class="p">[</span><span class="n">RACDisposable</span> <span class="nl">disposableWithBlock</span><span class="p">:</span><span class="o">^</span><span class="p">{</span>
</span><span class='line'>                    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">imageManager</span> <span class="nl">cancelImageRequest</span><span class="p">:</span><span class="n">requestId</span><span class="p">];</span>
</span><span class='line'>                <span class="p">}];</span>
</span><span class='line'>            <span class="p">}];</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">RACSignal</span>
</span><span class='line'>        <span class="nl">zip</span><span class="p">:</span><span class="n">requestSequence</span><span class="p">]</span>
</span><span class='line'>        <span class="nl">map</span><span class="p">:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="n">RACTuple</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">[</span><span class="n">value</span><span class="p">.</span><span class="n">rac_sequence</span> <span class="nl">foldLeftWithStart</span><span class="p">:</span><span class="mi">@0</span> <span class="nl">reduce</span><span class="p">:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="kt">id</span> <span class="n">accumulator</span><span class="p">,</span> <span class="kt">id</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="l">@(</span><span class="p">[</span><span class="n">accumulator</span> <span class="n">integerValue</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">value</span> <span class="n">integerValue</span><span class="p">]</span><span class="l">)</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}];</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TBVAssetsLibrary</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestSizeForAssets:</span><span class="p">(</span><span class="bp">NSArray</span><span class="o">&lt;</span><span class="n">TBVAsset</span> <span class="o">*&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nv">assets</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span>
</span><span class='line'>        <span class="k">return</span><span class="o">:</span><span class="p">[[[[</span><span class="n">assets</span><span class="p">.</span><span class="n">rac_sequence</span>
</span><span class='line'>            <span class="nl">map</span><span class="p">:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="n">TBVAsset</span> <span class="o">*</span><span class="n">asset</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>               <span class="k">return</span> <span class="n">asset</span><span class="p">.</span><span class="n">asset</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}]</span>
</span><span class='line'>            <span class="nl">filter</span><span class="p">:</span><span class="o">^</span><span class="kt">BOOL</span><span class="p">(</span><span class="bp">ALAsset</span> <span class="o">*</span><span class="n">asset</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="p">[</span><span class="n">asset</span> <span class="nl">valueForProperty</span><span class="p">:</span><span class="n">ALAssetPropertyType</span><span class="p">]</span> <span class="o">==</span> <span class="n">ALAssetTypePhoto</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}]</span>
</span><span class='line'>            <span class="nl">map</span><span class="p">:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="bp">ALAsset</span> <span class="o">*</span><span class="n">asset</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="l">@(</span><span class="p">[</span><span class="n">asset</span> <span class="n">defaultRepresentation</span><span class="p">].</span><span class="n">size</span><span class="l">)</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}]</span>
</span><span class='line'>            <span class="nl">foldLeftWithStart</span><span class="p">:</span><span class="l">@(</span><span class="mi">0</span><span class="l">)</span> <span class="nl">reduce</span><span class="p">:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="kt">id</span> <span class="n">accumulator</span><span class="p">,</span> <span class="kt">id</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="l">@(</span><span class="p">[</span><span class="n">accumulator</span> <span class="n">integerValue</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">value</span> <span class="n">integerValue</span><span class="p">]</span><span class="l">)</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}]];</span>
</span><span class='line'>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h6>-requestAllCollections</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// TBVCachingImageManager</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestAllCollections</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">PHFetchResult</span> <span class="o">*</span><span class="n">smartResult</span> <span class="o">=</span> <span class="p">[</span><span class="n">PHAssetCollection</span>
</span><span class='line'>                                      <span class="nl">fetchAssetCollectionsWithType</span><span class="p">:</span><span class="n">PHAssetCollectionTypeSmartAlbum</span>
</span><span class='line'>                                      <span class="nl">subtype</span><span class="p">:</span><span class="n">PHAssetCollectionSubtypeAlbumRegular</span>
</span><span class='line'>                                      <span class="nl">options</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>        <span class="n">PHFetchResult</span> <span class="o">*</span><span class="n">topLevelUserCollections</span> <span class="o">=</span> <span class="p">[</span><span class="n">PHCollectionList</span> <span class="nl">fetchTopLevelUserCollectionsWithOptions</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">collections</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">PHAssetCollection</span> <span class="o">*</span><span class="n">aCollection</span> <span class="k">in</span> <span class="n">smartResult</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">TBVCollection</span> <span class="o">*</span><span class="n">collection</span> <span class="o">=</span> <span class="p">[</span><span class="n">TBVCollection</span> <span class="nl">collectionWithOriginCollection</span><span class="p">:</span><span class="n">aCollection</span><span class="p">];</span>
</span><span class='line'>            <span class="p">[</span><span class="n">collections</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">collection</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">PHAssetCollection</span> <span class="o">*</span><span class="n">aCollection</span> <span class="k">in</span> <span class="n">topLevelUserCollections</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">TBVCollection</span> <span class="o">*</span><span class="n">collection</span> <span class="o">=</span> <span class="p">[</span><span class="n">TBVCollection</span> <span class="nl">collectionWithOriginCollection</span><span class="p">:</span><span class="n">aCollection</span><span class="p">];</span>
</span><span class='line'>            <span class="p">[</span><span class="n">collections</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">collection</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:</span><span class="n">collections</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TBVAssetsLibrary</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestAllCollections</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">collections</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">assetsLibrary</span> <span class="nl">enumerateGroupsWithTypes</span><span class="p">:</span><span class="n">ALAssetsGroupAll</span>
</span><span class='line'>                                          <span class="nl">usingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">ALAssetsGroup</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">TBVCollection</span> <span class="o">*</span><span class="n">collection</span> <span class="o">=</span> <span class="p">[</span><span class="n">TBVCollection</span> <span class="nl">collectionWithOriginCollection</span><span class="p">:</span><span class="n">group</span><span class="p">];</span>
</span><span class='line'>                <span class="p">[</span><span class="n">collections</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">collection</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:</span><span class="n">collections</span><span class="p">];</span>
</span><span class='line'>                <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span> <span class="nl">failureBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendError</span><span class="p">:</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h6>-requestAssetsForCollection:mediaType:</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// TBVCachingImageManager</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestAssetsForCollection:</span><span class="p">(</span><span class="n">TBVCollection</span> <span class="o">*</span><span class="p">)</span><span class="nv">collection</span>
</span><span class='line'>                                <span class="nf">mediaType:</span><span class="p">(</span><span class="n">TBVAssetsPickerMediaType</span><span class="p">)</span><span class="nv">mediaType</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">PHFetchOptions</span> <span class="o">*</span><span class="n">options</span> <span class="o">=</span> <span class="p">[</span><span class="n">PHFetchOptions</span> <span class="nl">tbv_fetchOptionsWithCustomMediaType</span><span class="p">:</span><span class="n">mediaType</span><span class="p">];</span>
</span><span class='line'>        <span class="n">PHFetchResult</span> <span class="o">*</span><span class="n">fetchResult</span> <span class="o">=</span> <span class="p">[</span><span class="n">PHAsset</span> <span class="nl">fetchAssetsInAssetCollection</span><span class="p">:(</span><span class="n">PHAssetCollection</span> <span class="o">*</span><span class="p">)</span><span class="n">collection</span><span class="p">.</span><span class="n">collection</span>
</span><span class='line'>                                                                   <span class="nl">options</span><span class="p">:</span><span class="n">options</span><span class="p">];</span>
</span><span class='line'>        <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">assets</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="nl">arrayWithCapacity</span><span class="p">:</span><span class="n">fetchResult</span><span class="p">.</span><span class="n">count</span><span class="p">];</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">PHAsset</span> <span class="o">*</span><span class="n">asset</span> <span class="k">in</span> <span class="n">fetchResult</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="n">assets</span> <span class="nl">addObject</span><span class="p">:[</span><span class="n">TBVAsset</span> <span class="nl">assetWithOriginAsset</span><span class="p">:</span><span class="n">asset</span><span class="p">]];</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:</span><span class="n">assets</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TBVAssetsLibrary</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestAssetsForCollection:</span><span class="p">(</span><span class="n">TBVCollection</span> <span class="o">*</span><span class="p">)</span><span class="nv">collection</span>
</span><span class='line'>                                <span class="nf">mediaType:</span><span class="p">(</span><span class="n">TBVAssetsPickerMediaType</span><span class="p">)</span><span class="nv">mediaType</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">assets</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>        <span class="bp">ALAssetsGroup</span> <span class="o">*</span><span class="n">group</span> <span class="o">=</span> <span class="p">(</span><span class="bp">ALAssetsGroup</span> <span class="o">*</span><span class="p">)</span><span class="n">collection</span><span class="p">.</span><span class="n">collection</span><span class="p">;</span>
</span><span class='line'>        <span class="p">[</span><span class="n">group</span> <span class="nl">setAssetsFilter</span><span class="p">:[</span><span class="bp">ALAssetsFilter</span> <span class="nl">tbv_assetsFilterWithCustomMediaType</span><span class="p">:</span><span class="n">mediaType</span><span class="p">]];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">group</span> <span class="nl">enumerateAssetsUsingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">ALAsset</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="bp">NSUInteger</span> <span class="n">index</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="p">[</span><span class="n">assets</span> <span class="nl">addObject</span><span class="p">:[</span><span class="n">TBVAsset</span> <span class="nl">assetWithOriginAsset</span><span class="p">:</span><span class="n">result</span><span class="p">]];</span>
</span><span class='line'>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>                <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:</span><span class="n">assets</span><span class="p">];</span>
</span><span class='line'>                <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h6>-requestCameraRollCollection</h6>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">// TBVCachingImageManager</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestCameraRollCollection</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">PHFetchResult</span> <span class="o">*</span><span class="n">smartAlbums</span> <span class="o">=</span> <span class="p">[</span><span class="n">PHAssetCollection</span>
</span><span class='line'>                                      <span class="nl">fetchAssetCollectionsWithType</span><span class="p">:</span><span class="n">PHAssetCollectionTypeSmartAlbum</span>
</span><span class='line'>                                      <span class="nl">subtype</span><span class="p">:</span><span class="n">PHAssetCollectionSubtypeSmartAlbumUserLibrary</span>
</span><span class='line'>                                      <span class="nl">options</span><span class="p">:</span><span class="nb">nil</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:[</span><span class="n">TBVCollection</span> <span class="nl">collectionWithOriginCollection</span><span class="p">:</span><span class="n">smartAlbums</span><span class="p">.</span><span class="n">firstObject</span><span class="p">]];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TBVAssetsLibrary</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">requestCameraRollCollection</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">assetsLibrary</span> <span class="nl">enumerateGroupsWithTypes</span><span class="p">:</span><span class="n">ALAssetsGroupSavedPhotos</span> <span class="nl">usingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">ALAssetsGroup</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:[</span><span class="n">TBVCollection</span> <span class="nl">collectionWithOriginCollection</span><span class="p">:</span><span class="n">group</span><span class="p">]];</span>
</span><span class='line'>            <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}</span> <span class="nl">failureBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendError</span><span class="p">:</span><span class="n">error</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h6>-requestVideoForAsset:和-requestURLAssetForAsset:</h6>

<p>由于业务上没有视频的需求，所以这一块还没有去实现。</p>

<h3>实现过程中的一些小坑</h3>

<h6>用ALAssetsLibrary申请访问相册权限</h6>

<p>这一点貌似有些代码用authorizationStatus就能实现，不过
应用的时候还是发现不能触发请求权限alert，所以这里需要访问下相册的资源<a href="http://stackoverflow.com/questions/13572220/ask-permission-to-access-camera-roll">ask-permission-to-access-camera-roll</a>，
来触发这个请求动作：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">+</span> <span class="p">(</span><span class="n">RACSignal</span> <span class="o">*</span><span class="p">)</span><span class="nf">tbv_forceTriggerPermissionAsking</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="n">RACSignal</span> <span class="nl">createSignal</span><span class="p">:</span><span class="o">^</span><span class="n">RACDisposable</span> <span class="o">*</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">RACSubscriber</span><span class="o">&gt;</span> <span class="n">subscriber</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">void</span> <span class="p">(</span><span class="o">^</span><span class="n">sendStatus</span><span class="p">)()</span> <span class="o">=</span> <span class="o">^</span><span class="p">{</span>
</span><span class='line'>            <span class="p">[</span><span class="n">subscriber</span> <span class="nl">sendNext</span><span class="p">:</span><span class="l">@(</span><span class="p">[</span><span class="nb">self</span> <span class="n">tbv_authorizationStatus</span><span class="p">]</span><span class="l">)</span><span class="p">];</span>
</span><span class='line'>            <span class="p">[</span><span class="n">subscriber</span> <span class="n">sendCompleted</span><span class="p">];</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">([</span><span class="nb">self</span> <span class="n">tbv_authorizationStatus</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BQAuthorizationStatusNotDetermined</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">sendStatus</span><span class="p">();</span>
</span><span class='line'>            <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="bp">ALAssetsLibrary</span> <span class="o">*</span><span class="n">lib</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">ALAssetsLibrary</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">lib</span> <span class="nl">enumerateGroupsWithTypes</span><span class="p">:</span><span class="n">ALAssetsGroupSavedPhotos</span> <span class="nl">usingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">ALAssetsGroup</span> <span class="o">*</span><span class="n">group</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="o">*</span><span class="n">stop</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">sendStatus</span><span class="p">();</span>
</span><span class='line'>            <span class="o">*</span><span class="n">stop</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="nl">failureBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">*</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">sendStatus</span><span class="p">();</span>
</span><span class='line'>        <span class="p">}];</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}]</span> <span class="n">deliverOnMainThread</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h6>ALAssetsLibrary请求的ALAsset被置空问题</h6>

<p>官方文档里面有这么一句：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">The</span> <span class="n">lifetimes</span> <span class="n">of</span> <span class="n">objects</span> <span class="n">you</span> <span class="n">get</span> <span class="n">back</span> <span class="n">from</span> <span class="n">a</span> <span class="n">library</span> <span class="n">instance</span> <span class="n">are</span> <span class="n">tied</span> <span class="n">to</span> <span class="n">the</span> <span class="n">lifetime</span> <span class="n">of</span> <span class="n">the</span> <span class="n">library</span> <span class="n">instance</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到，在使用ALAssetsLibrary请求回来的资源时，是不能释放对应的ALAssetsLibrary对象的。在发送多图的场合，如果不注意保持住ALAssetsLibrary对象，很容易发生后面几张图片获取不到的情况。</p>

<p>所以，要么在选择器返回选中的资源时，强引用对应的manager，要么这个manager由调用者传给相册选择器。</p>

<h6>更改应用权限并切回前台</h6>

<p>如果应用在后台时，更改了权限，当切回前台后，App会重新启动 。这里如果设置了断点，别以为是程序崩了。</p>

<h3>不足</h3>

<p>一个很明显的问题是使用了RAC的版本后，相册选择器滚动的性能会下降，没有以前通过回调来的顺畅。如果稍微快速一点滚动的话，CPU很容易就上100%。</p>

<p>可能是使用RAC的方式不是很正确造成的，后续尽可能优化这一块。</p>

<h2>2016-9-25补充</h2>

<p>关于grid界面卡顿的原因:<br>
因为这个界面的cell非常多，如果快速滚动时不对获取图片的信号进行throttle，那么CPU的占用率就会很高，从而界面就会变得卡顿。<br>
在这里设置throttle为0.05左右就可以使界面变得比较顺畅，并且不会有太大的刷新延迟以至于影响用户体验。如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">RAC</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">contentImageView</span><span class="p">.</span><span class="n">image</span><span class="p">)</span> <span class="o">=</span> <span class="p">[[[</span><span class="n">viewModel</span><span class="p">.</span><span class="n">contentImageSignal</span>
</span><span class='line'>        <span class="nl">throttle</span><span class="p">:</span><span class="mf">0.05</span><span class="p">]</span>
</span><span class='line'>        <span class="nl">takeUntil</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">rac_prepareForReuseSignal</span><span class="p">]</span>
</span><span class='line'>        <span class="nl">map</span><span class="p">:</span><span class="o">^</span><span class="kt">id</span><span class="p">(</span><span class="n">RACTuple</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="p">[</span><span class="n">value</span> <span class="n">first</span><span class="p">];</span>
</span><span class='line'>        <span class="p">}];</span>
</span></code></pre></td></tr></table></div></figure>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">tripleCC</span></span>

      




<time class='entry-date' datetime='2016-09-10T21:25:36+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:25 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016-08-10-ioszhi-shi-sui-pian-liu/" title="Previous Post: iOS知识碎片六">&laquo; iOS知识碎片六</a>
      
      
        <a class="basic-alignment right" href="/blog/2016-09-15-li-yong-ce-lue-mo-shi-zeng-qiang-tu-pian-liu-lan-qi-de-kuo-zhan-xing/" title="Next Post: 利用策略模式增强图片浏览器的扩展性">利用策略模式增强图片浏览器的扩展性 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>关于我</h1>
  <p> 曾经的嵌入式软件开发者，现已皈依苹果大法门下。目前混迹杭州，喜欢没事就去西湖压马路。轻微完美主义者，跑步爱好者。 </p>
  <a href="http://www.jianshu.com/users/97e39e95c2cc"> 我的简书 </a><br>
  <a href="https://github.com/tripleCC"> 我的GitHub </a><br>
  <a href="https://twitter.com/tripleCCBrian"> 我的Twitter </a>
</section>
<section>
  <h1>最近发布</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2018-04-07-rang-cocoapodszu-jian-zhi-chi-carthageda-bao/">让CocoaPods组件支持Carthage打包</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-12-02-ioszhi-shi-sui-pian-ba/">iOS知识碎片八</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-11-08-chuang-jian-cocoapodscha-jian/">编写自己的cocoapods插件</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-10-25-zu-jian-sheng-ming-zhou-qi/">组件化之组件生命周期管理</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-08-12-cbiao-da-shi-zhong-floatjing-du-ti-sheng-wen-ti/">C 表达式中 Float 精度提升问题</a>
      </li>
    
  </ul>
</section>




<section>
    <h1>友情链接</h1>
    <ul>
        <li>
            <a href="http://wxgbridgeq.github.io/">小乔的个人学习博客</a>
        </li>
        <li>
        	<a href="http://www.swiftyper.com/">Swiftyper-小锅</a>
        </li>
    </ul>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - tripleCC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'tripleCC';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://triplecc.github.io/blog/2016-09-10-shi-yong-assetslibraryhe-photokitzuo-%5B%3F%5D-ge-xiang-pian-xuan-ze-qi/';
        var disqus_url = 'http://triplecc.github.io/blog/2016-09-10-shi-yong-assetslibraryhe-photokitzuo-%5B%3F%5D-ge-xiang-pian-xuan-ze-qi/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
