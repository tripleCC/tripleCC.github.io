
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>使用AssetsLibrary和PhotoKit做一个简易的相片选择器 - tripleCC的技术博客</title>
  <meta name="author" content="tripleCC">

  
  <meta name="description" content="iOS8之后，苹果推出了PhotoKit，让开发者在处理相册相关的业务时，可以更加得心应手。github上的开发者针对PhotoKit做了一层很优秀的封装CTAssetsPickerController，如果只需要支持iOS8+， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://triplecc.github.io/blog/2016-09-10-shi-yong-assetslibraryhe-photokitzuo-%5B%3F%5D-ge-xiang-pian-xuan-ze-qi/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="tripleCC的技术博客" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://libs.useso.com/js/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="//fonts.useso.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//fonts.useso.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">tripleCC的技术博客</a></h1>
  
    <h2>日拱一卒</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.baidu.com" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="triplecc.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">使用AssetsLibrary和PhotoKit做一个简易的相片选择器</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-09-10T21:25:36+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:25 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>iOS8之后，苹果推出了PhotoKit，让开发者在处理相册相关的业务时，可以更加得心应手。github上的开发者针对PhotoKit做了一层很优秀的封装<a href="https://github.com/chiunam/CTAssetsPickerController">CTAssetsPickerController</a>，如果只需要支持iOS8+，那么可定制程度非常高的<a href="https://github.com/chiunam/CTAssetsPickerController">CTAssetsPickerController</a>是个不错的选择。<br>
但是由于现有的业务还是需要支持iOS7，所以并不能完全舍弃使用<code>AssetsLibrary</code>的方式来访问相册。因此也就需要自己封装一套兼容iOS7的相册管理器。</p>

<p>本文涉及代码：<a href="https://github.com/tobevoid/TBVAssetsPicker">TBVAssetsPicker</a></p>

<h3>统一asset以及collection</h3>

<table>
<thead>
<tr>
<th style="text-align:left;"> AssetsLibrary </th>
<th style="text-align:left;"> PhotoKit </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;"> ALAssetsGroup </td>
<td style="text-align:left;"> PHAssetCollection </td>
</tr>
<tr>
<td style="text-align:left;"> ALAsset </td>
<td style="text-align:left;"> PHAsset </td>
</tr>
<tr>
<td style="text-align:left;"> TBVAsset </td>
<td style="text-align:left;"> TBVCollection </td>
</tr>
</tbody>
</table>


<p>相片选择器最终需要向外部提供统一的标识相片的结构。同样，统一结构能让相片选择器更加逻辑优雅地实现内部逻辑。所以这里我声明了两个对应的类：<code>TBVAsset</code>、<code>TBVCollection</code>，并提供一些最基本的功能。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@interface TBVAsset : NSObject
</span><span class='line'>/**
</span><span class='line'> *  PHAsset or ALAsset
</span><span class='line'> */
</span><span class='line'>@property (strong, nonatomic) NSObject  *asset;
</span><span class='line'>
</span><span class='line'>+ (instancetype)assetWithOriginAsset:(NSObject *)asset;
</span><span class='line'>/** 本地标识 */
</span><span class='line'>- (NSString *)assetLocalIdentifer;
</span><span class='line'>/** 源照片尺寸 */
</span><span class='line'>- (CGSize)assetPixelSize;
</span><span class='line'>@end
</span><span class='line'>
</span><span class='line'>@interface TBVCollection : NSObject
</span><span class='line'>/**
</span><span class='line'> *  ALAssetsGroup or PHAssetCollection
</span><span class='line'> */
</span><span class='line'>@property (strong, nonatomic) NSObject  *collection;
</span><span class='line'>
</span><span class='line'>+ (instancetype)collectionWithOriginCollection:(NSObject *)aCollection;
</span><span class='line'>/** 相簿名 */
</span><span class='line'>- (NSString *)collectionTitle;
</span><span class='line'>/** 估算的相簿相片个数 */
</span><span class='line'>- (NSInteger)collectionEstimatedAssetCount;
</span><span class='line'>/** 精确的相簿相片个数 */
</span><span class='line'>- (NSInteger)collectionAccurateAssetCountWithFetchOptions:(id)filterOptions;
</span><span class='line'>- (NSInteger)collectionAccurateAssetCountWithMediaType:(TBVAssetsPickerMediaType)mediaType;
</span><span class='line'>@end</span></code></pre></td></tr></table></div></figure>


<p>有了这些最基本的功能，在实现相册选择器时，就可以方便地对资源进行操作了。<br>
其实对于这部分的兼容处理，主要就是对两个不同的库进行封装，使其呈现同样的外观，后续的几步大体也是围绕这个目标进行。</p>

<h3>封装manager</h3>

<p>由于是两个不同版本的库，并且AssetsLibrary已经在iOS9时被弃用，使用时会产生<code>deprecated</code>警告，所以我分别对<code>ALAssetsLibrary</code>和<code>PHCachingImageManager</code>进行了封装，然后通过统一的接口<code>TBVAssetsManagerProtocol</code>暴露其功能。</p>

<p>一般相册选择器具有如下页面及对应功能（UI展示）：</p>

<ul>
<li>首页

<ul>
<li>相簿名</li>
<li>相簿缩略图</li>
<li>相簿拥有相片数</li>
</ul>
</li>
<li>预览页

<ul>
<li>相片缩略图</li>
<li>选中相片大小</li>
</ul>
</li>
<li>浏览页

<ul>
<li>相片大图</li>
<li>选中相片大小</li>
</ul>
</li>
</ul>


<p>所以我提供的接口如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>//====================================
</span><span class='line'>//              image
</span><span class='line'>//====================================
</span><span class='line'>
</span><span class='line'>/** requestImage返回都是一个RACTuple，first是Image，second是是否为degraded */
</span><span class='line'>
</span><span class='line'>/** 请求特定大小的图片 */
</span><span class='line'>- (RACSignal *)requestImageForAsset:(TBVAsset *)asset
</span><span class='line'>                         targetSize:(CGSize)targetSize
</span><span class='line'>                        contentMode:(TBVAssetsPickerContentMode)contentMode;
</span><span class='line'>/** 请求相簿缩略图 */
</span><span class='line'>- (RACSignal *)requestPosterImageForCollection:(TBVCollection *)collection
</span><span class='line'>                                     mediaType:(TBVAssetsPickerMediaType)mediaType;
</span><span class='line'>
</span><span class='line'>/** 请求相片缩略图 */
</span><span class='line'>- (RACSignal *)requestPosterImageForAsset:(TBVAsset *)asset;
</span><span class='line'>
</span><span class='line'>/** 请求相片原图 */
</span><span class='line'>- (RACSignal *)requestFullResolutionImageForAsset:(TBVAsset *)asset;
</span><span class='line'>
</span><span class='line'>//====================================
</span><span class='line'>//              asset / collection
</span><span class='line'>//====================================
</span><span class='line'>
</span><span class='line'>/** 请求相片资源大小 */
</span><span class='line'>- (RACSignal *)requestSizeForAssets:(NSArray &lt;TBVAsset *&gt; *)assets;
</span><span class='line'>
</span><span class='line'>/** 请求所有相簿 */
</span><span class='line'>- (RACSignal *)requestAllCollections;
</span><span class='line'>
</span><span class='line'>/** 请求所有相片资源 */
</span><span class='line'>- (RACSignal *)requestAssetsForCollection:(TBVCollection *)collection
</span><span class='line'>                                mediaType:(TBVAssetsPickerMediaType)mediaType;
</span><span class='line'>
</span><span class='line'>/** 请求相机胶卷相簿（针对一般业务首先进入相机胶卷的预览页） */
</span><span class='line'>- (RACSignal *)requestCameraRollCollection;
</span><span class='line'>
</span><span class='line'>//====================================
</span><span class='line'>//              video
</span><span class='line'>//====================================
</span><span class='line'>
</span><span class='line'>/** 请求AVPlayerItem */
</span><span class='line'>- (RACSignal *)requestVideoForAsset:(TBVAsset *)asset;
</span><span class='line'>
</span><span class='line'>/** 请求AVURLAsset */
</span><span class='line'>- (RACSignal *)requestURLAssetForAsset:(TBVAsset *)asset;</span></code></pre></td></tr></table></div></figure>


<p>实现以上接口，一般相册选择器的功能点就已经完成大半了。<br></p>

<h2>TBVAssetsPickerManager</h2>

<p>由于自定义的相册manager都遵守<code>TBVAssetsManagerProtocol</code>，<code>TBVAssetsPickerManager</code>
的实现就变得相对简单，没有一大串令人厌烦的<code>if-else</code>。当然<code>TBVAssetsPickerManager</code>本身也是遵守<code>TBVAssetsManagerProtocol</code>的。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>@interface TBVAssetsPickerManager() 
</span><span class='line'>@property (strong, nonatomic) NSObject&lt;TBVAssetsManagerProtocol&gt; *realManager;
</span><span class='line'>@property (strong, nonatomic) NSMutableArray *requestIdList;
</span><span class='line'>@property (assign, nonatomic) BOOL photoKitAvailable;
</span><span class='line'>@end
</span><span class='line'>
</span><span class='line'>#pragma mark life cycle
</span><span class='line'>- (instancetype)init {
</span><span class='line'>    self = [super init];
</span><span class='line'>    if (self) {
</span><span class='line'>        _photoKitAvailable = NSClassFromString(@"PHImageManager") != nil;
</span><span class='line'>    }
</span><span class='line'>    return self;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>#pragma mark TBVAssetsManagerProtocol
</span><span class='line'>....
</span><span class='line'>
</span><span class='line'>#pragma mark getter setter
</span><span class='line'>- (NSObject *)realManager
</span><span class='line'>{
</span><span class='line'>    if (_realManager == nil) {
</span><span class='line'>        if (self.photoKitAvailable) {
</span><span class='line'>            _realManager = [[TBVCachingImageManager alloc] init];
</span><span class='line'>        } else {
</span><span class='line'>            _realManager = [[TBVAssetsLibrary alloc] init];
</span><span class='line'>        }
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    return _realManager;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>这样<code>_realManager</code>拿到的就是当前版本最新的相册manager了。</p>

<h3>接口的实现</h3>

<p>其实接口文档描述的还是非常清晰的，所以这里只是罗列了下代码，并没有针对每一步做解释，因为这些基本的操作进去头文件看看就全明白了。</p>

<h6>- requestImageForAsset:targetSize:(CGSize)targetSize:contentMode:</h6>

<p>这个接口主要用来获取非原图。</p>

<ul>
<li>TBVCachingImageManager

<ul>
<li>关于PHImageRequestOptions的deliveryMode，

<ul>
<li>设置为PHImageRequestOptionsDeliveryModeOpportunistic并且synchronous为NO时，请求可能会先返回一张缩略图，然后再返回一张大图，这个可以通过获取请求回调字典中PHImageResultIsDegradedKey对应value来判别</li>
<li>PHImageRequestOptionsDeliveryModeHighQualityFormat和PHImageRequestOptionsDeliveryModeFastFormat都返回一张图片，只不过前者返回的图片的质量高于或等于请求的质量，而后者可能返回一张质量稍低的图片</li>
</ul>
</li>
</ul>
</li>
<li>TBVAssetsLibrary

<ul>
<li>由于AssetsLibrary并没有提供获取特定尺寸的相片接口，所以这里只是返回thumbnail、aspectRatioThumbnail、fullScreenImage中尺寸和目标大小最接近的一张图片。</li>
</ul>
</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// TBVCachingImageManager
</span><span class='line'>- (RACSignal *)requestImageForAsset:(TBVAsset *)asset
</span><span class='line'>                         targetSize:(CGSize)targetSize
</span><span class='line'>                        contentMode:(TBVAssetsPickerContentMode)contentMode {
</span><span class='line'>    return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        PHImageRequestID requestId = [self.imageManager
</span><span class='line'>                                      requestImageForAsset:(PHAsset *)asset.asset
</span><span class='line'>                                      targetSize:targetSize
</span><span class='line'>                                      contentMode:[self contentModeForCustomContentMode:contentMode]
</span><span class='line'>                                      options:self.defaultImageRequestOptions
</span><span class='line'>                                      resultHandler:^(UIImage * _Nullable result,
</span><span class='line'>                                                      NSDictionary * _Nullable info) {
</span><span class='line'>                                          [subscriber sendNext:RACTuplePack(result, info[PHImageResultIsDegradedKey])];
</span><span class='line'>                                          if (![info[PHImageResultIsDegradedKey] boolValue]) {
</span><span class='line'>                                              [subscriber sendCompleted];
</span><span class='line'>                                          }
</span><span class='line'>                                      }];
</span><span class='line'>        return [RACDisposable disposableWithBlock:^{
</span><span class='line'>            [self.imageManager cancelImageRequest:requestId];
</span><span class='line'>        }];
</span><span class='line'>    }];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// TBVAssetsLibrary
</span><span class='line'>- (RACSignal *)requestImageForAsset:(TBVAsset *)aAsset
</span><span class='line'>                         targetSize:(CGSize)targetSize
</span><span class='line'>                        contentMode:(TBVAssetsPickerContentMode)contentMode {
</span><span class='line'>    return [[[RACSignal return:aAsset.asset]
</span><span class='line'>                deliverOn:[RACScheduler scheduler]]
</span><span class='line'>                map:^id(ALAsset * asset) {
</span><span class='line'>        CGImageRef resultImageRef = nil;
</span><span class='line'>        
</span><span class='line'>        BOOL degraded = NO;
</span><span class='line'>        if (targetSize.width &lt; CGImageGetWidth(asset.thumbnail) &&
</span><span class='line'>            targetSize.height &lt; CGImageGetHeight(asset.thumbnail)) {
</span><span class='line'>            // TBVAssetsPickerContentModeFill
</span><span class='line'>            resultImageRef = asset.thumbnail;
</span><span class='line'>            degraded = YES;
</span><span class='line'>        }
</span><span class='line'>        if (!resultImageRef) {
</span><span class='line'>            CGImageRef aspectRatioThumbnail = asset.aspectRatioThumbnail;
</span><span class='line'>            if (targetSize.width &lt; CGImageGetWidth(aspectRatioThumbnail) &&
</span><span class='line'>                targetSize.height &lt; CGImageGetHeight(aspectRatioThumbnail)) {
</span><span class='line'>                // TBVAssetsPickerContentModeFit
</span><span class='line'>                resultImageRef = aspectRatioThumbnail;
</span><span class='line'>            }
</span><span class='line'>            if (!resultImageRef) {
</span><span class='line'>                ALAssetRepresentation *assetRepresentation = [asset defaultRepresentation];
</span><span class='line'>                resultImageRef = [assetRepresentation fullScreenImage];
</span><span class='line'>            }
</span><span class='line'>        }
</span><span class='line'>        UIImage *resultImage = nil;
</span><span class='line'>        if (resultImageRef) {
</span><span class='line'>            resultImage = [UIImage imageWithCGImage:resultImageRef
</span><span class='line'>                                              scale:BQAP_SCREEN_SCALE
</span><span class='line'>                                        orientation:UIImageOrientationUp];
</span><span class='line'>        }
</span><span class='line'>        return RACTuplePack(resultImage, @(degraded));
</span><span class='line'>    }];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h6>-requestPosterImageForCollection:mediaType:</h6>

<ul>
<li>TBVCachingImageManager

<ul>
<li>通过-fetchKeyAssetsInAssetCollection:options:获取相簿keyAssets，最多可以返回三个</li>
<li>最终还是通过requestPosterImageForAsset:获取缩略图</li>
<li>获取keyAssets前，需要设置options对资源进行过滤：</li>
</ul>
</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (instancetype)tbv_fetchOptionsWithCustomMediaType:(TBVAssetsPickerMediaType)mediaType {
</span><span class='line'>    NSArray *mediaTypes = [self tbv_mediaTypesWithCustonMediaType:mediaType];
</span><span class='line'>    if (!mediaTypes.count) return nil;
</span><span class='line'>    
</span><span class='line'>    PHFetchOptions *options = [[PHFetchOptions alloc] init];
</span><span class='line'>    NSMutableString *predicateString = [NSMutableString string];
</span><span class='line'>    for (NSNumber *mediaType in mediaTypes) {
</span><span class='line'>        [predicateString appendFormat:@"mediaType = %@", mediaType];
</span><span class='line'>        if (![mediaType isEqual:mediaTypes.lastObject]) [predicateString appendString:@" || "];
</span><span class='line'>    }
</span><span class='line'>    options.predicate = [NSPredicate predicateWithFormat:predicateString];
</span><span class='line'>    return options;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<ul>
<li>TBVAssetsLibrary

<ul>
<li>ALAssetsGroup有posterImage属性，直接返回相簿缩略图</li>
<li>和PhotoKit不同，AssetLibrary通过ALAssetsGroup的setAssetsFilter方法进行过滤</li>
</ul>
</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[group setAssetsFilter:[ALAssetsFilter tbv_assetsFilterWithCustomMediaType:mediaType]];</span></code></pre></td></tr></table></div></figure>


<p>这样设置以后，后续针对group的操作都会在过滤的结果中进行了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// TBVCachingImageManager
</span><span class='line'>- (RACSignal *)requestPosterImageForCollection:(TBVCollection *)collection
</span><span class='line'>                              mediaType:(TBVAssetsPickerMediaType)mediaType {
</span><span class='line'>    return [[RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        PHFetchOptions *fetchOptions = [PHFetchOptions tbv_fetchOptionsWithCustomMediaType:mediaType];
</span><span class='line'>        fetchOptions.sortDescriptors = @[[NSSortDescriptor sortDescriptorWithKey:@"creationDate"
</span><span class='line'>                                                                       ascending:YES]];
</span><span class='line'>        PHAssetCollection *realCollection = (PHAssetCollection *)collection.collection;
</span><span class='line'>        /* fetchKeyAssetsInAssetCollection 获取至多三张 */
</span><span class='line'>        PHFetchResult *result = [PHAsset fetchKeyAssetsInAssetCollection:realCollection
</span><span class='line'>                                                                 options:fetchOptions];
</span><span class='line'>        if (!result.count) {
</span><span class='line'>            [subscriber sendNext:[RACSignal empty]];
</span><span class='line'>            [subscriber sendCompleted];
</span><span class='line'>            return nil;
</span><span class='line'>        }
</span><span class='line'>        
</span><span class='line'>        TBVAsset *posterAsset = [TBVAsset assetWithOriginAsset:result.firstObject];
</span><span class='line'>        [subscriber sendNext:[self requestPosterImageForAsset:posterAsset]];
</span><span class='line'>        [subscriber sendCompleted];
</span><span class='line'>        return nil;
</span><span class='line'>    }] switchToLatest];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// TBVAssetsLibrary
</span><span class='line'>- (RACSignal *)requestAssetsForCollection:(TBVCollection *)collection
</span><span class='line'>                                mediaType:(TBVAssetsPickerMediaType)mediaType {
</span><span class='line'>    return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        NSMutableArray *assets = [NSMutableArray array];
</span><span class='line'>        ALAssetsGroup *group = (ALAssetsGroup *)collection.collection;
</span><span class='line'>        [group setAssetsFilter:[ALAssetsFilter tbv_assetsFilterWithCustomMediaType:mediaType]];
</span><span class='line'>        [group enumerateAssetsUsingBlock:^(ALAsset *result, NSUInteger index, BOOL *stop) {
</span><span class='line'>            if (result) {
</span><span class='line'>                [assets addObject:[TBVAsset assetWithOriginAsset:result]];
</span><span class='line'>            } else {
</span><span class='line'>                [subscriber sendNext:assets];
</span><span class='line'>                [subscriber sendCompleted];
</span><span class='line'>            }
</span><span class='line'>        }];
</span><span class='line'>        return nil;
</span><span class='line'>    }];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h6>-requestPosterImageForAsset:</h6>

<p>获取asset的缩略图，需要注意的一点就是：在获取缩略图的情况下，Fill比Fit获取的图片要清晰</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>// TBVCachingImageManager
</span><span class='line'>- (RACSignal *)requestPosterImageForAsset:(TBVAsset *)asset {
</span><span class='line'>    return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        CGSize posterSize = CGSizeMake(kBQPosterImageWidth * BQAP_SCREEN_SCALE,
</span><span class='line'>                                       kBQPosterImageHeight * BQAP_SCREEN_SCALE);
</span><span class='line'>        /* 在获取缩略图的情况下，Fill比Fit获取的图片要清晰 */
</span><span class='line'>        PHImageRequestID requestId = [self.imageManager
</span><span class='line'>                                      requestImageForAsset:(PHAsset *)asset.asset
</span><span class='line'>                                      targetSize:posterSize
</span><span class='line'>                                      contentMode:PHImageContentModeAspectFill
</span><span class='line'>                                      options:self.defaultImageRequestOptions
</span><span class='line'>                                      resultHandler:^(UIImage * _Nullable result,
</span><span class='line'>                                                      NSDictionary * _Nullable info) {
</span><span class='line'>                                          [subscriber sendNext:RACTuplePack(result, info[PHImageResultIsDegradedKey])];
</span><span class='line'>                                          if (![info[PHImageResultIsDegradedKey] boolValue]) {
</span><span class='line'>                                              [subscriber sendCompleted];
</span><span class='line'>                                          }
</span><span class='line'>                                      }];
</span><span class='line'>        return [RACDisposable disposableWithBlock:^{
</span><span class='line'>            [self.imageManager cancelImageRequest:requestId];
</span><span class='line'>        }];
</span><span class='line'>    }];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// TBVAssetsLibrary
</span><span class='line'>- (RACSignal *)requestPosterImageForAsset:(TBVAsset *)asset {
</span><span class='line'>    return [[RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        CGSize posterSize = CGSizeMake(kBQPosterImageWidth * BQAP_SCREEN_SCALE,
</span><span class='line'>                                       kBQPosterImageHeight * BQAP_SCREEN_SCALE);
</span><span class='line'>        [subscriber sendNext:[self requestImageForAsset:asset
</span><span class='line'>                                             targetSize:posterSize
</span><span class='line'>                                            contentMode:TBVAssetsPickerContentModeFill]];
</span><span class='line'>        [subscriber sendCompleted];
</span><span class='line'>        return nil;
</span><span class='line'>    }] switchToLatest];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h6>-requestFullResolutionImageForAsset:</h6>

<p>获取原图时有一点很重要，就是尽量不要快速连续地获取原图，大图也可以列入这个范畴。连续地获取大图或者原图，设备的内存会急剧增高，甚至崩溃，这种情况通常在上传图片时比较常见。
所以在上传图片时，尽量上传一张原图后再获取下一张原图进行上传，而不是全部获取完成之后再上传。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// TBVCachingImageManager
</span><span class='line'>- (RACSignal *)requestFullResolutionImageForAsset:(TBVAsset *)asset {
</span><span class='line'>    return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        self.defaultImageRequestOptions.networkAccessAllowed = YES;
</span><span class='line'>        PHImageRequestID requestId = [self.imageManager
</span><span class='line'>                                      requestImageForAsset:(PHAsset *)asset.asset
</span><span class='line'>                                      targetSize:PHImageManagerMaximumSize
</span><span class='line'>                                      contentMode:PHImageContentModeDefault
</span><span class='line'>                                      options:self.defaultImageRequestOptions
</span><span class='line'>                                      resultHandler:^(UIImage * _Nullable result,
</span><span class='line'>                                                      NSDictionary * _Nullable info) {
</span><span class='line'>                                          [subscriber sendNext:RACTuplePack(result, info[PHImageResultIsDegradedKey])];
</span><span class='line'>                                          if (![info[PHImageResultIsDegradedKey] boolValue]) {
</span><span class='line'>                                              [subscriber sendCompleted];
</span><span class='line'>                                          }
</span><span class='line'>                                      }];
</span><span class='line'>        return [RACDisposable disposableWithBlock:^{
</span><span class='line'>            [self.imageManager cancelImageRequest:requestId];
</span><span class='line'>        }];
</span><span class='line'>    }];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// TBVAssetsLibrary
</span><span class='line'>- (RACSignal *)requestFullResolutionImageForAsset:(TBVAsset *)asset {
</span><span class='line'>    return [[[RACSignal return:asset.asset]
</span><span class='line'>        deliverOn:[RACScheduler scheduler]]
</span><span class='line'>        map:^id(ALAsset * asset) {
</span><span class='line'>            ALAssetRepresentation *assetRepresentation = [asset defaultRepresentation];
</span><span class='line'>            CGImageRef fullResolutionImage = [assetRepresentation fullResolutionImage];
</span><span class='line'>            UIImage *resultImage = [UIImage imageWithCGImage:fullResolutionImage
</span><span class='line'>                                                       scale:BQAP_SCREEN_SCALE
</span><span class='line'>                                                 orientation:UIImageOrientationUp];
</span><span class='line'>            
</span><span class='line'>            return RACTuplePack(resultImage, @(NO));
</span><span class='line'>        }];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h6>-requestSizeForAssets:</h6>

<p>请求大小是针对的图片，所以对非图片的asset进行了过滤</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// TBVCachingImageManager
</span><span class='line'>- (RACSignal *)requestSizeForAssets:(NSArray&lt;TBVAsset *&gt; *)assets {
</span><span class='line'>    RACSequence *requestSequence = [[assets.rac_sequence
</span><span class='line'>        filter:^BOOL(TBVAsset *asset) {
</span><span class='line'>            return ((PHAsset *)asset.asset).mediaType == PHAssetMediaTypeImage;
</span><span class='line'>        }]
</span><span class='line'>        map:^id(TBVAsset *asset) {
</span><span class='line'>            return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>                self.defaultImageRequestOptions.deliveryMode = PHImageRequestOptionsDeliveryModeHighQualityFormat;
</span><span class='line'>                PHImageRequestID requestId =[self.imageManager
</span><span class='line'>                                             requestImageDataForAsset:(PHAsset *)asset.asset
</span><span class='line'>                                             options:self.defaultImageRequestOptions
</span><span class='line'>                                             resultHandler:^(NSData * _Nullable imageData,
</span><span class='line'>                                                             NSString * _Nullable dataUTI,
</span><span class='line'>                                                             UIImageOrientation orientation,
</span><span class='line'>                                                             NSDictionary * _Nullable info) {
</span><span class='line'>                                                 [subscriber sendNext:@(imageData.length)];
</span><span class='line'>                                                 [subscriber sendCompleted];
</span><span class='line'>                                             }];
</span><span class='line'>                return [RACDisposable disposableWithBlock:^{
</span><span class='line'>                    [self.imageManager cancelImageRequest:requestId];
</span><span class='line'>                }];
</span><span class='line'>            }];
</span><span class='line'>        }];
</span><span class='line'>    
</span><span class='line'>    return [[RACSignal
</span><span class='line'>        zip:requestSequence]
</span><span class='line'>        map:^id(RACTuple *value) {
</span><span class='line'>            return [value.rac_sequence foldLeftWithStart:@0 reduce:^id(id accumulator, id value) {
</span><span class='line'>                return @([accumulator integerValue] + [value integerValue]);
</span><span class='line'>            }];
</span><span class='line'>        }];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// TBVAssetsLibrary
</span><span class='line'>- (RACSignal *)requestSizeForAssets:(NSArray&lt;TBVAsset *&gt; *)assets {
</span><span class='line'>    return [RACSignal
</span><span class='line'>        return:[[[[assets.rac_sequence
</span><span class='line'>            map:^id(TBVAsset *asset) {
</span><span class='line'>               return asset.asset;
</span><span class='line'>            }]
</span><span class='line'>            filter:^BOOL(ALAsset *asset) {
</span><span class='line'>                return [asset valueForProperty:ALAssetPropertyType] == ALAssetTypePhoto;
</span><span class='line'>            }]
</span><span class='line'>            map:^id(ALAsset *asset) {
</span><span class='line'>                return @([asset defaultRepresentation].size);
</span><span class='line'>            }]
</span><span class='line'>            foldLeftWithStart:@(0) reduce:^id(id accumulator, id value) {
</span><span class='line'>                return @([accumulator integerValue] + [value integerValue]);
</span><span class='line'>            }]];
</span><span class='line'>    
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h6>-requestAllCollections</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// TBVCachingImageManager
</span><span class='line'>- (RACSignal *)requestAllCollections {
</span><span class='line'>    return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        PHFetchResult *smartResult = [PHAssetCollection
</span><span class='line'>                                      fetchAssetCollectionsWithType:PHAssetCollectionTypeSmartAlbum
</span><span class='line'>                                      subtype:PHAssetCollectionSubtypeAlbumRegular
</span><span class='line'>                                      options:nil];
</span><span class='line'>        PHFetchResult *topLevelUserCollections = [PHCollectionList fetchTopLevelUserCollectionsWithOptions:nil];
</span><span class='line'>        
</span><span class='line'>        NSMutableArray *collections = [NSMutableArray array];
</span><span class='line'>        for (PHAssetCollection *aCollection in smartResult) {
</span><span class='line'>            TBVCollection *collection = [TBVCollection collectionWithOriginCollection:aCollection];
</span><span class='line'>            [collections addObject:collection];
</span><span class='line'>        }
</span><span class='line'>        for (PHAssetCollection *aCollection in topLevelUserCollections) {
</span><span class='line'>            TBVCollection *collection = [TBVCollection collectionWithOriginCollection:aCollection];
</span><span class='line'>            [collections addObject:collection];
</span><span class='line'>        }
</span><span class='line'>        [subscriber sendNext:collections];
</span><span class='line'>        [subscriber sendCompleted];
</span><span class='line'>        return nil;
</span><span class='line'>    }];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// TBVAssetsLibrary
</span><span class='line'>- (RACSignal *)requestAllCollections {
</span><span class='line'>    return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        NSMutableArray *collections = [NSMutableArray array];
</span><span class='line'>        [self.assetsLibrary enumerateGroupsWithTypes:ALAssetsGroupAll
</span><span class='line'>                                          usingBlock:^(ALAssetsGroup *group, BOOL *stop) {
</span><span class='line'>            if (group) {
</span><span class='line'>                TBVCollection *collection = [TBVCollection collectionWithOriginCollection:group];
</span><span class='line'>                [collections addObject:collection];
</span><span class='line'>            } else {
</span><span class='line'>                [subscriber sendNext:collections];
</span><span class='line'>                [subscriber sendCompleted];
</span><span class='line'>            }
</span><span class='line'>        } failureBlock:^(NSError *error) {
</span><span class='line'>            [subscriber sendError:error];
</span><span class='line'>        }];
</span><span class='line'>        return nil;
</span><span class='line'>    }];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h6>-requestAssetsForCollection:mediaType:</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// TBVCachingImageManager
</span><span class='line'>- (RACSignal *)requestAssetsForCollection:(TBVCollection *)collection
</span><span class='line'>                                mediaType:(TBVAssetsPickerMediaType)mediaType {
</span><span class='line'>    return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        PHFetchOptions *options = [PHFetchOptions tbv_fetchOptionsWithCustomMediaType:mediaType];
</span><span class='line'>        PHFetchResult *fetchResult = [PHAsset fetchAssetsInAssetCollection:(PHAssetCollection *)collection.collection
</span><span class='line'>                                                                   options:options];
</span><span class='line'>        NSMutableArray *assets = [NSMutableArray arrayWithCapacity:fetchResult.count];
</span><span class='line'>        for (PHAsset *asset in fetchResult) {
</span><span class='line'>            [assets addObject:[TBVAsset assetWithOriginAsset:asset]];
</span><span class='line'>        }
</span><span class='line'>        [subscriber sendNext:assets];
</span><span class='line'>        [subscriber sendCompleted];
</span><span class='line'>        return nil;
</span><span class='line'>    }];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// TBVAssetsLibrary
</span><span class='line'>- (RACSignal *)requestAssetsForCollection:(TBVCollection *)collection
</span><span class='line'>                                mediaType:(TBVAssetsPickerMediaType)mediaType {
</span><span class='line'>    return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        NSMutableArray *assets = [NSMutableArray array];
</span><span class='line'>        ALAssetsGroup *group = (ALAssetsGroup *)collection.collection;
</span><span class='line'>        [group setAssetsFilter:[ALAssetsFilter tbv_assetsFilterWithCustomMediaType:mediaType]];
</span><span class='line'>        [group enumerateAssetsUsingBlock:^(ALAsset *result, NSUInteger index, BOOL *stop) {
</span><span class='line'>            if (result) {
</span><span class='line'>                [assets addObject:[TBVAsset assetWithOriginAsset:result]];
</span><span class='line'>            } else {
</span><span class='line'>                [subscriber sendNext:assets];
</span><span class='line'>                [subscriber sendCompleted];
</span><span class='line'>            }
</span><span class='line'>        }];
</span><span class='line'>        return nil;
</span><span class='line'>    }];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h6>-requestCameraRollCollection</h6>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>// TBVCachingImageManager
</span><span class='line'>- (RACSignal *)requestCameraRollCollection {
</span><span class='line'>    return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        PHFetchResult *smartAlbums = [PHAssetCollection
</span><span class='line'>                                      fetchAssetCollectionsWithType:PHAssetCollectionTypeSmartAlbum
</span><span class='line'>                                      subtype:PHAssetCollectionSubtypeSmartAlbumUserLibrary
</span><span class='line'>                                      options:nil];
</span><span class='line'>        [subscriber sendNext:[TBVCollection collectionWithOriginCollection:smartAlbums.firstObject]];
</span><span class='line'>        [subscriber sendCompleted];
</span><span class='line'>        return nil;
</span><span class='line'>    }];
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>// TBVAssetsLibrary
</span><span class='line'>- (RACSignal *)requestCameraRollCollection {
</span><span class='line'>    return [RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        [self.assetsLibrary enumerateGroupsWithTypes:ALAssetsGroupSavedPhotos usingBlock:^(ALAssetsGroup *group, BOOL *stop) {
</span><span class='line'>            [subscriber sendNext:[TBVCollection collectionWithOriginCollection:group]];
</span><span class='line'>            [subscriber sendCompleted];
</span><span class='line'>        } failureBlock:^(NSError *error) {
</span><span class='line'>            [subscriber sendError:error];
</span><span class='line'>        }];
</span><span class='line'>        return nil;
</span><span class='line'>    }];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h6>-requestVideoForAsset:和-requestURLAssetForAsset:</h6>

<p>由于业务上没有视频的需求，所以这一块还没有去实现。</p>

<h3>实现过程中的一些小坑</h3>

<h6>用ALAssetsLibrary申请访问相册权限</h6>

<p>这一点貌似有些代码用authorizationStatus就能实现，不过
应用的时候还是发现不能出发请求权限alert，所以这里需要访问下相册的资源<a href="http://stackoverflow.com/questions/13572220/ask-permission-to-access-camera-roll">ask-permission-to-access-camera-roll</a>，
来出发这个请求动作：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+ (RACSignal *)tbv_forceTriggerPermissionAsking {
</span><span class='line'>    return [[RACSignal createSignal:^RACDisposable *(id&lt;RACSubscriber&gt; subscriber) {
</span><span class='line'>        void (^sendStatus)() = ^{
</span><span class='line'>            [subscriber sendNext:@([self tbv_authorizationStatus])];
</span><span class='line'>            [subscriber sendCompleted];
</span><span class='line'>        };
</span><span class='line'>        
</span><span class='line'>        if ([self tbv_authorizationStatus] != BQAuthorizationStatusNotDetermined) {
</span><span class='line'>            sendStatus();
</span><span class='line'>            return nil;
</span><span class='line'>        }
</span><span class='line'>        ALAssetsLibrary *lib = [[ALAssetsLibrary alloc] init];
</span><span class='line'>        [lib enumerateGroupsWithTypes:ALAssetsGroupSavedPhotos usingBlock:^(ALAssetsGroup *group, BOOL *stop) {
</span><span class='line'>            sendStatus();
</span><span class='line'>            *stop = YES;
</span><span class='line'>        } failureBlock:^(NSError *error) {
</span><span class='line'>            sendStatus();
</span><span class='line'>        }];
</span><span class='line'>        return nil;
</span><span class='line'>    }] deliverOnMainThread];
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h6>ALAssetsLibrary请求的ALAsset被置空问题</h6>

<p>官方文档里面有这么一句：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>The lifetimes of objects you get back from a library instance are tied to the lifetime of the library instance.</span></code></pre></td></tr></table></div></figure>


<p>可以看到，在使用ALAssetsLibrary请求回来的资源时，是不能释放对应的ALAssetsLibrary对象的。在发送多图的场合，如果不注意保持住ALAssetsLibrary对象，很容易发生后面几张图片获取不到的情况。</p>

<p>所以，要么在选择器返回选中的资源时，强引用对应的manager，要么这个manager由调用者传给相册选择器。</p>

<h6>更改应用权限并切回前台</h6>

<p>如果应用在后台时，更改了权限，当切回前台后，App会重新启动 。这里如果设置了断点，别以为是程序崩了。</p>

<h3>不足</h3>

<p>一个很明显的问题是使用了RAC的版本后，相册选择器滚动的性能会下降，没有以前通过回调来的顺畅。如果稍微快速一点滚动的话，CPU很容易就上100%。</p>

<p>可能是使用RAC的方式不是很正确造成的，后续尽可能优化这一块。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">tripleCC</span></span>

      




<time class='entry-date' datetime='2016-09-10T21:25:36+08:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>10</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>9:25 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016-08-10-ioszhi-shi-sui-pian-liu/" title="Previous Post: iOS知识碎片六">&laquo; iOS知识碎片六</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>关于我</h1>
  <p> 喜欢技术，喜欢Ubuntu，喜欢字符终端，热衷底层，涉略微处理器、Linux，最终加入移动大家庭 </p>
  <a href="http://www.jianshu.com/users/97e39e95c2cc" style="color: coral"> 访问我的简书 </a><br>
  <a href="https://github.com/tripleCC" style="color: coral"> 访问我的github </a><br>
  <a href="https://twitter.com/tripleCCBrian" style="color: coral"> 我的twitter </a>
</section>
<section>
  <h1>最近发布</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016-09-10-shi-yong-assetslibraryhe-photokitzuo-%5B%3F%5D-ge-xiang-pian-xuan-ze-qi/">使用AssetsLibrary和PhotoKit做一个简易的相片选择器</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016-08-10-ioszhi-shi-sui-pian-liu/">iOS知识碎片六</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016-06-05-yymodelyue-du-xiao-ji/">YYModel阅读小记</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016-05-12-mqttshi-yong-xiao-ji/">MQTT使用小记</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016-04-23-geng-jia-kuai-su-di-she-zhi-frame/">更加快速地设置Frame</a>
      </li>
    
  </ul>
</section>




<section>
    <h1>友情链接</h1>
    <ul>
        <li>
            <a href="http://wxgbridgeq.github.io/">小乔的个人学习博客</a>
        </li>
    </ul>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - tripleCC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
