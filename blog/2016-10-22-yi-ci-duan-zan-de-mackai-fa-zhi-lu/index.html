
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>一次短暂的mac开发之旅 - tripleCC的技术博客</title>
  <meta name="author" content="tripleCC">

  
  <meta name="description" content="回杭近一周，发现公司后台写的接口文档还是比较清晰的。特别是自己组负责的业务线，接口文档上的字段和实际返回的字段几乎没有差别。 询问了周围小伙伴如何写模型文件之后，发现无非三种方式： 手写啦＝＝
Xcode8以前的用ESJsonFormat插件，Xcode8以后手写
用JSONExport生成 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="/atom.xml" rel="alternate" title="tripleCC的技术博客" type="application/atom+xml">
  
  <link rel="canonical" href="http://triplecc.github.io/blog/2016-10-22-yi-ci-duan-zan-de-mackai-fa-zhi-lu/">
  <link href="/favicon.png" rel="shortcut icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--[good job! gfw]><script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script><!-->
  <script src="http://cdn.staticfile.org/jquery/1.9.1/jquery.min.js"></script>
  <link href="/stylesheets/google-fonts.css" rel="stylesheet" type="text/css">
  

  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">tripleCC的技术博客</a></h1>
  
    <h2>ʕ•̫͡•ʔ-̫͡-ʕ•͓͡•ʔ-̫͡-ʕ•̫͡•ʔ-̫͡-ʕ•͓͡•ʔ-̫͡-ʔ</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="triplecc.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">一次短暂的mac开发之旅</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-10-22T22:43:37+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>10:43 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>回杭近一周，发现公司后台写的接口文档还是比较清晰的。特别是自己组负责的业务线，接口文档上的字段和实际返回的字段几乎没有差别。</p>

<p>询问了周围小伙伴如何写模型文件之后，发现无非三种方式：</p>

<ul>
<li>手写啦＝＝</li>
<li><code>Xcode8</code>以前的用<code>ESJsonFormat</code>插件，<code>Xcode8</code>以后手写</li>
<li>用<code>JSONExport</code>生成</li>
</ul>


<p>针对以上三种方式，我做了一个简短的分析：</p>

<ul>
<li>这个不用说了，耗时费力不讨好。量少好说，量大就比较蛋疼了。</li>
<li><code>xcode8</code>之后，第三方插件被禁止了。虽说有方法能让<code>xcode8</code>重新用上这个插件，但是即使用上了这个插件，还是需要自己写注释，并且生成模型需要后台返回的<code>json</code>。</li>
<li>和上一个方式一样，只是从插件编程了<code>mac</code>软件</li>
</ul>


<p>在打听完后，我随即产生了自己写一个转换工具的想法。</p>

<p>原因如下：</p>

<ul>
<li>后台文档已经写的比较清晰，可以从网页上把这些数据都爬下来，然后生成含有注释的模型</li>
<li>可以自动将<code>Vo</code>结尾的模型和属性，转成<code>Model</code>结尾的模型和属性，并且生成<code>YYModel</code>需要的映射关系</li>
<li>因为接口文档都处于一个统一的<code>baseURL</code>下，加上模型名称就是完整路径，所以可以很方便地进行批量处理</li>
<li>不需要测试后台发布的接口后，再通过获取接口返回的<code>json</code>生成模型；只要接口文档一发布就可以生成模型</li>
</ul>


<!--more-->


<p>然后我花了一个周末的时间，完成了一个简易的模型抓取生成工具。具体界面如下：<br></p>

<p><img src="/images/2016-10-30fetcher.png" alt="" /></p>

<p>输入浏览公司内部资料所需要的用户名和密码，并且输入自己需要的抓取的模型名，点击开始抓取，然后就等桌面上生成对应的模型文件了。当然，在界面上的预览窗口可以看到生成文件的内容，以及生成文件的保存地址。</p>

<p>话不多说，接下来记录下自己写这个<code>mac</code>工具的过程。</p>

<h3>确认要抓取的内容及条件</h3>

<p>首先看下需要抓取内容的HTML:<br></p>

<p><img src="/images/2016-10-30xpath.png" alt="" /></p>

<p>可以看到，拿到第一个标签为<code>table</code>、类名为<code>confluenceTable</code>的元素，然后再取第一个标签为<code>tbody</code>的元素即可获取所有需要的数据。</p>

<p>最后，查看接口需要在登录状态，所以得在<code>chrome</code>的开发者工具中获取登录请求的<code>URL</code>和参数。由于接口文档所在服务器搭在公司内网，所以并没有太过复杂的验证，还是比较方便的。</p>

<h3>确定使用的技术</h3>

<p>由于对<code>Python</code>还不是很熟悉，所以还是先使用<code>swift</code>来写。选用的框架如下：</p>

<ul>
<li>RxSwift</li>
<li>Ji (HTML解析用)</li>
<li>Moya</li>
</ul>


<p>最后说下<code>mac</code>开发，我直接采用了<code>storyboard</code>的方式。主要是自己以前没有接触过<code>mac</code>开发，使用IB能降低难度和开发时间。</p>

<h3>实际开发过程</h3>

<p>数据获取解析和软件界面逻辑编写的时间占比大概在7-3左右。<br></p>

<h5>数据获取解析</h5>

<p>通过<code>Moya</code>请求获取<code>HTML</code>就不说了，主要记录下如何使用<code>Ji</code>来解析<code>HTML</code>。</p>

<p>获取第一个标签为<code>table</code>、类名为<code>confluenceTable</code>的元素代码如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="k">extension</span> <span class="n">TDFInterfaceFetcherHTMLParser</span>  <span class="p">{</span>
</span><span class='line'>    <span class="k">var</span> <span class="nl">firstTableBody</span><span class="p">:</span> <span class="p">[</span><span class="n">JiNode</span><span class="p">]</span><span class="o">?</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">firstContentTable</span><span class="p">.</span><span class="n">flatMap</span><span class="p">{</span> <span class="err">$</span><span class="mf">0.f</span><span class="n">irstChildWithName</span><span class="p">(</span><span class="s">&quot;tbody&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">children</span> <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">private</span> <span class="k">var</span> <span class="nl">firstContentTable</span><span class="p">:</span> <span class="n">JiNode</span><span class="o">?</span><span class="p">{</span>
</span><span class='line'>        <span class="k">let</span> <span class="n">lastTable</span> <span class="o">=</span> <span class="n">rootNode</span><span class="o">?</span>
</span><span class='line'>            <span class="p">.</span><span class="n">descendantsWithName</span><span class="p">(</span><span class="s">&quot;table&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="p">.</span><span class="n">filter</span><span class="p">{</span> <span class="err">$</span><span class="mf">0.</span><span class="n">attributes</span><span class="p">[</span><span class="s">&quot;class&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;confluenceTable&quot;</span> <span class="p">}</span>
</span><span class='line'>            <span class="p">.</span><span class="n">first</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">lastTable</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>descendantsWithName("table")</code>可以获取所有标签为<code>table</code>的元素</li>
<li><code>JiNode</code>的<code>attributes</code>是标签所有属性的键值对，这里过滤掉<code>class</code>不是<code>confluenceTable</code>的<code>JiNode</code></li>
<li><code>JiNode</code>的<code>firstChildWithName("tbody").children</code>可以获取子节点中，第一个标签为<code>tbody</code>的元素的所有子节点。</li>
</ul>


<p>得到所有目标子节点后，再通过以下方法获取叶子节点：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="c1">//1、是叶子节点，添加到数组</span>
</span><span class='line'><span class="c1">//2、不是叶子节点，遍历其所有子节点</span>
</span><span class='line'>
</span><span class='line'><span class="k">extension</span> <span class="n">JiNode</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">func</span> <span class="n">allLeafNodes</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">[</span><span class="n">JiNode</span><span class="p">]</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">var</span> <span class="n">leafNodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">JiNode</span><span class="p">]()</span>
</span><span class='line'>        <span class="k">if</span> <span class="o">!</span><span class="n">hasChildren</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">leafNodes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">children</span><span class="p">.</span><span class="n">forEach</span> <span class="p">{</span>
</span><span class='line'>                <span class="n">leafNodes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nl">contentsOf</span><span class="p">:</span> <span class="err">$</span><span class="mf">0.</span><span class="n">allLeafNodes</span><span class="p">())</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">leafNodes</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接下来通过<code>JiNode</code>的<code>value</code>属性获取所有叶子节点对应元素的内容就好了：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="n">firstTableBody</span><span class="p">.</span><span class="n">map</span><span class="p">{</span> <span class="err">$</span><span class="mf">0.</span><span class="n">allLeafNodes</span><span class="p">().</span><span class="n">flatMap</span><span class="p">{</span> <span class="err">$</span><span class="mf">0.</span><span class="n">value</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>经过上面代码的处理，输出的数据如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='swift'><span class='line'><span class="p">[</span><span class="s">&quot;编号&quot;</span><span class="p">,</span> <span class="s">&quot;参数名（中文）&quot;</span><span class="p">,</span> <span class="s">&quot;参数名（英文）&quot;</span><span class="p">,</span> <span class="s">&quot;类型&quot;</span><span class="p">,</span> <span class="s">&quot;对应表&quot;</span><span class="p">,</span> <span class="s">&quot;对应字段&quot;</span><span class="p">,</span> <span class="s">&quot;备注&quot;</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;采购单ID&quot;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="s">&quot;String&quot;</span><span class="p">,</span> <span class="s">&quot;purchase_info&quot;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="s">&quot;　&quot;</span><span class="p">]</span>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK！后面的事情就相对简单了，主要是结合<code>Objective-C</code>的语法以及自身采用的<code>JSON</code>转模型框架来对上面的数组进行加工。项目里采用的是YYModel，所以最终输出结果大致如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">//======================================    </span>
</span><span class='line'><span class="c1">// TDFPurchaseModel.h    </span>
</span><span class='line'><span class="c1">//====================================== </span>
</span><span class='line'><span class="cp">#import &lt;Foundation/Foundation.h&gt;  </span>
</span><span class='line'>  
</span><span class='line'><span class="k">@interface</span> <span class="nc">TDFPurchaseModel</span> : <span class="bp">NSObject</span> 
</span><span class='line'><span class="cm">/** 采购单ID */</span>    
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">copy</span><span class="p">)</span> <span class="bp">NSString</span> <span class="o">*</span><span class="kt">id</span><span class="p">;</span> 
</span><span class='line'>
</span><span class='line'><span class="p">......</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//====================================== </span>
</span><span class='line'><span class="c1">// TDFPurchaseModel.m    </span>
</span><span class='line'><span class="c1">//====================================== </span>
</span><span class='line'><span class="cp">#import &quot;TDFPurchaseModel.h&quot;   </span>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">TDFPurchaseModel</span>   
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="n">nullable</span> <span class="bp">NSDictionary</span><span class="o">&lt;</span><span class="bp">NSString</span> <span class="o">*</span><span class="p">,</span> <span class="kt">id</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)</span><span class="nf">modelCustomPropertyMapper</span> <span class="p">{</span>    
</span><span class='line'>  <span class="k">return</span> <span class="l">@{</span> 
</span><span class='line'>      <span class="s">@&quot;purchaseDetails&quot;</span> <span class="o">:</span> <span class="s">@&quot;purchaseDetailsVo&quot;</span>  
</span><span class='line'>  <span class="l">}</span><span class="p">;</span>    
</span><span class='line'><span class="p">}</span>  
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<h5>软件界面逻辑编写</h5>

<p><code>mac</code>界面的搭建，我主要参考了<code>JSONExport</code>。不过对于没有接触过<code>mac</code>开发的我来说，直接上手去拖拽控件还是出现了一些问题。</p>

<p>记忆最深的是在<code>mac</code>开发中，拖拽到<code>storyboard</code>中的控件，其内部可能内置多个子控件。当我直接以<code>iOS</code>开发在<code>storyboard</code>中拖拽控件的方式设置约束时，就会出现一些问题：</p>

<p><img src="/images/Snip20161030_1.png" alt="" /></p>

<p>这样的约束是针对内部的<code>NSTextView</code>设置的，当输入文本超过父控件时，依赖于<code>NSTextView</code>高度约束的控件会发生变化。所以应该像下面这样，在侧边栏设置：</p>

<p><img src="/images/Snip20161030_3.png" alt="" /></p>

<p>至于其它，由于只是搭了一个简单的界面，也不好说些啥。不过现在感觉做<code>iOS</code>开发的，上手<code>mac</code>开发还是相对容易一些。</p>

<h3>总结</h3>

<p>写这个软件大概花了我一天半的时间，不过应该能给身边的小伙伴省下一些不必要的时间开销，还是挺高兴的。<br></p>

<p>感觉程序员还是要多思考，不过是对代码还是对业务流程。不能说以前的人这么写，或者这么做了，我就跟着这么做，而不加以思考这样的代码或者流程到底合不合理，是不是正确/最优的做法，否则很难跳出自己的舒适区域。</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">tripleCC</span></span>

      




<time class='entry-date' datetime='2016-10-22T22:43:37+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>22</span><span class='date-suffix'>nd</span>, <span class='date-year'>2016</span></span> <span class='time'>10:43 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2016-10-15-shi-yong-rxswift-plus-moya-plus-objectmapperjie-ru-mo-xing/" title="Previous Post: 使用RxSwift+Moya+ObjectMapper接入模型">&laquo; 使用RxSwift+Moya+ObjectMapper接入模型</a>
      
      
        <a class="basic-alignment right" href="/blog/2016-11-12-objective-cshi-yong-fan-xing-shi-xian-mapti-shi/" title="Next Post: Objective-C使用范型实现map提示">Objective-C使用范型实现map提示 &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>关于我</h1>
  <p> 曾经的嵌入式软件开发者，现已皈依苹果大法门下。目前混迹杭州，喜欢没事就去西湖浪荡。轻微完美主义者，跑步爱好者。 </p>
  <a href="http://www.jianshu.com/users/97e39e95c2cc"> 我的简书 </a><br>
  <a href="https://github.com/tripleCC"> 我的GitHub </a><br>
  <a href="https://twitter.com/tripleCCBrian"> 我的Twitter </a>
</section>
<section>
  <h1>最近发布</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017-04-09-shi-yong-usbmuxdlian-jie-iphone/">使用usbmuxd连接iPhone</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-03-19-ru-he-yu-kuai-di-shi-yong-ming-ling-xing/">如何愉快地使用命令行</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-03-09-nsjsonserializationhe-nsnumber/">NSJSONSerialization和NSNumber的事故现场</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016-12-05-li-yong-runtimejian-rong-lao-dai-ma-xiao-ji/">利用runtime兼容老代码小记</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016-11-12-objective-cshi-yong-fan-xing-shi-xian-mapti-shi/">Objective-C使用范型实现map提示</a>
      </li>
    
  </ul>
</section>




<section>
    <h1>友情链接</h1>
    <ul>
        <li>
            <a href="http://wxgbridgeq.github.io/">小乔的个人学习博客</a>
        </li>
        <li>
        	<a href="http://www.swiftyper.com/">Swiftyper-小锅</a>
        </li>
    </ul>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - tripleCC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
