
<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>Objective-C 消息转发应用场景摘录 - tripleCC的技术博客</title>
  <meta name="author" content="tripleCC">

  
  <meta name="description" content="说起 Objective-C runtime 在实际项目中的应用，可能很多人第一时间联想到的是黑魔法 method swizzling 、 associated objects 、 KVC / KVO 以及各种灵活的 runtime api 。这几种技术在开发过程中或多或少都会涉及到 ， &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="/atom.xml" rel="alternate" title="tripleCC的技术博客" type="application/atom+xml">
  
  <link rel="canonical" href="http://triplecc.github.io/blog/2017-07-09-objective-cxiao-xi-zhuan-fa-ying-yong-zhi-ji-chu/">
  <link href="/favicon.png" rel="shortcut icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <!--[good job! gfw]><script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script><!-->
  <script src="http://cdn.staticfile.org/jquery/1.9.1/jquery.min.js"></script>
  <link href="/stylesheets/google-fonts.css" rel="stylesheet" type="text/css">
  

  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  
</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">tripleCC的技术博客</a></h1>
  
    <h2>ʕ•̫͡•ʔ-̫͡-ʕ•͓͡•ʔ-̫͡-ʕ•̫͡•ʔ-̫͡-ʕ•͓͡•ʔ-̫͡-ʔ</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="triplecc.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">首页</a></li>
  <li><a href="/blog/archives">所有文章</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Objective-C 消息转发应用场景摘录</h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2017-07-09T14:20:30+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>2:20 pm</span></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>说起 Objective-C runtime 在实际项目中的应用，可能很多人第一时间联想到的是黑魔法 method swizzling 、 associated objects 、 KVC / KVO 以及各种灵活的 runtime api 。这几种技术在开发过程中或多或少都会涉及到 ，也的确为开发者立下了汗马功劳，尤其在解决一些棘手问题时，屡试不爽。不过同样是 runtime 重要组成部分的<strong>消息转发</strong>却较少听人提及，这篇文章就来扒一扒它在不同应用场景中的精彩表现。</p>

<!--more-->




<!-- ## 目录

1、简说消息转发 <br>
2、简化代理方法的调用 <br>
3、部分代理方法转发<br>
4、多播代理<br>
5、代理强引用转弱引用<br>
6、NSUndoManager 中的应用<br>
7、依靠协议的依赖注入<br>
8、小结<br>
9、参考<br> -->


<h2>简说消息转发</h2>

<p>在开始之前，先简单温习下消息转发是怎么一回事。</p>

<p>举一个不恰当的例子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="kt">id</span> <span class="n">o</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSObject</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'><span class="p">[</span><span class="n">o</span> <span class="n">lastObject</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>执行上面代码，程序会崩溃并抛出以下异常：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="bp">NSObject</span> <span class="n">lastObject</span><span class="p">]</span><span class="o">:</span> <span class="n">unrecognized</span> <span class="n">selector</span> <span class="n">sent</span> <span class="n">to</span> <span class="n">instance</span> <span class="mh">0x100200160</span>
</span></code></pre></td></tr></table></div></figure>


<p>错误显而易见，实例对象 <code>o</code> 无法响应 <code>lastObject</code> 方法。 那么问题来了， Objetive-C 作为一门动态语言，更有强大的 runtime 大佬在背后撑腰，它会让程序没有任何预警地直接狗带么？当然不会，Object-C 的 runtime 不但提供了挽救机制，而且还是三部曲：</p>

<p>1、Lazy method resolution <br>
2、Fast forwarding path <br>
3、Normal forwarding path <br></p>

<p>上述程序崩溃的根本原因在于没有找到方法的实现，也就是通常所说的 IMP 不存在。结合以下源码，可以知道消息转发三部曲是由 _objc_msgForward 函数发起的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">IMP</span> <span class="nf">class_getMethodImplementation</span><span class="p">(</span><span class="n">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="n">SEL</span> <span class="n">sel</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">IMP</span> <span class="n">imp</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls</span>  <span class="o">||</span>  <span class="o">!</span><span class="n">sel</span><span class="p">)</span> <span class="k">return</span> <span class="n">nil</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">imp</span> <span class="o">=</span> <span class="n">lookUpImpOrNil</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">nil</span><span class="p">,</span>
</span><span class='line'>                         <span class="n">YES</span><span class="cm">/*initialize*/</span><span class="p">,</span> <span class="n">YES</span><span class="cm">/*cache*/</span><span class="p">,</span> <span class="n">YES</span><span class="cm">/*resolver*/</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Translate forwarding function to C-callable external version</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imp</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_objc_msgForward</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">imp</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Lazy method resolution</h3>

<p>在这一步， <code>_objc_msgForward</code> 直接或间接调用了以下方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">/// 针对类方法</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">resolveClassMethod:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">sel</span><span class="p">;</span>
</span><span class='line'><span class="c1">/// 针对对象方法</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">resolveInstanceMethod:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">sel</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>由于形参中传入了无法找到对应 IMP 的 SEL ，我们就可以在这个方法中动态添加 SEL 的实现，并返回 YES 重新启动一次消息发送动作。如果方法返回 NO ，那么就进行消息转发的下个流程 Fast forwarding path 。</p>

<p>这种方式能够方便地实现 <code>@dynamic</code> 属性， CoreData 中模型定义中就广泛使用到了 <code>@dynamic</code> 属性。</p>

<h3>Fast forwarding path</h3>

<p>在这一步， <code>_objc_msgForward</code> 直接或间接调用了以下方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">forwardingTargetForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSelector</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个方法还是只附带了无法找到对应 IMP 的 SEL，我们可以根据这个 SEL ，判断是否有其它对象可以响应它，然后选择将消息转发给这个对象。如果返回除 nil / self 之外的对象，那么会重启一次消息发送动作给返回的对象，否则进入下个流程 Normal forwarding path。</p>

<h3>Normal forwarding path</h3>

<p>在这一步， <code>_objc_msgForward</code> 直接或间接调用了以下方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSMethodSignature</span> <span class="o">*</span><span class="p">)</span><span class="nf">methodSignatureForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSelector</span><span class="p">;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">forwardInvocation:</span><span class="p">(</span><span class="bp">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">anInvocation</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个消息转发的最后一步，首先会调用的是 <code>-methodSignatureForSelector:</code> 方法，这个方法返回一个方法签名，用以构造 NSInvocation 并作为实参传入 <code>-forwardInvocation:</code> 方法中。如果 <code>-methodSignatureForSelector:</code> 返回 nil ，将会抛出 unrecognized selector 异常。</p>

<p>由于在 <code>-forwardInvocation:</code> 方法中可以获取到 NSInvocation ，而 NSInvocation 包含了参数、发送目标以及 SEL 等信息，尤其是参数信息，所以这一步也是可操作性最强的一步。我们可以选择直接执行传入的 NSInvocation 对象，也可以通过 <code>-invokeWithTarget:</code> 指定新的发送目标。</p>

<p>一般来说，既然走到这一步，这个对象都是没有 SEL 对应的 IMP 的，所以通常来说都必须要重写 <code>-methodSignatureForSelector:</code> 方法以返回有效的方法签名，否则就会抛出异常。不过有种例外，当对象实现了相应的方法，但还是走到了 Normal forwarding path 这一步时，就可以不重写 <code>-methodSignatureForSelector:</code> 方法。</p>

<p>理解这种操作需要知晓 method swizzling 技术中的一个知识点，<strong><em>替换 IMP 是不会影响到 SEL 和 参数信息的</em></strong>。所以当把某个方法的实现替换成 <code>_objc_msgForward</code> / <code>_objc_msgForward_stret</code> 以启动消息转发时，即使不重写 <code>-methodSignatureForSelector:</code> ，这个方法依旧能返回有效的方法签名信息。举个例子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="bp">NSArray</span> <span class="o">*</span><span class="n">arr</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSArray</span> <span class="n">new</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'><span class="n">Method</span> <span class="n">old</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">([</span><span class="n">arr</span> <span class="k">class</span><span class="p">],</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">objectAtIndex</span><span class="p">:));</span>
</span><span class='line'><span class="n">printf</span><span class="p">(</span><span class="s">&quot;old type: %s, imp: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">old</span><span class="p">),</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">old</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'><span class="n">class_replaceMethod</span><span class="p">([</span><span class="n">arr</span> <span class="k">class</span><span class="p">],</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">objectAtIndex</span><span class="p">:),</span> <span class="n">_objc_msgForward</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="n">Method</span> <span class="n">new</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">([</span><span class="n">arr</span> <span class="k">class</span><span class="p">],</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">objectAtIndex</span><span class="p">:));</span>
</span><span class='line'><span class="n">printf</span><span class="p">(</span><span class="s">&quot;new type: %s, imp: %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">new</span><span class="p">),</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">new</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面程序输出如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">old</span> <span class="nl">type</span><span class="p">:</span> <span class="mi">@24@0</span><span class="o">:</span><span class="mi">8</span><span class="n">Q16</span><span class="p">,</span> <span class="nl">imp</span><span class="p">:</span> <span class="mh">0x7fffb5fc31e0</span>
</span><span class='line'><span class="n">new</span> <span class="nl">type</span><span class="p">:</span> <span class="mi">@24@0</span><span class="o">:</span><span class="mi">8</span><span class="n">Q16</span><span class="p">,</span> <span class="nl">imp</span><span class="p">:</span> <span class="mh">0x7fffcada5cc0</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到，更改的只有方法实现 IMP 。并且从源码层面看，method swizzling 在方法已存在的情况下，只是设置了对应的 Method 的 IMP，当方法不存在时，才会设置额外的一些属性：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="kt">IMP</span>
</span><span class='line'><span class="nf">class_replaceMethod</span><span class="p">(</span><span class="kt">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="kt">SEL</span> <span class="n">name</span><span class="p">,</span> <span class="kt">IMP</span> <span class="n">imp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">types</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cls</span><span class="p">)</span> <span class="k">return</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">rwlock_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtimeLock</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">IMP</span> <span class="n">old</span> <span class="o">=</span> <span class="n">addMethod</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">imp</span><span class="p">,</span> <span class="n">types</span> <span class="o">?:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="nb">YES</span><span class="p">);</span>
</span><span class='line'>    <span class="n">rwlock_unlock_write</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtimeLock</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">old</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">static</span> <span class="kt">IMP</span>
</span><span class='line'><span class="nf">addMethod</span><span class="p">(</span><span class="kt">Class</span> <span class="n">cls</span><span class="p">,</span> <span class="kt">SEL</span> <span class="n">name</span><span class="p">,</span> <span class="kt">IMP</span> <span class="n">imp</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">types</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="n">replace</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">IMP</span> <span class="n">result</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">rwlock_assert_writing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">runtimeLock</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">types</span><span class="p">);</span>
</span><span class='line'>    <span class="n">assert</span><span class="p">(</span><span class="n">cls</span><span class="o">-&gt;</span><span class="n">isRealized</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">method_t</span> <span class="o">*</span><span class="n">m</span><span class="p">;</span>
</span><span class='line'>    <span class="c1">// 方法是否存在</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">m</span> <span class="o">=</span> <span class="n">getMethodNoSuper_nolock</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// already exists</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">replace</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 不替换返回已存在方法实现IMP</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="n">_method_getImplementation</span><span class="p">(</span><span class="n">m</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// 直接替换类cls的m函数指针为imp</span>
</span><span class='line'>            <span class="n">result</span> <span class="o">=</span> <span class="n">_method_setImplementation</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">imp</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// fixme optimize</span>
</span><span class='line'>        <span class="c1">// 申请方法列表内存</span>
</span><span class='line'>        <span class="kt">method_list_t</span> <span class="o">*</span><span class="n">newlist</span><span class="p">;</span>
</span><span class='line'>        <span class="n">newlist</span> <span class="o">=</span> <span class="p">(</span><span class="kt">method_list_t</span> <span class="o">*</span><span class="p">)</span><span class="n">_calloc_internal</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">newlist</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>        <span class="n">newlist</span><span class="o">-&gt;</span><span class="n">entsize_NEVER_USE</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">method_t</span><span class="p">)</span> <span class="o">|</span> <span class="n">fixed_up_method_list</span><span class="p">;</span>
</span><span class='line'>        <span class="n">newlist</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 赋值名字，类型，方法实现（函数指针）</span>
</span><span class='line'>        <span class="n">newlist</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span><span class='line'>        <span class="n">newlist</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">types</span> <span class="o">=</span> <span class="n">strdup</span><span class="p">(</span><span class="n">types</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ignoreSelector</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">newlist</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">imp</span> <span class="o">=</span> <span class="n">imp</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">newlist</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">.</span><span class="n">imp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">IMP</span><span class="p">)</span><span class="o">&amp;</span><span class="n">_objc_ignored_method</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// 向类添加方法列表</span>
</span><span class='line'>        <span class="n">attachMethodLists</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newlist</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NO</span><span class="p">,</span> <span class="nb">NO</span><span class="p">,</span> <span class="nb">YES</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">result</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>消息转发流程大体如此，如果想了解具体的转发原理、<code>_objc_msgForward</code> 内部是如何实现的，可以阅读<a href="http://yulingtianxia.com/">玉令天下</a>写的 <a href="http://yulingtianxia.com/blog/2016/06/15/Objective-C-Message-Sending-and-Forwarding/">Objective-C 消息发送与转发机制原理</a>，文章会以反汇编地角度剖析消息转发的实现，能捋清不少疑惑。<br></p>

<p>聊完消息转发的基本流程，再来说说它的一些应用场景。</p>

<h2>Week Proxy</h2>

<p>NSTimer、CADisplayLink 是实际项目中常用的计时器类，它们都使用 target - action 机制设置目标对象以及回调方法。相信很多人都遇到过 NSTimer 或者 CADisplayLink 对象造成的循环引用问题。实际上，这两个对象是强引用 target 的，如果使用者管理不当，轻则造成 target 对象的延迟释放，重则导致与 target 对象的循环引用。</p>

<p>假如有个 UIViewController 引用了一个 repeat 的 NSTimer 对象 （先不论强弱引用） ，正确的管理方式是在控制器退出回调中手动 invalidate 并释放对 NSTimer 对象的引用 ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">popViewController</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">_timer</span> <span class="n">invalidate</span><span class="p">];</span>
</span><span class='line'>    <span class="n">_timer</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span> <span class="c1">// 强引用需要，弱引用不需要</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>不过正所谓“人有失手，马有失蹄”，这种分散的管理方式，总会让使用者在某些场景下忘记了停止 <code>_timer</code> ，特别是使用者希望在 UIViewController 对象的 <code>dealloc</code> 方法中停止定时器时，很容易掉进这个坑里。有没有更加优雅的管理机制呢？下面就来看看 FLAnimatedImage 是如何管理 CADisplayLink 对象的。</p>

<p>FLAnimatedImage 创建了以下弱引用代理：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">FLWeakProxy</span> : <span class="bp">NSProxy</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">weakProxyForObject:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">targetObject</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">FLWeakProxy</span> <span class="p">()</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">weak</span><span class="p">)</span> <span class="kt">id</span> <span class="n">target</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">FLWeakProxy</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark Life Cycle</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// This is the designated creation method of an `FLWeakProxy` and</span>
</span><span class='line'><span class="c1">// as a subclass of `NSProxy` it doesn&#39;t respond to or need `-init`.</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">weakProxyForObject:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">targetObject</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">FLWeakProxy</span> <span class="o">*</span><span class="n">weakProxy</span> <span class="o">=</span> <span class="p">[</span><span class="n">FLWeakProxy</span> <span class="n">alloc</span><span class="p">];</span>
</span><span class='line'>    <span class="n">weakProxy</span><span class="p">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">targetObject</span><span class="p">;</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">weakProxy</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark Forwarding Messages</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">forwardingTargetForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">selector</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Keep it lightweight: access the ivar directly</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_target</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">#pragma mark - NSWeakProxy Method Overrides</span>
</span><span class='line'><span class="cp">#pragma mark Handling Unimplemented Methods</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">forwardInvocation:</span><span class="p">(</span><span class="bp">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">invocation</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Fallback for when target is nil. Don&#39;t do anything, just return 0/NULL/nil.</span>
</span><span class='line'>    <span class="c1">// The method signature we&#39;ve received to get here is just a dummy to keep `doesNotRecognizeSelector:` from firing.</span>
</span><span class='line'>    <span class="c1">// We can&#39;t really handle struct return types here because we don&#39;t know the length.</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">nullPointer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="n">invocation</span> <span class="nl">setReturnValue</span><span class="p">:</span><span class="o">&amp;</span><span class="n">nullPointer</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSMethodSignature</span> <span class="o">*</span><span class="p">)</span><span class="nf">methodSignatureForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">selector</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// We only get here if `forwardingTargetForSelector:` returns nil.</span>
</span><span class='line'>    <span class="c1">// In that case, our weak target has been reclaimed. Return a dummy method signature to keep `doesNotRecognizeSelector:` from firing.</span>
</span><span class='line'>    <span class="c1">// We&#39;ll emulate the Obj-c messaging nil behavior by setting the return value to nil in `forwardInvocation:`, but we&#39;ll assume that the return value is `sizeof(void *)`.</span>
</span><span class='line'>    <span class="c1">// Other libraries handle this situation by making use of a global method signature cache, but that seems heavier than necessary and has issues as well.</span>
</span><span class='line'>    <span class="c1">// See https://www.mikeash.com/pyblog/friday-qa-2010-02-26-futures.html and https://github.com/steipete/PSTDelegateProxy/issues/1 for examples of using a method signature cache.</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="bp">NSObject</span> <span class="nl">instanceMethodSignatureForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">init</span><span class="p">)];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过上面代码，可以看出 FLWeakProxy 是弱引用 target 的，而且它在消息转发的第二步，将所有的消息都转发给了 target 对象。以下是调用方使用此弱引用代理的代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">FLAnimatedImageView</span> <span class="p">()</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="k">strong</span><span class="p">)</span> <span class="bp">CADisplayLink</span> <span class="o">*</span><span class="n">displayLink</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">FLAnimatedImageView</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">startAnimating</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>    <span class="n">FLWeakProxy</span> <span class="o">*</span><span class="n">weakProxy</span> <span class="o">=</span> <span class="p">[</span><span class="n">FLWeakProxy</span> <span class="nl">weakProxyForObject</span><span class="p">:</span><span class="nb">self</span><span class="p">];</span>
</span><span class='line'>    <span class="nb">self</span><span class="p">.</span><span class="n">displayLink</span> <span class="o">=</span> <span class="p">[</span><span class="bp">CADisplayLink</span> <span class="nl">displayLinkWithTarget</span><span class="p">:</span><span class="n">weakProxy</span> <span class="nl">selector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">displayDidRefresh</span><span class="p">:)];</span>
</span><span class='line'>    <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">displayLink</span> <span class="nl">addToRunLoop</span><span class="p">:[</span><span class="bp">NSRunLoop</span> <span class="n">mainRunLoop</span><span class="p">]</span> <span class="nl">forMode</span><span class="p">:</span><span class="nb">self</span><span class="p">.</span><span class="n">runLoopMode</span><span class="p">];</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>其对象间的引用关系可以用下图表示：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="o">---&gt;</span> <span class="err">强引用</span>  <span class="o">~~~&gt;</span> <span class="err">弱引用</span>
</span><span class='line'>
</span><span class='line'><span class="n">FLAnimatedImageView</span><span class="p">(</span><span class="n">object</span><span class="p">)</span> <span class="o">---&gt;</span> <span class="n">displayLink</span> <span class="o">---&gt;</span> <span class="n">weakProxy</span> <span class="o">~~~&gt;</span> <span class="n">FLAnimatedImageView</span><span class="p">(</span><span class="n">object</span><span class="p">)</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>这样一来， <code>displayLink</code> 间接弱引用了 FLAnimatedImageView 对象，使得 FLAnimatedImageView 对象得以正常释放。而且由于 <code>weakProxy</code> 将消息全部转发给了 FLAnimatedImageView 对象，<code>-displayDidRefresh:</code> 也得以正确地回调。</p>

<p>事实上，以上问题也可以通过 block 回调的方式解决，具体实现就是让创建的定时器对象持有 NSTimer 类对象，并且在类回调方法中，执行经 userInfo 传过来的 block 回调。</p>

<p>此外，苹果私有库 MIME.framework 中就有这种机制的应用 &mdash;- MFWeakProxy ；YYKit 的 YYAnimatedImageView 也使用了相同的机制管理 CADisplayLink，其对应类为 YYWeakProxy 。</p>

<h2>Delegate Proxy</h2>

<p>Delegate Proxy 主要实现部分代理方法的转发，顾名思义，就是封装者使用了被封装对象代理的一部分方法，然后将剩余的方法通过新的代理转发给调用者。这种机制在二次封装第三方框架或者原生控件时，能减少不少胶水代码。</p>

<p>接下来，我会以 IGListKit 中的 IGListAdapterProxy 为例，描述如何利用这种机制来简化代码。在开始之前先了解下与 IGListAdapterProxy 直接相关的 IGListAdapter 。 IGListAdapter 是 UICollectionView 的数据源和代理实现者，以下是它与本主题相关联的两个属性：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">IGListAdapter</span> : <span class="bp">NSObject</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> The object that receives `UICollectionViewDelegate` events.</span>
</span><span class='line'>
</span><span class='line'><span class="cm"> @note This object *will not* receive `UIScrollViewDelegate` events. Instead use scrollViewDelegate.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="n">nullable</span><span class="p">,</span> <span class="k">weak</span><span class="p">)</span> <span class="kt">id</span> <span class="o">&lt;</span><span class="bp">UICollectionViewDelegate</span><span class="o">&gt;</span> <span class="n">collectionViewDelegate</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> The object that receives `UIScrollViewDelegate` events.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">nonatomic</span><span class="p">,</span> <span class="n">nullable</span><span class="p">,</span> <span class="k">weak</span><span class="p">)</span> <span class="kt">id</span> <span class="o">&lt;</span><span class="bp">UIScrollViewDelegate</span><span class="o">&gt;</span> <span class="n">scrollViewDelegate</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用者可以成为 IGListAdapter 的代理，获得和 UICollectionView 原生代理一致的编写体验。实际上， IGListAdapter 只是使用并实现了部分代理方法，那么它又是如何编写有关这两个属性的代码，让使用者实现的代理方法能正确地执行呢？可能有些人会这样写：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="cp">#pragma mark - UICollectionViewDelegateFlowLayout</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nl">collectionView</span><span class="p">:(</span><span class="bp">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="n">collectionView</span> <span class="nl">canFocusItemAtIndexPath</span><span class="p">:(</span><span class="bp">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="n">indexPath</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span><span class="p">.</span><span class="n">collectionViewDelegate</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">collectionView</span><span class="p">:</span><span class="nl">canFocusItemAtIndexPath</span><span class="p">:)])</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">collectionViewDelegate</span> <span class="nl">collectionView</span><span class="p">:</span><span class="n">collectionView</span> <span class="nl">canFocusItemAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nl">collectionView</span><span class="p">:(</span><span class="bp">UICollectionView</span> <span class="o">*</span><span class="p">)</span><span class="n">collectionView</span> <span class="nl">shouldShowMenuForItemAtIndexPath</span><span class="p">:(</span><span class="bp">NSIndexPath</span> <span class="o">*</span><span class="p">)</span><span class="n">indexPath</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">([</span><span class="nb">self</span><span class="p">.</span><span class="n">collectionViewDelegate</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">collectionView</span><span class="p">:</span><span class="nl">shouldShowMenuForItemAtIndexPath</span><span class="p">:)])</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[</span><span class="nb">self</span><span class="p">.</span><span class="n">collectionViewDelegate</span> <span class="nl">collectionView</span><span class="p">:</span><span class="n">collectionView</span> <span class="nl">shouldShowMenuForItemAtIndexPath</span><span class="p">:</span><span class="n">indexPath</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>当代理方法较少的时候，这种写法是可以接受的。不过随着代理方法的增多，编写这种胶水代码就有些烦人了，侵入性的修改方式也不符合开放闭合原则。我们来看下 IGListKit 是如何利用 IGListAdapterProxy 解决这个问题的：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">IGListAdapterProxy</span> : <span class="bp">NSProxy</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">initWithCollectionViewTarget:</span><span class="p">(</span><span class="n">nullable</span> <span class="kt">id</span><span class="o">&lt;</span><span class="bp">UICollectionViewDelegate</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">collectionViewTarget</span>
</span><span class='line'>                            <span class="nf">scrollViewTarget:</span><span class="p">(</span><span class="n">nullable</span> <span class="kt">id</span><span class="o">&lt;</span><span class="bp">UIScrollViewDelegate</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">scrollViewTarget</span>
</span><span class='line'>                                 <span class="nf">interceptor:</span><span class="p">(</span><span class="n">IGListAdapter</span> <span class="o">*</span><span class="p">)</span><span class="nv">interceptor</span><span class="p">;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">init</span> <span class="n">NS_UNAVAILABLE</span><span class="p">;</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">new</span> <span class="n">NS_UNAVAILABLE</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">BOOL</span> <span class="n">isInterceptedSelector</span><span class="p">(</span><span class="kt">SEL</span> <span class="n">sel</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">(</span>
</span><span class='line'>            <span class="c1">// UICollectionViewDelegate</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">collectionView</span><span class="p">:</span><span class="nl">didSelectItemAtIndexPath</span><span class="p">:)</span> <span class="o">||</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">collectionView</span><span class="p">:</span><span class="nl">willDisplayCell</span><span class="p">:</span><span class="nl">forItemAtIndexPath</span><span class="p">:)</span> <span class="o">||</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">collectionView</span><span class="p">:</span><span class="nl">didEndDisplayingCell</span><span class="p">:</span><span class="nl">forItemAtIndexPath</span><span class="p">:)</span> <span class="o">||</span>
</span><span class='line'>            <span class="c1">// UICollectionViewDelegateFlowLayout</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">collectionView</span><span class="p">:</span><span class="nl">layout</span><span class="p">:</span><span class="nl">sizeForItemAtIndexPath</span><span class="p">:)</span> <span class="o">||</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">collectionView</span><span class="p">:</span><span class="nl">layout</span><span class="p">:</span><span class="nl">insetForSectionAtIndex</span><span class="p">:)</span> <span class="o">||</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">collectionView</span><span class="p">:</span><span class="nl">layout</span><span class="p">:</span><span class="nl">minimumInteritemSpacingForSectionAtIndex</span><span class="p">:)</span> <span class="o">||</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">collectionView</span><span class="p">:</span><span class="nl">layout</span><span class="p">:</span><span class="nl">minimumLineSpacingForSectionAtIndex</span><span class="p">:)</span> <span class="o">||</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">collectionView</span><span class="p">:</span><span class="nl">layout</span><span class="p">:</span><span class="nl">referenceSizeForFooterInSection</span><span class="p">:)</span> <span class="o">||</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">collectionView</span><span class="p">:</span><span class="nl">layout</span><span class="p">:</span><span class="nl">referenceSizeForHeaderInSection</span><span class="p">:)</span> <span class="o">||</span>
</span><span class='line'>            <span class="c1">// UIScrollViewDelegate</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">scrollViewDidScroll</span><span class="p">:)</span> <span class="o">||</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">scrollViewWillBeginDragging</span><span class="p">:)</span> <span class="o">||</span>
</span><span class='line'>            <span class="n">sel</span> <span class="o">==</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">scrollViewDidEndDragging</span><span class="p">:</span><span class="nl">willDecelerate</span><span class="p">:)</span>
</span><span class='line'>            <span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">IGListAdapterProxy</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">__weak</span> <span class="kt">id</span> <span class="n">_collectionViewTarget</span><span class="p">;</span>
</span><span class='line'>    <span class="k">__weak</span> <span class="kt">id</span> <span class="n">_scrollViewTarget</span><span class="p">;</span>
</span><span class='line'>    <span class="k">__weak</span> <span class="n">IGListAdapter</span> <span class="o">*</span><span class="n">_interceptor</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">IGListAdapterProxy</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">initWithCollectionViewTarget:</span><span class="p">(</span><span class="n">nullable</span> <span class="kt">id</span><span class="o">&lt;</span><span class="bp">UICollectionViewDelegate</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">collectionViewTarget</span>
</span><span class='line'>                            <span class="nf">scrollViewTarget:</span><span class="p">(</span><span class="n">nullable</span> <span class="kt">id</span><span class="o">&lt;</span><span class="bp">UIScrollViewDelegate</span><span class="o">&gt;</span><span class="p">)</span><span class="nv">scrollViewTarget</span>
</span><span class='line'>                                 <span class="nf">interceptor:</span><span class="p">(</span><span class="n">IGListAdapter</span> <span class="o">*</span><span class="p">)</span><span class="nv">interceptor</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">IGParameterAssert</span><span class="p">(</span><span class="n">interceptor</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// -[NSProxy init] is undefined</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_collectionViewTarget</span> <span class="o">=</span> <span class="n">collectionViewTarget</span><span class="p">;</span>
</span><span class='line'>        <span class="n">_scrollViewTarget</span> <span class="o">=</span> <span class="n">scrollViewTarget</span><span class="p">;</span>
</span><span class='line'>        <span class="n">_interceptor</span> <span class="o">=</span> <span class="n">interceptor</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">BOOL</span><span class="p">)</span><span class="nf">respondsToSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSelector</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">isInterceptedSelector</span><span class="p">(</span><span class="n">aSelector</span><span class="p">)</span>
</span><span class='line'>    <span class="o">||</span> <span class="p">[</span><span class="n">_collectionViewTarget</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">]</span>
</span><span class='line'>    <span class="o">||</span> <span class="p">[</span><span class="n">_scrollViewTarget</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">forwardingTargetForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSelector</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">isInterceptedSelector</span><span class="p">(</span><span class="n">aSelector</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_interceptor</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">_scrollViewTarget</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">]</span> <span class="o">?</span> <span class="nl">_scrollViewTarget</span> <span class="p">:</span> <span class="n">_collectionViewTarget</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">forwardInvocation:</span><span class="p">(</span><span class="bp">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">invocation</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">void</span> <span class="o">*</span><span class="n">nullPointer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>    <span class="p">[</span><span class="n">invocation</span> <span class="nl">setReturnValue</span><span class="p">:</span><span class="o">&amp;</span><span class="n">nullPointer</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSMethodSignature</span> <span class="o">*</span><span class="p">)</span><span class="nf">methodSignatureForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">selector</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="bp">NSObject</span> <span class="nl">instanceMethodSignatureForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">init</span><span class="p">)];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个类总共有三个自定义属性，分别是用来支持外界代理方法回调的 <code>_collectionViewTarget</code> 、 <code>_scrollViewTarget</code>，以及用以支持 AOP 的拦截者 <code>_interceptor</code>（IGListAdapter 在调用外界实现的代理方法前，插入了自己的实现，所以可视为拦截者）。 <code>isInterceptedSelector</code> 函数表明拦截者使用到了哪些代理方法，而 <code>-respondsToSelector:</code> 和 <code>-forwardingTargetForSelector:</code> 则根据这个函数的返回值决定是否能响应方法，以及应该把消息转发给拦截者还是外部代理。 事实上，外部代理就是本小节开头所说的使用者可以访问的属性：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@implementation</span> <span class="nc">IGListAdapter</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="nb">self</span><span class="p">.</span><span class="n">delegateProxy</span> <span class="o">=</span> <span class="p">[[</span><span class="n">IGListAdapterProxy</span> <span class="n">alloc</span><span class="p">]</span> <span class="nl">initWithCollectionViewTarget</span><span class="p">:</span><span class="n">_collectionViewDelegate</span>
</span><span class='line'>                                                                 <span class="nl">scrollViewTarget</span><span class="p">:</span><span class="n">_scrollViewDelegate</span>
</span><span class='line'>                                                                      <span class="nl">interceptor</span><span class="p">:</span><span class="nb">self</span><span class="p">];</span>
</span><span class='line'><span class="p">...</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过这种转发机制，即使后续有新的代理方法，也不用手动添加胶水代码了。一些流行的开源库中也可以看到这种做法的身影，比如 AsyncDisplayKit 就有对应的 <code>_ASCollectionViewProxy</code> 来转发未实现的代理方法。</p>

<h2>Multicast Delegate</h2>

<p>通知和代理是解耦对象间消息传递的两种重要方式，其中通知主要针对一对多的单向通信，而代理则主要提供一对一的双向通信。</p>

<p>通常来说， IM 应用在底层模块接受到新消息后，都会进行一次广播处理，让各模块能根据新消息来更新状态。当接收模块不需要向发送模块反馈任何信息时，使用 NSNotificationCenter 就可以实现上述需求。但是一旦发送模块需要根据接收模块返回的信息做一些额外处理，也就是实现一对多的双向通信， NSNotificationCenter 就不满足要求了。</p>

<p>最直接的解决方案是，针对这个业务场景自定义一个消息转发中心，让遵守特定协议的外围模块主动注册成为消息接收者。不过既然涉及到了特定协议，就注定了这个消息转发中心缺少通用性。这时候就可以参考下业界现成的方案了，让我们来看看 XMPPFramework 是如何解决这个问题的。</p>

<p>从文档中可以看出，作者希望 XMPPFramework 具备以下几个特性 ：</p>

<p>1、 将事件广播给多个监听者<br>
2、 易于扩展<br>
3、 选择的机制要支持返回值<br>
4、 选择的机制要易于编写线程安全代码<br></p>

<p>但是代理或者通知机制都不能很好地满足上述需求，所以 GCDMulticastDelegate 类应运而生。 使用这个类时，广播类需要初始化 GCDMulticastDelegate 对象：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="n">GCDMulticastDelegate</span> <span class="o">&lt;</span><span class="n">MyPluginDelegate</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">multicastDelegate</span><span class="p">;</span>
</span><span class='line'><span class="n">multicastDelegate</span> <span class="o">=</span> <span class="p">(</span><span class="n">GCDMulticastDelegate</span> <span class="o">&lt;</span><span class="n">MyPluginDelegate</span><span class="o">&gt;</span> <span class="o">*</span><span class="p">)[[</span><span class="n">GCDMulticastDelegate</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>并且添加增删代理的方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">addDelegate:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">delegate</span> <span class="nf">delegateQueue:</span><span class="p">(</span><span class="kt">dispatch_queue_t</span><span class="p">)</span><span class="nv">delegateQueue</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">multicastDelegate</span> <span class="nl">addDelegate</span><span class="p">:</span><span class="n">delegate</span> <span class="nl">delegateQueue</span><span class="p">:</span><span class="n">delegateQueue</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">removeDelegate:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">delegate</span> <span class="nf">delegateQueue:</span><span class="p">(</span><span class="kt">dispatch_queue_t</span><span class="p">)</span><span class="nv">delegateQueue</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">multicastDelegate</span> <span class="nl">removeDelegate</span><span class="p">:</span><span class="n">delegate</span> <span class="nl">delegateQueue</span><span class="p">:</span><span class="n">delegateQueue</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>当广播对象需要向所有注册的代理发送消息时，可以用以下方式调用：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="n">multicastDelegate</span> <span class="nl">worker</span><span class="p">:</span><span class="nb">self</span> <span class="nl">didFinishSubTask</span><span class="p">:</span><span class="n">subtask</span> <span class="nl">inDuration</span><span class="p">:</span><span class="n">elapsed</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>只要注册的代理实现了这个方法，就可以接收到发送的信息。</p>

<p>接下来看下 GCDMulticastDelegate 的实现原理 。首先， GCDMulticastDelegate 会在外界添加代理时，创建 GCDMulticastDelegateNode 对象封装传入的代理以及回调执行队列，然后保存在 <code>delegateNodes</code> 数组中。当外界向 GCDMulticastDelegate 对象发送无法响应的消息时，它会针对此消息启动转发机制，并在 <code>Normal forwarding path</code> 这一步转发给所有能响应此消息的注册代理。以下是消息转发相关的源码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSMethodSignature</span> <span class="o">*</span><span class="p">)</span><span class="nf">methodSignatureForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSelector</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">GCDMulticastDelegateNode</span> <span class="o">*</span><span class="n">node</span> <span class="k">in</span> <span class="n">delegateNodes</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">id</span> <span class="n">nodeDelegate</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">delegate</span><span class="p">;</span>
</span><span class='line'>        <span class="cp">#if __has_feature(objc_arc_weak) &amp;&amp; !TARGET_OS_IPHONE</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">nodeDelegate</span> <span class="o">==</span> <span class="p">[</span><span class="bp">NSNull</span> <span class="n">null</span><span class="p">])</span>
</span><span class='line'>            <span class="n">nodeDelegate</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">unsafeDelegate</span><span class="p">;</span>
</span><span class='line'>        <span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">NSMethodSignature</span> <span class="o">*</span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodeDelegate</span> <span class="nl">methodSignatureForSelector</span><span class="p">:</span><span class="n">aSelector</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">!=</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// This causes a crash...</span>
</span><span class='line'>    <span class="c1">// return [super methodSignatureForSelector:aSelector];</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// This also causes a crash...</span>
</span><span class='line'>    <span class="c1">// return nil;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="p">[[</span><span class="nb">self</span> <span class="k">class</span><span class="p">]</span> <span class="nl">instanceMethodSignatureForSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="n">doNothing</span><span class="p">)];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">forwardInvocation:</span><span class="p">(</span><span class="bp">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">origInvocation</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="kt">SEL</span> <span class="n">selector</span> <span class="o">=</span> <span class="p">[</span><span class="n">origInvocation</span> <span class="n">selector</span><span class="p">];</span>
</span><span class='line'>    <span class="kt">BOOL</span> <span class="n">foundNilDelegate</span> <span class="o">=</span> <span class="nb">NO</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="n">GCDMulticastDelegateNode</span> <span class="o">*</span><span class="n">node</span> <span class="k">in</span> <span class="n">delegateNodes</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">id</span> <span class="n">nodeDelegate</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">delegate</span><span class="p">;</span>
</span><span class='line'>        <span class="cp">#if __has_feature(objc_arc_weak) &amp;&amp; !TARGET_OS_IPHONE</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">nodeDelegate</span> <span class="o">==</span> <span class="p">[</span><span class="bp">NSNull</span> <span class="n">null</span><span class="p">])</span>
</span><span class='line'>            <span class="n">nodeDelegate</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">unsafeDelegate</span><span class="p">;</span>
</span><span class='line'>        <span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">([</span><span class="n">nodeDelegate</span> <span class="nl">respondsToSelector</span><span class="p">:</span><span class="n">selector</span><span class="p">])</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="c1">// All delegates MUST be invoked ASYNCHRONOUSLY.</span>
</span><span class='line'>
</span><span class='line'>            <span class="bp">NSInvocation</span> <span class="o">*</span><span class="n">dupInvocation</span> <span class="o">=</span> <span class="p">[</span><span class="nb">self</span> <span class="nl">duplicateInvocation</span><span class="p">:</span><span class="n">origInvocation</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">dispatch_async</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">delegateQueue</span><span class="p">,</span> <span class="o">^</span><span class="p">{</span> <span class="k">@autoreleasepool</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>                <span class="p">[</span><span class="n">dupInvocation</span> <span class="nl">invokeWithTarget</span><span class="p">:</span><span class="n">nodeDelegate</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>            <span class="p">}});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">nodeDelegate</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">foundNilDelegate</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">foundNilDelegate</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="c1">// At lease one weak delegate reference disappeared.</span>
</span><span class='line'>        <span class="c1">// Remove nil delegate nodes from the list.</span>
</span><span class='line'>        <span class="c1">// </span>
</span><span class='line'>        <span class="c1">// This is expected to happen very infrequently.</span>
</span><span class='line'>        <span class="c1">// This is why we handle it separately (as it requires allocating an indexSet).</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">NSMutableIndexSet</span> <span class="o">*</span><span class="n">indexSet</span> <span class="o">=</span> <span class="p">[[</span><span class="bp">NSMutableIndexSet</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>        <span class="bp">NSUInteger</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>        <span class="k">for</span> <span class="p">(</span><span class="n">GCDMulticastDelegateNode</span> <span class="o">*</span><span class="n">node</span> <span class="k">in</span> <span class="n">delegateNodes</span><span class="p">)</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="kt">id</span> <span class="n">nodeDelegate</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">delegate</span><span class="p">;</span>
</span><span class='line'>            <span class="cp">#if __has_feature(objc_arc_weak) &amp;&amp; !TARGET_OS_IPHONE</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">nodeDelegate</span> <span class="o">==</span> <span class="p">[</span><span class="bp">NSNull</span> <span class="n">null</span><span class="p">])</span>
</span><span class='line'>                <span class="n">nodeDelegate</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">unsafeDelegate</span><span class="p">;</span>
</span><span class='line'>            <span class="cp">#endif</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="n">nodeDelegate</span> <span class="o">==</span> <span class="nb">nil</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>                <span class="p">[</span><span class="n">indexSet</span> <span class="nl">addIndex</span><span class="p">:</span><span class="n">i</span><span class="p">];</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="p">[</span><span class="n">delegateNodes</span> <span class="nl">removeObjectsAtIndexes</span><span class="p">:</span><span class="n">indexSet</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">doesNotRecognizeSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">aSelector</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Prevent NSInvalidArgumentException</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">doNothing</span> <span class="p">{}</span>
</span></code></pre></td></tr></table></div></figure>


<p>可以看到， <code>-methodSignatureForSelector:</code> 方法遍历了 <code>delegateNodes</code> ，并返回首个有效的方法签名。当没有找到有效的方法签名时，会返回 <code>-doNothing</code> 方法的签名，以规避未知方法导致的崩溃。在得到方法签名并构造 NSInvocation 对象后， <code>-forwardInvocation:</code> 同样遍历了 <code>delegateNodes</code> ，并在特定的任务队列中执行代理回调。如果发现已被销毁的代理，则删除它对应的 GCDMulticastDelegateNode 对象。</p>

<h2>Record Message Call</h2>

<p>NSUndoManager 是 Foundation 框架中，一个基于命令模式设计的撤消栈管理类。通过这个类可以很方便地实现撤消、重做功能，比如以下苹果官方 Demo ：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">setMyObjectWidth:</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nv">newWidth</span> <span class="nf">height:</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="nv">newHeight</span><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kt">float</span> <span class="n">currentWidth</span> <span class="o">=</span> <span class="p">[</span><span class="n">myObject</span> <span class="n">size</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>
</span><span class='line'>    <span class="kt">float</span> <span class="n">currentHeight</span> <span class="o">=</span> <span class="p">[</span><span class="n">myObject</span> <span class="n">size</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">((</span><span class="n">newWidth</span> <span class="o">!=</span> <span class="n">currentWidth</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">newHeight</span> <span class="o">!=</span> <span class="n">currentHeight</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="p">[[</span><span class="n">undoManager</span> <span class="nl">prepareWithInvocationTarget</span><span class="p">:</span><span class="nb">self</span><span class="p">]</span>
</span><span class='line'>                <span class="nl">setMyObjectWidth</span><span class="p">:</span><span class="n">currentWidth</span> <span class="nl">height</span><span class="p">:</span><span class="n">currentHeight</span><span class="p">];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">undoManager</span> <span class="nl">setActionName</span><span class="p">:</span><span class="n">NSLocalizedString</span><span class="p">(</span><span class="s">@&quot;Size Change&quot;</span><span class="p">,</span> <span class="s">@&quot;size undo&quot;</span><span class="p">)];</span>
</span><span class='line'>        <span class="p">[</span><span class="n">myObject</span> <span class="nl">setSize</span><span class="p">:</span><span class="n">NSMakeSize</span><span class="p">(</span><span class="n">newWidth</span><span class="p">,</span> <span class="n">newHeight</span><span class="p">)];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过调用代码块中 NSUndoManager 对象的 <code>undo</code> ， 可以“撤销”以上方法对 myObject 相关属性的设置。其中需要关注的是， NSUndoManager 是如何记录目标对象接收发生改变的信息：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[[</span><span class="n">undoManager</span> <span class="nl">prepareWithInvocationTarget</span><span class="p">:</span><span class="nb">self</span><span class="p">]</span> <span class="nl">setMyObjectWidth</span><span class="p">:</span><span class="n">currentWidth</span> <span class="nl">height</span><span class="p">:</span><span class="n">currentHeight</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>NSUndoManager 是如何通过这种方式存储调用 <code>-setMyObjectWidth:height:</code> 这一动作呢？背后的关键在于 <code>-prepareWithInvocationTarget:</code>
所返回的对象，也就是 NSUndoManagerProxy 。 NSUndoManagerProxy 是 NSProxy 的子类，而 NSProxy 除了重载消息转发机制外，基本上就没有其他用法了。结合苹果官方文档， NSUndoManagerProxy 重载了 <code>-forwardInvocation:</code> 来帮助 NSUndoManager 获取目标的方法调用信息。到目前为止，这个应用场景并不难理解，不过为了能切合 NSUndoManagerProxy 的实际实现，这里还是结合 Foundation 框架反汇编出的代码，简单地实现这个功能。</p>

<p>首先，创建 TBVUndoProxy ， 重写它的消息转发机制：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">TBVUndoProxy</span> : <span class="bp">NSProxy</span>
</span><span class='line'><span class="k">@property</span> <span class="p">(</span><span class="k">weak</span><span class="p">,</span> <span class="k">nonatomic</span><span class="p">)</span> <span class="n">TBVUndoManager</span> <span class="o">*</span><span class="n">manager</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">TBVUndoProxy</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">forwardInvocation:</span><span class="p">(</span><span class="bp">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">invocation</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">_manager</span> <span class="nl">_forwardTargetInvocation</span><span class="p">:</span><span class="n">invocation</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSMethodSignature</span> <span class="o">*</span><span class="p">)</span><span class="nf">methodSignatureForSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">sel</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">_manager</span> <span class="nl">_methodSignatureForTargetSelector</span><span class="p">:</span><span class="n">sel</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>结合 LLDB 中的调试信息， TBVUndoProxy 只是简单地把信息传送给了 TBVUndoManager 。再来看下将原生逻辑简化后的 TBVUndoManager 的实现：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">@interface</span> <span class="nc">TBVUndoManager</span> : <span class="bp">NSObject</span> <span class="p">{</span>
</span><span class='line'>    <span class="bp">NSMutableArray</span> <span class="o">*</span><span class="n">_invocations</span><span class="p">;</span>
</span><span class='line'>    <span class="n">TBVUndoProxy</span> <span class="o">*</span><span class="n">_proxy</span><span class="p">;</span>
</span><span class='line'>    <span class="k">__weak</span> <span class="kt">id</span> <span class="n">_target</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">prepareWithInvocationTarget:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">target</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">undo</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@interface</span> <span class="nc">TBVUndoManager</span> <span class="nl">(Private)</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">_forwardTargetInvocation:</span><span class="p">(</span><span class="bp">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">invocation</span><span class="p">;</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSMethodSignature</span> <span class="o">*</span><span class="p">)</span><span class="nf">_methodSignatureForTargetSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">sel</span><span class="p">;</span>
</span><span class='line'><span class="k">@end</span>
</span><span class='line'>
</span><span class='line'><span class="k">@implementation</span> <span class="nc">TBVUndoManager</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">instancetype</span><span class="p">)</span><span class="nf">init</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="nb">self</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="n">init</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nb">self</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">_invocations</span> <span class="o">=</span> <span class="p">[</span><span class="bp">NSMutableArray</span> <span class="n">array</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nf">prepareWithInvocationTarget:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">target</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">_target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
</span><span class='line'>    <span class="n">_proxy</span> <span class="o">=</span> <span class="p">[</span><span class="n">TBVUndoProxy</span> <span class="n">alloc</span><span class="p">];</span>
</span><span class='line'>    <span class="n">_proxy</span><span class="p">.</span><span class="n">manager</span> <span class="o">=</span> <span class="nb">self</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="n">_proxy</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">undo</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">_invocations</span><span class="p">.</span><span class="n">lastObject</span> <span class="n">invoke</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">_invocations</span> <span class="nl">removeObject</span><span class="p">:</span><span class="n">_invocations</span><span class="p">.</span><span class="n">lastObject</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="nf">_forwardTargetInvocation:</span><span class="p">(</span><span class="bp">NSInvocation</span> <span class="o">*</span><span class="p">)</span><span class="nv">invocation</span> <span class="p">{</span>
</span><span class='line'>    <span class="p">[</span><span class="n">invocation</span> <span class="nl">setTarget</span><span class="p">:</span><span class="n">_target</span><span class="p">];</span>
</span><span class='line'>    <span class="p">[</span><span class="n">_invocations</span> <span class="nl">addObject</span><span class="p">:</span><span class="n">invocation</span><span class="p">];</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="bp">NSMethodSignature</span> <span class="o">*</span><span class="p">)</span><span class="nf">_methodSignatureForTargetSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">sel</span> <span class="p">{</span>
</span><span class='line'>   <span class="bp">NSMethodSignature</span> <span class="o">*</span><span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="nb">super</span> <span class="nl">methodSignatureForSelector</span><span class="p">:</span><span class="n">sel</span><span class="p">];</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">signature</span> <span class="o">&amp;&amp;</span> <span class="n">_target</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">signature</span> <span class="o">=</span> <span class="p">[</span><span class="n">_target</span> <span class="nl">methodSignatureForSelector</span><span class="p">:</span><span class="n">sel</span><span class="p">];</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">signature</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">@end</span>
</span></code></pre></td></tr></table></div></figure>


<p>TBVUndoManager 通过 <code>-prepareWithInvocationTarget:</code> 方法将发送消息对象保存为 <code>_target</code> 成员变量，然后创建了代理类 TBVUndoProxy 并返回给方法调用者。当外部调用者用这个返回值作为消息发送对象时， TBVUndoProxy 并没有对应的方法实现，于是就触发了消息转发机制， TBVUndoManager 则利用保存的 <code>_target</code> 返回有效的方法签名，并且保存重组了  TBVUndoProxy 回传的 NSInvocation。最终，当外界调用 <code>undo</code> 时，执行的就是保有 <code>_target</code> 和 <code>-prepareWithInvocationTarget:</code>  信息的 NSInvocation 。（原生代码将 NSInvocation 包装成 <code>_NSUndoInvocation</code> 、 <code>_NSUndoObject</code> 压入 <code>_NSUndoStack</code> 栈中）</p>

<h2>Intercept Any Message Call</h2>

<p>Aspects 是一个提供面向切片编程的库，它可以让开发者以无侵入的方式添加额外的功能。它提供了两个简单易用的入口，用于 hook 特定类或者特定对象的方法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="c1">/// Adds a block of code before/instead/after the current `selector` for a specific class.</span>
</span><span class='line'><span class="p">+</span> <span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">AspectToken</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">aspect_hookSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">selector</span>
</span><span class='line'>                           <span class="nf">withOptions:</span><span class="p">(</span><span class="n">AspectOptions</span><span class="p">)</span><span class="nv">options</span>
</span><span class='line'>                            <span class="nf">usingBlock:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">block</span>
</span><span class='line'>                                 <span class="nf">error:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">**</span><span class="p">)</span><span class="nv">error</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">/// Adds a block of code before/instead/after the current `selector` for a specific instance.</span>
</span><span class='line'><span class="p">-</span> <span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">AspectToken</span><span class="o">&gt;</span><span class="p">)</span><span class="nf">aspect_hookSelector:</span><span class="p">(</span><span class="kt">SEL</span><span class="p">)</span><span class="nv">selector</span>
</span><span class='line'>                           <span class="nf">withOptions:</span><span class="p">(</span><span class="n">AspectOptions</span><span class="p">)</span><span class="nv">options</span>
</span><span class='line'>                            <span class="nf">usingBlock:</span><span class="p">(</span><span class="kt">id</span><span class="p">)</span><span class="nv">block</span>
</span><span class='line'>                                 <span class="nf">error:</span><span class="p">(</span><span class="bp">NSError</span> <span class="o">**</span><span class="p">)</span><span class="nv">error</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>开发者可以用以下方式 hook 所有 UIViewController 实例对象的 <code>-viewWillAppear:</code> 方法 :</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="p">[</span><span class="bp">UIViewController</span> <span class="nl">aspect_hookSelector</span><span class="p">:</span><span class="k">@selector</span><span class="p">(</span><span class="nl">viewWillAppear</span><span class="p">:)</span> <span class="nl">withOptions</span><span class="p">:</span><span class="n">AspectPositionAfter</span> <span class="nl">usingBlock</span><span class="p">:</span><span class="o">^</span><span class="p">(</span><span class="kt">id</span><span class="o">&lt;</span><span class="n">AspectInfo</span><span class="o">&gt;</span> <span class="n">aspectInfo</span><span class="p">,</span> <span class="kt">BOOL</span> <span class="n">animated</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSLog</span><span class="p">(</span><span class="s">@&quot;View Controller %@ will appear animated: %tu&quot;</span><span class="p">,</span> <span class="n">aspectInfo</span><span class="p">.</span><span class="n">instance</span><span class="p">,</span> <span class="n">animated</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span> <span class="nl">error</span><span class="p">:</span><span class="nb">NULL</span><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>因为不知道使用者会 hook 什么方法，所以就无法像传统的 swizzling method 一样，预先编写对应的 IMP 去替换传入的方法。这时就需要内部实现一个统一调用机制，这个机制需要满足以下两点：</p>

<p>1、 为了能进行切片操作，需要让所有被 hook 方法的调用都通过一个统一的入口完成。<br>
2、 为了给原始实现和切片操作提供参数/返回值信息，这个入口要能获取被 hook 方法完整的签名信息。<br></p>

<p>综合上述两点以及 Normal forwarding path 的执行过程，可以比较轻松地联想到 <code>-forwardInvocation:</code> 方法非常适合作为这个入口。结合 Aspects 源码，来看下其实现中，和消息转发相关的两个步骤：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">aspect_prepareClassAndHookSelector</span><span class="p">(</span><span class="bp">NSObject</span> <span class="o">*</span><span class="nb">self</span><span class="p">,</span> <span class="kt">SEL</span> <span class="n">selector</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">**</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">Class</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">aspect_hookClass</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
</span><span class='line'>    <span class="n">Method</span> <span class="n">targetMethod</span> <span class="o">=</span> <span class="n">class_getInstanceMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
</span><span class='line'>    <span class="kt">IMP</span> <span class="n">targetMethodIMP</span> <span class="o">=</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">targetMethod</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">aspect_isMsgForwardIMP</span><span class="p">(</span><span class="n">targetMethodIMP</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// Make a method alias for the existing method implementation, it not already copied.</span>
</span><span class='line'>        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">typeEncoding</span> <span class="o">=</span> <span class="n">method_getTypeEncoding</span><span class="p">(</span><span class="n">targetMethod</span><span class="p">);</span>
</span><span class='line'>        <span class="kt">SEL</span> <span class="n">aliasSelector</span> <span class="o">=</span> <span class="n">aspect_aliasForSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">[</span><span class="n">klass</span> <span class="nl">instancesRespondToSelector</span><span class="p">:</span><span class="n">aliasSelector</span><span class="p">])</span> <span class="p">{</span>
</span><span class='line'>            <span class="n">__unused</span> <span class="kt">BOOL</span> <span class="n">addedAlias</span> <span class="o">=</span> <span class="n">class_addMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">aliasSelector</span><span class="p">,</span> <span class="n">method_getImplementation</span><span class="p">(</span><span class="n">targetMethod</span><span class="p">),</span> <span class="n">typeEncoding</span><span class="p">);</span>
</span><span class='line'>            <span class="n">NSCAssert</span><span class="p">(</span><span class="n">addedAlias</span><span class="p">,</span> <span class="s">@&quot;Original implementation for %@ is already copied to %@ on %@&quot;</span><span class="p">,</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">),</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">aliasSelector</span><span class="p">),</span> <span class="n">klass</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// We use forwardInvocation to hook in.</span>
</span><span class='line'>        <span class="n">class_replaceMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">selector</span><span class="p">,</span> <span class="n">aspect_getMsgForwardIMP</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">selector</span><span class="p">),</span> <span class="n">typeEncoding</span><span class="p">);</span>
</span><span class='line'>        <span class="n">AspectLog</span><span class="p">(</span><span class="s">@&quot;Aspects: Installed hook for -[%@ %@].&quot;</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">NSStringFromSelector</span><span class="p">(</span><span class="n">selector</span><span class="p">));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kt">Class</span> <span class="nf">aspect_hookClass</span><span class="p">(</span><span class="bp">NSObject</span> <span class="o">*</span><span class="nb">self</span><span class="p">,</span> <span class="bp">NSError</span> <span class="o">**</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="nb">self</span><span class="p">);</span>
</span><span class='line'>   <span class="p">...</span>
</span><span class='line'>        <span class="n">aspect_swizzleForwardInvocation</span><span class="p">(</span><span class="n">subclass</span><span class="p">);</span>
</span><span class='line'>   <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">aspect_swizzleForwardInvocation</span><span class="p">(</span><span class="kt">Class</span> <span class="n">klass</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">klass</span><span class="p">);</span>
</span><span class='line'>    <span class="c1">// If there is no method, replace will act like class_addMethod.</span>
</span><span class='line'>    <span class="kt">IMP</span> <span class="n">originalImplementation</span> <span class="o">=</span> <span class="n">class_replaceMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="k">@selector</span><span class="p">(</span><span class="nl">forwardInvocation</span><span class="p">:),</span> <span class="p">(</span><span class="kt">IMP</span><span class="p">)</span><span class="n">__ASPECTS_ARE_BEING_CALLED__</span><span class="p">,</span> <span class="s">&quot;v@:@&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">originalImplementation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">class_addMethod</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">NSSelectorFromString</span><span class="p">(</span><span class="n">AspectsForwardInvocationSelectorName</span><span class="p">),</span> <span class="n">originalImplementation</span><span class="p">,</span> <span class="s">&quot;v@:@&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">AspectLog</span><span class="p">(</span><span class="s">@&quot;Aspects: %@ is now aspect aware.&quot;</span><span class="p">,</span> <span class="n">NSStringFromClass</span><span class="p">(</span><span class="n">klass</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">static</span> <span class="kt">void</span> <span class="nf">__ASPECTS_ARE_BEING_CALLED__</span><span class="p">(</span><span class="n">__unsafe_unretained</span> <span class="bp">NSObject</span> <span class="o">*</span><span class="nb">self</span><span class="p">,</span> <span class="kt">SEL</span> <span class="n">selector</span><span class="p">,</span> <span class="bp">NSInvocation</span> <span class="o">*</span><span class="n">invocation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="nb">self</span><span class="p">);</span>
</span><span class='line'>    <span class="n">NSCParameterAssert</span><span class="p">(</span><span class="n">invocation</span><span class="p">);</span>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Before hooks.</span>
</span><span class='line'>    <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">classContainer</span><span class="p">.</span><span class="n">beforeAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
</span><span class='line'>    <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">objectContainer</span><span class="p">.</span><span class="n">beforeAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Instead hooks.</span>
</span><span class='line'>    <span class="kt">BOOL</span> <span class="n">respondsToAlias</span> <span class="o">=</span> <span class="nb">YES</span><span class="p">;</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">objectContainer</span><span class="p">.</span><span class="n">insteadAspects</span><span class="p">.</span><span class="n">count</span> <span class="o">||</span> <span class="n">classContainer</span><span class="p">.</span><span class="n">insteadAspects</span><span class="p">.</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">classContainer</span><span class="p">.</span><span class="n">insteadAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
</span><span class='line'>        <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">objectContainer</span><span class="p">.</span><span class="n">insteadAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span><span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="kt">Class</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">object_getClass</span><span class="p">(</span><span class="n">invocation</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
</span><span class='line'>        <span class="k">do</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">((</span><span class="n">respondsToAlias</span> <span class="o">=</span> <span class="p">[</span><span class="n">klass</span> <span class="nl">instancesRespondToSelector</span><span class="p">:</span><span class="n">aliasSelector</span><span class="p">]))</span> <span class="p">{</span>
</span><span class='line'>                <span class="p">[</span><span class="n">invocation</span> <span class="n">invoke</span><span class="p">];</span>
</span><span class='line'>                <span class="k">break</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span><span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">respondsToAlias</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">klass</span> <span class="o">=</span> <span class="n">class_getSuperclass</span><span class="p">(</span><span class="n">klass</span><span class="p">)));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// After hooks.</span>
</span><span class='line'>    <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">classContainer</span><span class="p">.</span><span class="n">afterAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
</span><span class='line'>    <span class="n">aspect_invoke</span><span class="p">(</span><span class="n">objectContainer</span><span class="p">.</span><span class="n">afterAspects</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里在忽略掉 Aspects 创建子类等操作后，可以看出以上代码总共做了两件事：</p>

<p>1、对原始 <code>-forwardInvocation:</code> 方法执行 swizzling method ，将实现替换成 <code>__ASPECTS_ARE_BEING_CALLED__</code> ，以便在 <code>__ASPECTS_ARE_BEING_CALLED__</code> 函数中执行了额外的切片操作。<br>
2、对被 hook 的方法执行 swizzling method ，将实现替换成 <code>_objc_msgForward</code> / <code>_objc_msgForward_stret</code> ，以便触发被 hook 方法的消息转发机制，然后在步骤 1 的 <code>__ASPECTS_ARE_BEING_CALLED__</code> 函数中，进行切片操作。<br></p>

<p>值得一提的是， JSPatch 也是利用相似的机制，实现用 <code>defineClass</code> 接口任意替换一个类的方法的功能，不同的是 JSPatch 在它的 <code>__ASPECTS_ARE_BEING_CALLED__</code> 函数中，直接把参数传给了 JavaScript 的实现。</p>

<!-- ## Dependency Injection -->




<!-- ## 依靠协议的依赖注入 -->


<h2>小结</h2>

<p>消息转发有三步，分别是 Lazy method resolution （动态添加方法）、 Fast forwarding path （转发至可响应对象）、 Normal forwarding path （获取 NSInvocation 信息）。关于消息转发的应用，本文主要摘录了以下几个例子：</p>

<ul>
<li>Week Proxy</li>
<li>Delegate Proxy</li>
<li>Multicast Delegate</li>
<li>Record Message Call</li>
<li>Intercept Any Message Call</li>
</ul>


<p>可以看出，在这些例子中，都创建了一个代理类，并且这个代理类几乎没有实现自定义方法，或者直接是 NSProxy 的子类。这样，基本上所有的发送给代理类对象的消息，都会触发消息转发机制，而这个代理类就可以对拦截的消息做额外处理。</p>

<p>其中大部分应用场景都涉及到消息转发的第二三步，即 Fast forwarding path、Normal forwarding path 。特别是 Normal forwarding path ，配合 <code>_objc_msgForward</code> / <code>_objc_msgForward_stret</code> 函数强行进行消息转发，可以获取携带完整调用信息的 NSInvocation 。借助于 NSInvocation 的灵活性，开发者就可以完成一些非常有意思的事情了。</p>

<h2>参考</h2>

<p><a href="https://github.com/robbiehanson/XMPPFramework/wiki/MulticastDelegate">MulticastDelegate</a><br>
<a href="http://petersteinberger.com/blog/2013/smart-proxy-delegation/">Smart Proxy Delegation</a><br>
<a href="https://mikeash.com/pyblog/friday-qa-2009-03-27-objective-c-message-forwarding.html">Objective-C Message Forwarding</a><br>
<a href="http://blog.ibireme.com/2013/11/26/objective-c-messaging/">Objective-C 中的消息与消息转发</a> <br>
<a href="http://yulingtianxia.com/blog/2016/06/15/Objective-C-Message-Sending-and-Forwarding/">Objective-C 消息发送与转发机制原理</a><br>
<a href="https://codeshaker.blogspot.jp/2012/01/aop-delivered.html">AOP. Delivered</a> <br>
<a href="https://wereadteam.github.io/2016/06/30/Aspects/">面向切面编程之 Aspects 源码解析及应用</a><br>
<a href="https://github.com/bang590/JSPatch/wiki/JSPatch-%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86%E8%AF%A6%E8%A7%A3">JSPatch 实现原理详解</a><br></p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">tripleCC</span></span>

      




<time class='entry-date' datetime='2017-07-09T14:20:30+08:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>9</span><span class='date-suffix'>th</span>, <span class='date-year'>2017</span></span> <span class='time'>2:20 pm</span></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017-06-23-ru-he-kuai-su-da-jian-biao-dan-jie-mian/" title="Previous Post: 闲谈 IGListKit">&laquo; 闲谈 IGListKit</a>
      
      
        <a class="basic-alignment right" href="/blog/2017-07-28-blockhe-nsmethodsignature/" title="Next Post: 用 Block 实现委托方法">用 Block 实现委托方法 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>关于我</h1>
  <p> 曾经的嵌入式软件开发者，现已皈依苹果大法门下。目前混迹杭州，喜欢没事就去西湖压马路。轻微完美主义者，跑步爱好者。 </p>
  <a href="http://www.jianshu.com/users/97e39e95c2cc"> 我的简书 </a><br>
  <a href="https://github.com/tripleCC"> 我的GitHub </a><br>
  <a href="https://twitter.com/tripleCCBrian"> 我的Twitter </a>
</section>
<section>
  <h1>最近发布</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2017-10-25-zu-jian-sheng-ming-zhou-qi/">组件化之组件生命周期管理</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-08-12-cbiao-da-shi-zhong-floatjing-du-ti-sheng-wen-ti/">C 表达式中 Float 精度提升问题</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-07-28-blockhe-nsmethodsignature/">用 Block 实现委托方法</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-07-09-objective-cxiao-xi-zhuan-fa-ying-yong-zhi-ji-chu/">Objective-C 消息转发应用场景摘录</a>
      </li>
    
      <li class="post">
        <a href="/blog/2017-06-23-ru-he-kuai-su-da-jian-biao-dan-jie-mian/">闲谈 IGListKit</a>
      </li>
    
  </ul>
</section>




<section>
    <h1>友情链接</h1>
    <ul>
        <li>
            <a href="http://wxgbridgeq.github.io/">小乔的个人学习博客</a>
        </li>
        <li>
        	<a href="http://www.swiftyper.com/">Swiftyper-小锅</a>
        </li>
    </ul>
</section>
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - tripleCC -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'tripleCC';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://triplecc.github.io/blog/2017-07-09-objective-cxiao-xi-zhuan-fa-ying-yong-zhi-ji-chu/';
        var disqus_url = 'http://triplecc.github.io/blog/2017-07-09-objective-cxiao-xi-zhuan-fa-ying-yong-zhi-ji-chu/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
